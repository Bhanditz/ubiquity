bespin.tiki.register("::text_editor",{name:"text_editor",dependencies:{undomanager:"0.0.0",settings:"0.0.0",canon:"0.0.0",rangeutils:"0.0.0",traits:"0.0.0",theme_manager:"0.0.0",keyboard:"0.0.0",edit_session:"0.0.0",syntax_manager:"0.0.0"}});
bespin.tiki.module("text_editor:commands/editing",function(t,m){var n=t("settings").settings,k=t("rangeutils:utils/range");m.backspace=function(d){d.view.performBackspaceOrDelete(true)};m.deleteCommand=function(d){d.view.performBackspaceOrDelete(false)};m.deleteLines=function(d){if(!d.model.readOnly)if(d.model.lines.length!=1){var b=d.view;b.groupChanges(function(){var a=b.getSelectedRange(),g=d.model.lines,f=g.length-1,h;h=a.start.row==f?{col:g[f-1].length,row:f-1}:{col:0,row:a.start.row};b.replaceCharacters({start:h,
end:a.end.row==f?{col:g[f].length,row:f}:{col:0,row:a.end.row+1}},"");b.moveCursorTo(h)})}};var e=function(d,b){var a=b.getSelectedRange().start;d=/^\s*/.exec(d.lines[a.row].substring(0,a.col));b.insertText("\n"+d)};m.insertText=function(d,b){d.view.insertText(b.text)};m.newline=function(d){e(d.model,d.view)};m.joinLines=function(d){var b=d.model;if(!b.readOnly){var a=d.view;d=a.getSelectedRange();var g=b.lines,f=d.end.row;g.length!=f&&a.groupChanges(function(){a.replaceCharacters({start:{col:g[f].length,
row:f},end:{col:/^\s*/.exec(g[f+1])[0].length,row:f+1}},"")})}};m.openLine=function(d){if(!d.model.readOnly){var b=d.model;d=d.view;var a=d.getSelectedRange().end.row;d.moveCursorTo({row:a,col:b.lines[a].length});e(b,d)}};m.tab=function(d){var b=d.view;b.groupChanges(function(){var a=n.get("tabstop"),g=b.getSelectedRange(),f="";if(k.isZeroLength(g)){var h=d.model.lines[g.start.row].substring(g.start.col).match(/^\s*/)[0].length;a=a-(g.start.col+h)%a;for(var l=0;l<a;l++)f+=" ";b.replaceCharacters({start:g.start,
end:g.start},f);b.moveCursorTo({col:g.start.col+a+h,row:g.end.row})}else{for(l=0;l<a;l++)f+=" ";for(l=g.start.row-1;l++<g.end.row;){h=l==g.start.row?g.start.col:0;b.replaceCharacters({start:{row:l,col:h},end:{row:l,col:h}},f)}b.setSelection({start:g.start,end:{col:g.end.col+a,row:g.end.row}})}}.bind(this))};m.untab=function(d){var b=d.view;b.groupChanges(function(){var a=n.get("tabstop"),g=b.getSelectedRange(),f=d.model.lines,h=0;if(k.isZeroLength(g)){h=Math.min(f[g.start.row].substring(0,g.start.col).match(/\s*$/)[0].length,
(g.start.col-a)%a||a);b.replaceCharacters({start:{col:g.start.col-h,row:g.start.row},end:g.start},"");b.moveCursorTo({row:g.start.row,col:g.end.col-h})}else{for(var l,i=g.start.row-1;i++<g.end.row;){l=i==g.start.row?g.start.col:0;h=Math.min(f[i].substring(l).match(/^\s*/)[0].length,a);b.replaceCharacters({start:{row:i,col:l},end:{row:i,col:l+h}},"")}b.setSelection({start:{row:g.start.row,col:g.start.col},end:{row:g.end.row,col:g.end.col-h}})}}.bind(this))}});
bespin.tiki.module("text_editor:commands/editor",function(t,m){t("bespin:plugins");var n=t("settings").settings;m.findCommand=function(e,d,b){if("value"in d){e=e.view;var a=e.editor.searchController,g=e.getSelectedRange(),f="";a.setSearchText(d.value,false);if(a=a.findNext(g.end,true)){e.setSelection(a,true);e.focus()}else f+="<i>No matches found</i><br>";f+='Searching for "'+d.value+'"';b.done(f)}else e.commandLine.setInput("find ")};m.findNextCommand=function(e){e=e.view;var d=e.editor.searchController,
b=e.getSelectedRange();if(d=d.findNext(b.end,true)){e.setSelection(d,true);e.focus()}};m.findPrevCommand=function(e){e=e.view;var d=e.editor.searchController,b=e.getSelectedRange();if(d=d.findPrevious(b.start,true)){e.setSelection(d,true);e.focus()}};m.gotoCommand=function(e,d){if("line"in d){e=e.view;e.moveCursorTo({row:d.line-1,col:0});e.focus()}else e.commandLine.setInput("goto ")};var k=function(e,d){var b=e.view,a=b.getSelectedCharacters();d=d(a);b=b.getSelectedRange();e.model.replaceCharacters(b,
d)};m.replaceCommand=function(e,d){k(e,function(b){return b.replace(d.search+"/g",d.replace)})};m.entabCommand=function(e){tabstop=n.get("tabstop");k(e,function(d){return d.replace(" {"+tabstop+"}","\t")})};m.detabCommand=function(e){tabstop=n.get("tabstop");k(e,function(d){return d.replace("\t",(new Array(tabstop+1)).join(" "))})};m.trimCommand=function(e,d){k(e,function(b){b=b.split("\n");b=b.map(function(a){if(d.side==="left"||d.side==="both")a=a.replace(/^\s+/,"");if(d.side==="right"||d.side===
"both")a=a.replace(/\s+$/,"");return a});return b.join("\n")})};m.ucCommand=function(e){k(e,function(d){return d.toUpperCase()})};m.lcCommand=function(e){k(e,function(d){return d.toLowerCase()})}});
bespin.tiki.module("text_editor:commands/movement",function(t,m){t("rangeutils:utils/range");m.moveDown=function(a){a.view.moveDown()};m.moveLeft=function(a){a.view.moveLeft()};m.moveRight=function(a){a.view.moveRight()};m.moveUp=function(a){a.view.moveUp()};m.selectDown=function(a){a.view.selectDown()};m.selectLeft=function(a){a.view.selectLeft()};m.selectRight=function(a){a.view.selectRight()};m.selectUp=function(a){a.view.selectUp()};var n=function(a,g,f){var h=a.view;a=a.model.lines;var l=h.getSelectedRange(true);
f=f?l.end.row:a.length-1;h.moveCursorTo({row:f,col:a[f].length},g)};m.moveLineEnd=function(a){n(a,false,true)};m.selectLineEnd=function(a){n(a,true,true)};m.moveDocEnd=function(a){n(a,false,false)};m.selectDocEnd=function(a){n(a,true,false)};var k=function(a,g,f){a=a.view;var h=a.getSelectedRange(true);a.moveCursorTo({row:f?h.end.row:0,col:0},g)};m.moveLineStart=function(a){k(a,false,true)};m.selectLineStart=function(a){k(a,true,true)};m.moveDocStart=function(a){k(a,false,false)};m.selectDocStart=
function(a){k(a,true,false)};var e=function(a,g,f,h,l){var i=0,j=false;if(h<0){f--;if(l)i=1}for(;f<g.length&&f>-1;){if(l=a.isDelimiter(g[f]))i++;else j=true;if((l||i>1)&&j)break;f+=h}h<0&&f++;return f},d=function(a,g){var f=a.view;a=a.model.lines;var h=f.getSelectedRange(true).end,l=h.row;h=h.col;var i=a[l],j=false;if(h>=i.length){l++;j=true;if(l<a.length){h=0;i=a[l]}else i=""}h=e(f,i,h,1,j);f.moveCursorTo({row:l,col:h},g)},b=function(a,g){var f=a.view;a=a.model.lines;var h=f.getSelectedRange(true).end,
l=h.row;h=h.col;var i=a[l],j=false;if(h>i.length)h=i.length;else if(h==0){l--;j=true;if(l>-1){i=a[l];h=i.length}else i=""}h=e(f,i,h,-1,j);f.moveCursorTo({row:l,col:h},g)};m.moveNextWord=function(a){d(a,false)};m.selectNextWord=function(a){d(a,true)};m.movePreviousWord=function(a){b(a,false)};m.selectPreviousWord=function(a){b(a,true)};m.selectAll=function(a){a.view.selectAll()}});
bespin.tiki.module("text_editor:commands/scrolling",function(t,m){m.scrollDocStart=function(n){n.view.scrollToPosition({col:0,row:0})};m.scrollDocEnd=function(n){n.view.scrollToPosition(n.model.range.end)};m.scrollPageDown=function(n){n.view.scrollPageDown()};m.scrollPageUp=function(n){n.view.scrollPageUp()}});
bespin.tiki.module("text_editor:controllers/layoutmanager",function(t,m){var n=t("bespin:util/util"),k=t("events").Event;t("rangeutils:utils/range");var e=t("syntax_manager").SyntaxManager,d=t("models/textstorage").TextStorage,b=t("bespin:plugins").catalog,a=t("settings").settings,g=t("bespin:util/scratchcanvas"),f={};t=function(){var h=a.get("fontsize"),l=a.get("fontface");l=h+"px "+l;for(var i=g.get(),j="",s=0;s<100;s++)j+="M";l=i.measureStringWidth(l,j)/100;f.characterWidth=l;f.lineHeight=Math.floor(h*
1.6);f.lineAscent=Math.floor(h*1.3)};t();b.registerExtension("settingChange",{match:"font[size|face]",pointer:t});m.LayoutManager=function(h){this.changedTextAtRow=new k;this.invalidatedRects=new k;this.fontDimension=f;if(h.textStorage){h._textStorage=h.textStorage;delete h.textStorage}else this._textStorage=new d;n.mixin(this,h);this._textStorage.changed.add(this.textStorageChanged.bind(this));this.textLines=[{characters:"",colors:[{start:0,end:0,color:"plain"}]}];this.syntaxManager=h=new e(this);
h.syntaxChanged.add(this._syntaxChanged.bind(this));this._size={width:0,height:0};this.sizeChanged=new k;this._height=0;this._recomputeEntireLayout()};m.LayoutManager.prototype={_maximumWidth:0,_textStorage:null,_size:null,sizeChanged:null,_theme:{},margin:{left:5,bottom:6,top:0,right:12},pluginCatalog:b,syntaxManager:null,textLines:null,_computeInvalidRects:function(h,l){var i=this.characterRectForPosition(h.start),j={x:i.x,y:i.y,width:Number.MAX_VALUE,height:i.height};return h.end.row===l.end.row?
[j]:[j,{x:0,y:i.y+f.lineHeight,width:Number.MAX_VALUE,height:Number.MAX_VALUE}]},_lastCharacterPosition:function(){return{row:this.textLines.length-1,col:this._maximumWidth}},_recalculateMaximumWidth:function(){var h=0;this.textLines.forEach(function(l){l=l.characters.length;if(h<l)h=l});this._maximumWidth=h;this.size={width:h,height:this.textLines.length}},_recomputeEntireLayout:function(){var h=this._textStorage.range;this._recomputeLayoutForRanges(h,h)},_recomputeLayoutForRanges:function(h,l){for(var i=
h.start.row,j=h.end.row,s=l.end.row,q=s-i+1,o=this._textStorage.lines,r=this._theme.plain,v=[],p=0;p<q;p++)v[p]={characters:o[i+p],colors:[{start:0,end:null,color:r}]};this.textLines=n.replace(this.textLines,i,j-i+1,v);this._recalculateMaximumWidth();j=this.textLines.length;q=this.syntaxManager;if(this._height!==j)this._height=j;q.invalidateRow(i);this.updateTextRows(i,s+1);this.changedTextAtRow(this,i);this.invalidatedRects(this,this._computeInvalidRects(h,l))},_syntaxChanged:function(h,l){this.updateTextRows(h,
l);this.invalidatedRects(this,this.rectsForRange({start:{row:h,col:0},end:{row:l,col:0}}))},boundingRect:function(){return this.rectsForRange({start:{row:0,col:0},end:{row:this.textLines.length-1,col:this._maximumWidth}})[0]},characterAtPoint:function(h){var l=this.margin,i=h.x-l.left,j=f.characterWidth,s=this._textStorage;h=s.clampPosition({row:Math.floor((h.y-l.top)/f.lineHeight),col:Math.floor(i/j)});s=s.lines[h.row].length;h.partialFraction=i<0||h.col===s?0:i%j/j;return h},characterRangeForBoundingRect:function(h){var l=
f.lineHeight,i=f.characterWidth,j=this.margin,s=h.x-j.left;j=h.y-j.top;return{start:{row:Math.max(Math.floor(j/l),0),col:Math.max(Math.floor(s/i),0)},end:{row:Math.floor((j+h.height-1)/l),col:Math.floor((s+h.width-1)/i)+1}}},characterRectForPosition:function(h){return this.rectsForRange({start:h,end:{row:h.row,col:h.col+1}})[0]},lineRectForRow:function(h){return this.rectsForRange({start:{row:h,col:0},end:{row:h,col:this._maximumWidth}})[0]},rectForPosition:function(h){var l=this.margin,i=f.characterWidth,
j=f.lineHeight;return{x:l.left+i*h.col,y:l.top+j*h.row,width:i,height:j}},rectsForRange:function(h){var l=f.characterWidth,i=f.lineHeight,j=this._maximumWidth,s=this.margin,q=h.start,o=h.end;h=q.row;var r=q.col;q=o.row;o=o.col;if(h===q)return[{x:s.left+l*r,y:s.top+i*h,width:l*(o-r),height:i}];var v=[],p;if(r===0)p=h;else{p=h+1;v.push({x:s.left+l*r,y:s.top+i*h,width:99999,height:i})}if(o===0)j=q-1;else if(o===j)j=q;else{j=q-1;v.push({x:s.left,y:s.top+i*q,width:l*o,height:i})}v.push({x:s.left,y:s.top+
i*p,width:99999,height:i*(j-p+1)});return v},textStorageChanged:function(h,l){this._recomputeLayoutForRanges(h,l)},updateTextRows:function(h,l){var i=this.textLines;l=this.syntaxManager.getAttrsForRows(h,l);for(var j=0;j<l.length;j++)i[h+j].colors=l[j]}};Object.defineProperties(m.LayoutManager.prototype,{size:{set:function(h){if(h.width!==this._size.width||h.height!==this._size.height){this.sizeChanged(h);this._size=h}},get:function(){return this._size}},textStorage:{get:function(){return this._textStorage}}})});
bespin.tiki.module("text_editor:controllers/search",function(t,m){var n=t("bespin:util/util");t("rangeutils:utils/range");t("bespin:console");m.EditorSearchController=function(k){this.editor=k};m.EditorSearchController.prototype={editor:null,_escapeString:/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g,_findMatchesInString:function(k){var e=[],d=this.searchRegExp,b;for(d.lastIndex=0;;){b=d.exec(k);if(b===null)break;e.push(b);d.lastIndex=b.index+b[0].length}return e},_makeRange:function(k,e){return{start:{row:e,
col:k.index},end:{row:e,col:k.index+k[0].length}}},isRegExp:null,searchRegExp:null,searchText:null,setSearchText:function(k,e){this.searchRegExp=e?new RegExp(k):new RegExp(k.replace(this._escapeString,"\\$1"),"gi");this.isRegExp=e;this.searchText=k},findNext:function(k,e){var d=this.searchRegExp;if(n.none(d))return null;k=k||this.editor.textView.getSelectedRange().end;var b=this.editor.layoutManager.textStorage.lines,a;d.lastIndex=k.col;var g;for(g=k.row;g<b.length;g++){a=d.exec(b[g]);if(!n.none(a))return this._makeRange(a,
g)}if(!e)return null;for(g=0;g<=k.row;g++){a=d.exec(b[g]);if(!n.none(a))return this._makeRange(a,g)}return null},findPrevious:function(k,e){if(n.none(this.searchRegExp))return null;k=k||this.editor.textView.getSelectedRange().start;var d=this.editor.buffer.layoutManager.textStorage.lines,b;b=this._findMatchesInString(d[k.row].substring(0,k.col));if(b.length!==0)return this._makeRange(b[b.length-1],k.row);var a;for(a=k.row-1;a!==-1;a--){b=this._findMatchesInString(d[a]);if(b.length!==0)return this._makeRange(b[b.length-
1],a)}if(!e)return null;for(a=d.length-1;a>=k.row;a--){b=this._findMatchesInString(d[a]);if(b.length!==0)return this._makeRange(b[b.length-1],a)}return null}}});
bespin.tiki.module("text_editor:controllers/undo",function(t,m){var n=t("bespin:console").console;m.EditorUndoController=function(k){this.editor=k;k=this.textView=k.textView;k.beganChangeGroup.add(function(e,d){this._beginTransaction();this._record.selectionBefore=d}.bind(this));k.endedChangeGroup.add(function(e,d){this._record.selectionAfter=d;this._endTransaction()}.bind(this));k.replacedCharacters.add(function(e,d,b){if(!this._inTransaction)throw new Error("UndoController.textViewReplacedCharacters() called outside a transaction");
this._record.patches.push({oldCharacters:this._deletedCharacters,oldRange:d,newCharacters:b,newRange:this.editor.layoutManager.textStorage.resultingRangeForReplacement(d,b.split("\n"))});this._deletedCharacters=null}.bind(this));k.willReplaceRange.add(function(e,d){if(!this._inTransaction)throw new Error("UndoController.textViewWillReplaceRange() called outside a transaction");this._deletedCharacters=this.editor.layoutManager.textStorage.getCharacters(d)}.bind(this))};m.EditorUndoController.prototype=
{_inTransaction:false,_record:null,textView:null,_beginTransaction:function(){if(this._inTransaction){n.trace();throw new Error("UndoController._beginTransaction() called with a transaction already in place");}this._inTransaction=true;this._record={patches:[]}},_endTransaction:function(){if(!this._inTransaction)throw new Error("UndoController._endTransaction() called without a transaction in place");this.editor.buffer.undoManager.registerUndo(this,this._record);this._record=null;this._inTransaction=
false},_tryApplyingPatches:function(k){var e=this.editor.layoutManager.textStorage;k.forEach(function(d){e.replaceCharacters(d.oldRange,d.newCharacters)});return true},_undoOrRedo:function(k,e){if(this._inTransaction)throw new Error("UndoController._undoOrRedo() called while in a transaction");if(!this._tryApplyingPatches(k))return false;this.textView.setSelection(e,true);return true},redo:function(k){var e=k.patches.concat();e.reverse();return this._undoOrRedo(e,k.selectionAfter)},undo:function(k){return this._undoOrRedo(k.patches.map(function(e){return{oldCharacters:e.newCharacters,
oldRange:e.newRange,newCharacters:e.oldCharacters,newRange:e.oldRange}}),k.selectionBefore)}};m.undoManagerCommand=function(k,e,d){k.editor.buffer.undoManager[d.commandExt.name]()}});
bespin.tiki.module("text_editor:models/buffer",function(t,m){var n=t("canon:environment").global,k=t("bespin:util/util"),e=t("bespin:promise").Promise,d=t("models/textstorage").TextStorage,b=t("controllers/layoutmanager").LayoutManager,a=t("undomanager").UndoManager;m.Buffer=function(g,f){this._file=g;this._model=new d(f);this._layoutManager=new b({textStorage:this._model});this.undoManager=new a;if(g)this.reload().then(function(){this._updateSyntaxManagerInitialContext()}.bind(this));else{this.loadPromise=
new e;this.loadPromise.resolve()}f=n.session?n.session.history:null;var h,l,i;if(f&&g&&(h=f.getHistoryForPath(g.path))){l=h.selection;i=h.scroll}this._selectedRange=l||{start:{row:0,col:0},end:{row:0,col:0}};this._scrollOffset=i||{x:0,y:0}};m.Buffer.prototype={undoManager:null,loadPromise:null,_scrollOffset:null,_selectedRange:null,_selectedRangeEndVirtual:null,_layoutManager:null,_file:null,_model:null,save:function(){return this._file.saveContents(this._model.value)},saveAs:function(g){var f=new e;
g.saveContents(this._model.value).then(function(){this._file=g;this._updateSyntaxManagerInitialContext();f.resolve()}.bind(this),function(h){f.reject(h)});return f},reload:function(){var g=this,f;return this.loadPromise=f=this._file.loadContents().then(function(h){g._model.value=h})},_updateSyntaxManagerInitialContext:function(){var g=this._file.extension();this._layoutManager.syntaxManager.setSyntaxFromFileExt(g===null?"":g)},untitled:function(){return k.none(this._file)}};Object.defineProperties(m.Buffer.prototype,
{layoutManager:{get:function(){return this._layoutManager}},syntaxManager:{get:function(){}},file:{get:function(){return this._file}},model:{get:function(){return this._model}}})});
bespin.tiki.module("text_editor:models/textstorage",function(t,m){var n=t("events").Event,k=t("bespin:util/util");t=function(e){this._lines=e!==null&&e!==undefined?e.split("\n"):[""];this.changed=new n;return this};t.prototype={_lines:null,readOnly:false,clampPosition:function(e){var d=this._lines,b=e.row;if(b<0)return{row:0,col:0};else if(b>=d.length)return this.range.end;e=Math.max(0,Math.min(e.col,d[b].length));return{row:b,col:e}},clampRange:function(e){var d=this.clampPosition(e.start);e=this.clampPosition(e.end);
return{start:d,end:e}},deleteCharacters:function(e){this.replaceCharacters(e,"")},displacePosition:function(e,d){var b=d>0,a=this._lines,g=a.length;for(d=Math.abs(d);d!==0;d--)if(b){var f=a[e.row].length;if(e.row===g-1&&e.col===f)return e;e=e.col===f?{row:e.row+1,col:0}:{row:e.row,col:e.col+1}}else{if(e.row===0&&e.col==0)return e;if(e.col===0){a=this._lines;e={row:e.row-1,col:a[e.row-1].length}}else e={row:e.row,col:e.col-1}}return e},getCharacters:function(e){var d=this._lines,b=e.start,a=e.end,
g=b.row;e=a.row;var f=b.col;b=a.col;if(g===e)return d[g].substring(f,b);a=d[g].substring(f);g=d.slice(g+1,e);d=d[e].substring(0,b);return[a].concat(g,d).join("\n")},getLines:function(){return this._lines},getRange:function(){var e=this._lines,d=e.length-1;return{start:{row:0,col:0},end:{row:d,col:e[d].length}}},getValue:function(){return this._lines.join("\n")},insertCharacters:function(e,d){this.replaceCharacters({start:e,end:e},d)},replaceCharacters:function(e,d){if(this.readOnly)throw new Error("Attempt to modify a read-only text storage object");
var b=d.split("\n"),a=b.length,g=this.resultingRangeForReplacement(e,b),f=e.start,h=e.end,l=f.row,i=h.row,j=this._lines;b[0]=j[l].substring(0,f.col)+b[0];b[a-1]+=j[i].substring(h.col);this._lines=k.replace(j,l,i-l+1,b);this.changed(e,g,d)},resultingRangeForReplacement:function(e,d){var b=d.length;e=e.start;return{start:e,end:{row:e.row+b-1,col:(b===1?e.col:0)+d[b-1].length}}},setLines:function(e){this.setValue(e.join("\n"))},setValue:function(e){this.replaceCharacters(this.range,e)}};m.TextStorage=
t;Object.defineProperties(m.TextStorage.prototype,{lines:{get:function(){return this.getLines()},set:function(e){return this.setLines(e)}},range:{get:function(){return this.getRange()}},value:{get:function(){return this.getValue()},set:function(e){this.setValue(e)}}})});
bespin.tiki.module("text_editor:utils/rect",function(t,m){m._distanceFromBounds=function(n,k,e){if(n<k)return n-k;if(n>=e)return n-e;return 0};m.merge=function(n){var k;do{k=false;for(var e=[],d=0;d<n.length;d++){var b=n[d];e.push(b);for(var a=d+1;a<n.length;a++){var g=n[a];if(m.rectsSideBySide(b,g)||m.rectsIntersect(b,g)){n.splice(a,1);e[e.length-1]=m.unionRects(b,g);k=true;break}}}n=e}while(k);return n};m.offsetFromRect=function(n,k){return{x:m._distanceFromBounds(k.x,n.x,m.maxX(n)),y:m._distanceFromBounds(k.y,
n.y,m.maxY(n))}};m.rectsIntersect=function(n,k){n=m.intersectRects(n,k);return n.width!==0&&n.height!==0};m.rectsSideBySide=function(n,k){if(n.x==k.x&&n.width==k.width)return n.y<k.y?n.y+n.height==k.y:k.y+k.height==n.y;else if(n.y==k.y&&n.height==k.height)return n.x<k.x?n.x+n.width==k.x:k.x+k.width==n.x;return false};m.intersectRects=function(n,k){n={x:Math.max(m.minX(n),m.minX(k)),y:Math.max(m.minY(n),m.minY(k)),width:Math.min(m.maxX(n),m.maxX(k)),height:Math.min(m.maxY(n),m.maxY(k))};n.width=Math.max(0,
n.width-n.x);n.height=Math.max(0,n.height-n.y);return n};m.minX=function(n){return n.x||0};m.maxX=function(n){return(n.x||0)+(n.width||0)};m.minY=function(n){return n.y||0};m.maxY=function(n){return(n.y||0)+(n.height||0)};m.pointInRect=function(n,k){return n.x>=m.minX(k)&&n.y>=m.minY(k)&&n.x<=m.maxX(k)&&n.y<=m.maxY(k)};m.unionRects=function(n,k){n={x:Math.min(m.minX(n),m.minX(k)),y:Math.min(m.minY(n),m.minY(k)),width:Math.max(m.maxX(n),m.maxX(k)),height:Math.max(m.maxY(n),m.maxY(k))};n.width=Math.max(0,
n.width-n.x);n.height=Math.max(0,n.height-n.y);return n};m.rectsEqual=function(n,k,e){if(!n||!k)return n==k;if(!e&&e!==0)e=0.1;if(n.y!=k.y&&Math.abs(n.y-k.y)>e)return false;if(n.x!=k.x&&Math.abs(n.x-k.x)>e)return false;if(n.width!=k.width&&Math.abs(n.width-k.width)>e)return false;if(n.height!=k.height&&Math.abs(n.height-k.height)>e)return false;return true}});
bespin.tiki.module("text_editor:views/canvas",function(t,m){var n=t("bespin:util/util"),k=t("utils/rect"),e=t("events").Event;m.CanvasView=function(d,b,a){if(d){this._preventDownsize=b||false;this._clearOnFullInvalid=a||false;this._clippingFrame=this._frame={x:0,y:0,width:0,height:0};this._invalidRects=[];b=document.createElement("canvas");b.setAttribute("style","position: absolute");b.innerHTML="canvas tag not supported by your browser";d.appendChild(b);this.domNode=b;this.clippingChanged=new e;
this.clippingChanged.add(this.clippingFrameChanged.bind(this))}};m.CanvasView.prototype={domNode:null,clippingChanged:null,_canvasContext:null,_canvasId:null,_invalidRects:null,_lastRedrawTime:null,_redrawTimer:null,_clippingFrame:null,_preventDownsize:false,_clearOnFullInvalid:false,_frame:null,_getContext:function(){if(this._canvasContext===null)this._canvasContext=this.domNode.getContext("2d");return this._canvasContext},computeWithClippingFrame:function(d,b){var a=this.clippingFrame;return{x:d+
a.x,y:b+a.y}},minimumRedrawDelay:1E3/30,clippingFrameChanged:function(){this.invalidate()},drawRect:function(){},render:function(){if(!(this._renderTimer||this._redrawTimer))this._renderTimer=setTimeout(this._tryRedraw.bind(this),0)},invalidate:function(){this._invalidRects="all";this.render()},invalidateRect:function(d){var b=this._invalidRects;if(b!=="all"){b.push(d);this.render()}},_tryRedraw:function(){this._renderTimer=null;var d=(new Date).getTime(),b=this._lastRedrawTime,a=this.minimumRedrawDelay;
if(b===null||d-b>=a)this._redraw();else if(this._redrawTimer===null)this._redrawTimer=window.setTimeout(this._redraw.bind(this),a)},_redraw:function(){var d=this.clippingFrame;d={x:Math.round(d.x),y:Math.round(d.y),width:d.width,height:d.height};var b=this._getContext();b.save();b.translate(-d.x,-d.y);var a=this._invalidRects;if(a==="all"){this._clearOnFullInvalid&&b.clearRect(0,0,this.domNode.width,this.domNode.height);this.drawRect(d,b)}else k.merge(a).forEach(function(g){g=k.intersectRects(g,d);
if(g.width!==0&&g.height!==0){b.save();var f=g.x,h=g.y,l=g.width,i=g.height;b.beginPath();b.moveTo(f,h);b.lineTo(f+l,h);b.lineTo(f+l,h+i);b.lineTo(f,h+i);b.closePath();b.clip();this.drawRect(g,b);b.restore()}},this);b.restore();this._invalidRects=[];this._redrawTimer=null;this._lastRedrawTime=(new Date).getTime()}};Object.defineProperties(m.CanvasView.prototype,{clippingFrame:{get:function(){return this._clippingFrame},set:function(d){d=n.mixin(n.clone(this._clippingFrame),d);if(this._clippingFrame===
null||!k.rectsEqual(d,this._clippingFrame)){this._clippingFrame=d;this.clippingChanged()}}},frame:{get:function(){return this._frame},set:function(d){var b=this.domNode,a=b.style,g=this._preventDownsize,f=b.width,h=b.height;a=b.style;a.left=d.x+"px";a.top=d.y+"px";var l,i;if(d.width!==f)if(d.width<f)g||(l=true);else l=true;if(d.height!==h)if(d.height<h)g||(i=true);else i=true;if(l)this.domNode.width=d.width;if(i)this.domNode.height=d.height;this._frame=d;this.clippingFrame={width:d.width,height:d.height}}}})});
bespin.tiki.module("text_editor:views/editor",function(t,m){function n(o){var r=j.plugins.text_editor.provides,v=r.length,p={};if(o){o=o.themestyles;if(o.currentThemeVariables&&o.currentThemeVariables.text_editor)p=o.currentThemeVariables.text_editor}for(;v--;)if(r[v].ep==="themevariable"){o=d.mixin(d.clone(r[v].defaultValue),p[r[v].name]);switch(r[v].name){case "gutter":case "editor":case "scroller":case "highlighter":q[r[v].name]=o}}}var k=t("rangeutils:utils/range"),e=t("views/scroller"),d=t("bespin:util/util"),
b=t("models/buffer").Buffer,a=t("controllers/search").EditorSearchController,g=t("controllers/undo").EditorUndoController,f=t("events").Event,h=t("views/gutter").GutterView;t("controllers/layoutmanager");var l=e.ScrollerCanvasView,i=t("views/text").TextView,j=t("bespin:plugins").catalog,s=t("settings").settings,q={};n();j.registerExtension("themeChange",{pointer:n});m.EditorView=function(o){this.elementAppended=new f;var r=this.element=this.container=document.createElement("div");r.style.overflow=
"hidden";r.style.position="relative";this.scrollOffsetChanged=new f;this.willChangeBuffer=new f;this.selectionChanged=new f;this.textChanged=new f;this.gutterView=new h(r,this);this.textView=new i(r,this);var v=new l(this,e.LAYOUT_VERTICAL),p=new l(this,e.LAYOUT_HORIZONTAL);this.verticalScroller=v;this.horizontalScroller=p;this.editorUndoController=new g(this);this.searchController=new a(this);this._textViewSize=this._oldSize={width:0,height:0};this._themeData=q;this.buffer=new b(null,o);this.elementAppended.add(function(){var u=
s.get("fontsize"),w=s.get("fontface");this._font=u+"px "+w;j.registerExtension("themeChange",{pointer:this._themeVariableChange.bind(this)});j.registerExtension("settingChange",{match:"font[size|face]",pointer:this._fontSettingChanged.bind(this)});j.registerExtension("dimensionsChanged",{pointer:this.dimensionsChanged.bind(this)});this._dontRecomputeLayout=false;this._recomputeLayout();r.addEventListener(d.isMozilla?"DOMMouseScroll":"mousewheel",this._onMouseWheel.bind(this),false);v.valueChanged.add(function(x){this.scrollOffset=
{y:x}}.bind(this));p.valueChanged.add(function(x){this.scrollOffset={x:x}}.bind(this));this.scrollOffsetChanged.add(function(x){this._updateScrollOffsetChanged(x)}.bind(this))}.bind(this))};m.EditorView.prototype={elementAppended:null,textChanged:null,selectionChanged:null,scrollOffsetChanged:null,willChangeBuffer:null,_textViewSize:null,_textLinesCount:0,_gutterViewWidth:0,_oldSize:null,_buffer:null,_dontRecomputeLayout:true,_themeData:null,_layoutManagerSizeChanged:function(o){var r=this.layoutManager.fontDimension;
this._textViewSize={width:o.width*r.characterWidth,height:o.height*r.lineHeight};if(this._textLinesCount!==o.height){this.gutterView.computeWidth()!==this._gutterViewWidth?this._recomputeLayout(true):this.gutterView.invalidate();this._textLinesLength=o.height}this._updateScrollers();this.scrollOffset={}},_updateScrollers:function(){if(!this._dontRecomputeLayout){var o=this.textViewPaddingFrame,r=this._textViewSize.width,v=this._textViewSize.height,p=this.scrollOffset,u=this.verticalScroller,w=this.horizontalScroller;
if(v<o.height)u.isVisible=false;else{u.isVisible=true;u.proportion=o.height/v;u.maximum=v-o.height;u.value=p.y}if(r<o.width)w.isVisible=false;else{w.isVisible=true;w.proportion=o.width/r;w.maximum=r-o.width;w.value=p.x}}},_onMouseWheel:function(o){var r=0;if(o.wheelDelta)r=-o.wheelDelta;else if(o.detail)r=o.detail*40;var v=true;if(o.axis){if(o.axis==o.HORIZONTAL_AXIS)v=false}else if(o.wheelDeltaY||o.wheelDeltaX){if(o.wheelDeltaX==o.wheelDelta)v=false}else if(o.shiftKey)v=false;v?this.scrollBy(0,r):
this.scrollBy(r*5,0);d.stopEvent(o)},scrollTo:function(o){this.scrollOffset=o},scrollBy:function(o,r){this.scrollOffset={x:this.scrollOffset.x+o,y:this.scrollOffset.y+r}},_recomputeLayout:function(o){if(!this._dontRecomputeLayout){var r=this.container.offsetWidth,v=this.container.offsetHeight;if(!(!o&&r==this._oldSize.width&&v==this._oldSize.height)){this._oldSize={width:r,height:v};this._gutterViewWidth=o=this.gutterView.computeWidth();this.gutterView.frame={x:0,y:0,width:o,height:v};this.textView.frame=
{x:o,y:0,width:r-o,height:v};var p=this._themeData.scroller.padding,u=this._themeData.scroller.thickness;this.horizontalScroller.frame={x:o+p,y:v-(u+p),width:r-(o+2*p+u),height:u};this.verticalScroller.frame={x:r-(p+u),y:p,width:u,height:v-(2*p+u)};this.scrollOffset={};this._updateScrollers();this.gutterView.invalidate();this.textView.invalidate();this.verticalScroller.invalidate();this.horizontalScroller.invalidate()}}},dimensionsChanged:function(){this._recomputeLayout()},_font:null,_fontSettingChanged:function(){s.get("fontsize");
s.get("fontface");this._font=fontsize+"px "+fontface;this.layoutManager._recalculateMaximumWidth();this._layoutManagerSizeChanged(this.layoutManager.size);this.textView.invalidate()},_themeVariableChange:function(){this._recomputeLayout(true)},_updateScrollOffsetChanged:function(o){this.verticalScroller.value=o.y;this.horizontalScroller.value=o.x;this.textView.clippingFrame={x:o.x,y:o.y};this.gutterView.clippingFrame={y:o.y};this._updateScrollers();this.gutterView.invalidate();this.textView.invalidate()},
replace:function(o,r,v){if(!k.isRange(o))throw new Error('replace(): expected range but found "'+o+"'");if(!d.isString(r))throw new Error('replace(): expected text string but found "'+text+'"');var p=k.normalizeRange(o),u=this.textView,w=u.getSelectedRange(false);return u.groupChanges(function(){u.replaceCharacters(p,r);if(v)u.setSelection(w);else{var x=r.split("\n");x=x.length>1?{row:o.start.row+x.length-1,col:x[x.length-1].length}:k.addPositions(o.start,{row:0,col:r.length});u.moveCursorTo(x)}})},
getText:function(o){if(!k.isRange(o))throw new Error('getText(): expected range but found "'+o+'"');return this.layoutManager.textStorage.getCharacters(k.normalizeRange(o))},setLineNumber:function(o){if(!d.isNumber(o))throw new Error("setLineNumber(): lineNumber must be a number");this.textView.moveCursorTo({row:o-1,col:0})},setCursor:function(o){if(!k.isPosition(o))throw new Error('setCursor(): expected position but found "'+o+'"');this.textView.moveCursorTo(o)},changeGroup:function(o){return this.textView.groupChanges(function(){o(this)}.bind(this))}};
Object.defineProperties(m.EditorView.prototype,{themeData:{get:function(){return this._themeData},set:function(){throw new Error("themeData can't be changed directly. Use themeManager.");}},font:{get:function(){return this._font},set:function(){throw new Error("font can't be changed directly. Use settings fontsize and fontface.");}},buffer:{set:function(o){if(o!==this._buffer){if(!o.loadPromise.isResolved())throw new Error("buffer.set(): the new buffer must first be loaded!");if(this._buffer!==null){this.layoutManager.sizeChanged.remove(this);
this.layoutManager.textStorage.changed.remove(this);this.textView.selectionChanged.remove(this)}this.willChangeBuffer(o);j.publish(this,"editorChange","buffer",o);this.layoutManager=o.layoutManager;this._buffer=o;var r=this.layoutManager,v=this.textView;r.sizeChanged.add(this,this._layoutManagerSizeChanged.bind(this));r.textStorage.changed.add(this,this.textChanged.bind(this));v.selectionChanged.add(this,this.selectionChanged.bind(this));this.textView.setSelection(o._selectedRange,false);this.scrollOffsetChanged(o._scrollOffset);
this.layoutManager.sizeChanged(this.layoutManager.size);this._recomputeLayout()}},get:function(){return this._buffer}},frame:{get:function(){return{width:this.container.offsetWidth,height:this.container.offsetHeight}}},textViewPaddingFrame:{get:function(){var o=d.clone(this.textView.frame),r=this.textView.padding;o.width-=r.left+r.right;o.height-=r.top+r.bottom;return o}},scrollOffset:{set:function(o){if(o.x===undefined)o.x=this.scrollOffset.x;if(o.y===undefined)o.y=this.scrollOffset.y;var r=this.textViewPaddingFrame;
if(o.y<0)o.y=0;else if(this._textViewSize.height<r.height)o.y=0;else if(o.y+r.height>this._textViewSize.height)o.y=this._textViewSize.height-r.height;if(o.x<0)o.x=0;else if(this._textViewSize.width<r.width)o.x=0;else if(o.x+r.width>this._textViewSize.width)o.x=this._textViewSize.width-r.width;if(!(o.x===this.scrollOffset.x&&o.y===this.scrollOffset.y)){this.buffer._scrollOffset=o;this.scrollOffsetChanged(o);j.publish(this,"editorChange","scrollOffset",o)}},get:function(){return this.buffer._scrollOffset}},
readOnly:{get:function(){return this._buffer.model.readOnly},set:function(o){this._buffer.model.readOnly=o}},focus:{get:function(){return this.textView.hasFocus},set:function(o){if(!d.isBoolean(o))throw new Error('set focus: expected boolean but found "'+o+'"');this.textView.hasFocus=o}},selection:{get:function(){return d.clone(this.textView.getSelectedRange(false))},set:function(o){if(!k.isRange(o))throw new Error("set selection: position/selection must be supplied");this.textView.setSelection(o)}},
selectedText:{get:function(){return this.getText(this.selection)},set:function(o){if(!d.isString(o))throw new Error('set selectedText: expected string but found "'+o+'"');return this.replace(this.selection,o)}},value:{get:function(){return this.layoutManager.textStorage.value},set:function(o){if(!d.isString(o))throw new Error('set value: expected string but found "'+o+'"');return this.replace(this.layoutManager.textStorage.range,o,false)}},syntax:{get:function(){return this.layoutManager.syntaxManager.getSyntax()},
set:function(o){if(!d.isString(o))throw new Error('set syntax: expected string but found "'+newValue+'"');return this.layoutManager.syntaxManager.setSyntax(o)}}})});
bespin.tiki.module("text_editor:views/gutter",function(t,m){var n=t("bespin:util/util"),k=t("views/canvas").CanvasView;m.GutterView=function(e,d){k.call(this,e,true);this.editor=d};m.GutterView.prototype=new k;n.mixin(m.GutterView.prototype,{drawRect:function(e,d){var b=this.editor.themeData.gutter;d.fillStyle=b.backgroundColor;d.fillRect(e.x,e.y,e.width,e.height);d.save();d.translate(b.paddingLeft,0);var a=this.editor.layoutManager,g=a.characterRangeForBoundingRect(e);e=Math.min(g.end.row,a.textLines.length-
1);var f=a.fontDimension.lineAscent;d.fillStyle=b.color;d.font=this.editor.font;for(b=g.start.row;b<=e;b++)d.fillText(""+(b+1),-0.5,a.lineRectForRow(b).y+f-0.5);d.restore()},computeWidth:function(){var e=this.editor.themeData.gutter,d=this.editor.layoutManager;return d.fontDimension.characterWidth*(""+d.textLines.length).length+(e.paddingLeft+e.paddingRight)}})});
bespin.tiki.module("text_editor:views/scroller",function(t,m){var n=t("bespin:util/util"),k=t("events").Event,e=t("bespin:console").console,d=t("utils/rect"),b=t("views/canvas").CanvasView,a=m.LAYOUT_HORIZONTAL=0,g=m.LAYOUT_VERTICAL=1;m.ScrollerCanvasView=function(f,h){b.call(this,f.container,true,true);this.editor=f;this.layoutDirection=h;f=function(l,i,j){j=j||this.domNode;j.addEventListener(l,function(s){i.call(this,s);n.stopEvent(s)}.bind(this),false)}.bind(this);f("mouseover",this.mouseEntered);
f("mouseout",this.mouseExited);f("mousedown",this.mouseDown);f("mouseup",this.mouseUp,window);f("mousemove",this.mouseMove,window);this.valueChanged=new k};m.ScrollerCanvasView.prototype=new b;n.mixin(m.ScrollerCanvasView.prototype,{lineHeight:20,proportion:0,layoutDirection:g,_isVisible:false,_maximum:0,_value:0,valueChanged:null,padding:{left:0,bottom:0,top:0,right:0},_mouseDownScreenPoint:null,_mouseDownValue:null,_isMouseOver:false,_scrollTimer:null,_mouseEventPosition:null,_mouseOverHandle:false,
_drawNib:function(f){var h=this.editor.themeData.scroller,l,i;l=h.nibStyle;i=h.nibArrowStyle;h=h.nibStrokeStyle;var j=Math.floor(7.5);f.fillStyle=l;f.beginPath();f.arc(0,0,Math.floor(7.5),0,Math.PI*2,true);f.closePath();f.fill();f.strokeStyle=h;f.stroke();f.fillStyle=i;f.beginPath();f.moveTo(0,-j+3);f.lineTo(-j+3,j-5);f.lineTo(j-3,j-5);f.closePath();f.fill()},_drawNibs:function(f,h){var l=this._getClientThickness(),i=this._value,j=this._maximum,s=this._isHighlighted();if(s||i!==0){f.save();f.translate(8,
l/2);f.rotate(Math.PI*1.5);f.moveTo(0,0);this._drawNib(f,h);f.restore()}if(s||i!==j){f.save();f.translate(this._getClientLength()-8,l/2);f.rotate(Math.PI*0.5);f.moveTo(0,0);this._drawNib(f,h);f.restore()}},_getClientFrame:function(){var f=this.frame,h=this.padding;return{x:h.left,y:h.top,width:f.width-(h.left+h.right),height:f.height-(h.top+h.bottom)}},_getClientLength:function(){var f=this._getClientFrame();switch(this.layoutDirection){case a:return f.width;case g:return f.height;default:e.error("unknown layout direction");
return null}},_getClientThickness:function(){var f=this.padding,h=this.editor.themeData.scroller.thickness;switch(this.layoutDirection){case g:return h-(f.left+f.right);case a:return h-(f.top+f.bottom);default:e.error("unknown layout direction");return null}},_getFrameLength:function(){switch(this.layoutDirection){case a:return this.frame.width;case g:return this.frame.height;default:e.error("unknown layout direction");return null}},_getGutterFrame:function(){var f=this._getClientFrame(),h=this._getClientThickness();
switch(this.layoutDirection){case g:return{x:f.x,y:f.y+15,width:h,height:Math.max(0,f.height-30)};case a:return{x:f.x+15,y:f.y,width:Math.max(0,f.width-30),height:h};default:e.error("unknown layout direction");return null}},_getGutterLength:function(){var f=this._getGutterFrame(),h;switch(this.layoutDirection){case a:h=f.width;break;case g:h=f.height;break;default:e.error("unknown layout direction");break}return h},_getHandleFrame:function(){var f=this._getGutterFrame(),h=this._getHandleOffset(),
l=this._getHandleLength();switch(this.layoutDirection){case g:return{x:f.x,y:f.y+h,width:f.width,height:l};case a:return{x:f.x+h,y:f.y,width:l,height:f.height}}},_getHandleLength:function(){var f=this._getGutterLength();return Math.max(f*this.proportion,20)},_getHandleOffset:function(){var f=this._maximum;if(f===0)return 0;var h=this._getGutterLength(),l=this._getHandleLength();return(h-l)*this._value/f},_isHighlighted:function(){return this._isMouseOver===true||this._mouseDownScreenPoint!==null},
_segmentForMouseEvent:function(f){f={x:f.layerX,y:f.layerY};var h=this._getClientFrame(),l=this.padding;if(!d.pointInRect(f,h))return null;var i=this.layoutDirection;switch(i){case a:if(f.x-l.left<15)return"nib-start";else if(f.x>=h.width-15)return"nib-end";break;case g:if(f.y-l.top<15)return"nib-start";else if(f.y>=h.height-15)return"nib-end";break;default:e.error("unknown layout direction");break}l=this._getHandleFrame();if(d.pointInRect(f,l))return"handle";switch(i){case a:if(f.x<l.x)return"gutter-before";
else if(f.x>=l.x+l.width)return"gutter-after";break;case g:if(f.y<l.y)return"gutter-before";else if(f.y>=l.y+l.height)return"gutter-after";break;default:e.error("unknown layout direction");break}e.error("_segmentForMouseEvent: point ",f," outside view with handle frame ",l," and client frame ",h);return null},adjustFrame:function(){var f=this.frame;this.set("layout",{left:0,top:0,width:f.width,height:f.height})},drawRect:function(f,h){if(this._isVisible){var l=this._isHighlighted();f=this.editor.themeData.scroller;
var i=l?f.fullAlpha:f.particalAlpha,j=this.frame;h.clearRect(0,0,j.width,j.height);h.save();j=this.padding;h.translate(j.left,j.top);this._getHandleFrame();j=this._getGutterLength();var s=this._getClientThickness(),q=s/2,o=this.layoutDirection,r=this._getHandleOffset()+15,v=this._getHandleLength();if(o===g){h.translate(s+1,0);h.rotate(Math.PI*0.5)}if(!(j<=v)){h.globalAlpha=i;if(l){l=this._getClientLength();h.fillStyle=f.trackFillStyle;h.fillRect(8.5,0.5,l-16,s-1);h.strokeStyle=f.trackStrokeStyle;
h.strokeRect(8.5,0.5,l-16,s-1)}l=function(){h.beginPath();h.arc(r+q+0.5,q,q-0.5,Math.PI/2,3*Math.PI/2,false);h.arc(r+v-q-0.5,q,q-0.5,3*Math.PI/2,Math.PI/2,false);h.lineTo(r+q+0.5,s-0.5);h.closePath()};l();j=h.createLinearGradient(r,0,r,s);j.addColorStop(0,f.barFillGradientTopStart);j.addColorStop(0.4,f.barFillGradientTopStop);j.addColorStop(0.41,f.barFillStyle);j.addColorStop(0.8,f.barFillGradientBottomStart);j.addColorStop(1,f.barFillGradientBottomStop);h.fillStyle=j;h.fill();h.save();h.clip();h.fillStyle=
f.barFillStyle;h.beginPath();h.moveTo(r+q*0.4,q*0.6);h.lineTo(r+q*0.9,s*0.4);h.lineTo(r,s*0.4);h.closePath();h.fill();h.beginPath();h.moveTo(r+v-q*0.4,0+q*0.6);h.lineTo(r+v-q*0.9,0+s*0.4);h.lineTo(r+v,0+s*0.4);h.closePath();h.fill();h.restore();h.save();l();h.strokeStyle=f.trackStrokeStyle;h.stroke();h.restore();this._drawNibs(h,i);h.restore()}}},_repeatAction:function(f,h){if(f()!==false){var l=function(){this._repeatAction(f,100)}.bind(this);this._scrollTimer=setTimeout(l,h)}},_scrollByDelta:function(f){this.value=
this._value+f},_scrollUpOneLine:function(){this._scrollByDelta(-this.lineHeight);return true},_scrollDownOneLine:function(){this._scrollByDelta(this.lineHeight);return true},_scrollPage:function(){switch(this._segmentForMouseEvent(this._mouseEventPosition)){case "gutter-before":this._scrollByDelta(this._getGutterLength()*-1);break;case "gutter-after":this._scrollByDelta(this._getGutterLength());break;case null:break;default:return false}return true},mouseDown:function(f){this._mouseEventPosition=
f;this._mouseOverHandle=false;this._getGutterLength();switch(this._segmentForMouseEvent(f)){case "nib-start":this._repeatAction(this._scrollUpOneLine.bind(this),500);break;case "nib-end":this._repeatAction(this._scrollDownOneLine.bind(this),500);break;case "gutter-before":this._repeatAction(this._scrollPage.bind(this),500);break;case "gutter-after":this._repeatAction(this._scrollPage.bind(this),500);break;case "handle":break;default:e.error("_segmentForMouseEvent returned an unknown value");break}switch(this.layoutDirection){case a:this._mouseDownScreenPoint=
f.pageX;break;case g:this._mouseDownScreenPoint=f.pageY;break;default:e.error("unknown layout direction");break}},mouseMove:function(f){if(this._mouseDownScreenPoint!==null){if(this._segmentForMouseEvent(f)=="handle"||this._mouseOverHandle===true){this._mouseOverHandle=true;if(this._scrollTimer!==null){clearTimeout(this._scrollTimer);this._scrollTimer=null}var h;switch(this.layoutDirection){case a:h=f.pageX;break;case g:h=f.pageY;break;default:e.error("unknown layout direction");break}var l=h-this._mouseDownScreenPoint,
i=this._maximum,j=this._value,s=this._getGutterLength(),q=this._getHandleLength();this.value=j+i*l/(s-q);this._mouseDownScreenPoint=h}this._mouseEventPosition=f}},mouseEntered:function(){this._isMouseOver=true;this.invalidate()},mouseExited:function(){this._isMouseOver=false;this.invalidate()},mouseUp:function(){this._mouseDownValue=this._mouseDownScreenPoint=null;if(this._scrollTimer){clearTimeout(this._scrollTimer);this._scrollTimer=null}this.invalidate()}});Object.defineProperties(m.ScrollerCanvasView.prototype,
{isVisible:{set:function(f){if(this._isVisible!==f){this._isVisible=f;this.domNode.style.display=f?"block":"none";f&&this.invalidate()}}},maximum:{set:function(f){if(this._value>this._maximum)this._value=this._maximum;if(f!==this._maximum){this._maximum=f;this.invalidate()}}},value:{set:function(f){if(f<0)f=0;else if(f>this._maximum)f=this._maximum;if(f!==this._value){this._value=f;this.valueChanged(f);this.invalidate()}}}})});
bespin.tiki.module("text_editor:views/text",function(t,m){var n=t("bespin:plugins").catalog,k=t("bespin:util/util"),e=t("events").Event,d=t("views/canvas").CanvasView;t("controllers/layoutmanager");var b=t("rangeutils:utils/range"),a=t("utils/rect"),g=t("views/textinput").TextInput,f=t("keyboard:keyboard").keyboardManager,h=t("bespin:console").console,l=t("settings").settings;m.TextView=function(i,j){d.call(this,i,true);this.editor=j;this.textInput=new g(i,this);this.padding={top:0,bottom:30,left:0,
right:30};this.clippingChanged.add(this.clippingFrameChanged.bind(this));i=this.domNode;i.style.cursor="text";i.addEventListener("mousedown",this.mouseDown.bind(this),false);i.addEventListener("mousemove",this.mouseMove.bind(this),false);window.addEventListener("mouseup",this.mouseUp.bind(this),false);j.willChangeBuffer.add(this.editorWillChangeBuffer.bind(this));this.selectionChanged=new e;this.beganChangeGroup=new e;this.endedChangeGroup=new e;this.willReplaceRange=new e;this.replacedCharacters=
new e};m.TextView.prototype=new d;k.mixin(m.TextView.prototype,{_dragPoint:null,_dragTimer:null,_enclosingScrollView:null,_inChangeGroup:false,_insertionPointBlinkTimer:null,_insertionPointVisible:true,_keyBuffer:"",_keyMetaBuffer:"",_keyState:"start",_hasFocus:false,_mouseIsDown:false,selectionChanged:null,beganChangeGroup:null,endedChangeGroup:null,willReplaceRange:null,replacedCharacters:null,editorWillChangeBuffer:function(i){if(this.editor.layoutManager){var j=this.editor.layoutManager;j.invalidatedRects.remove(this);
j.changedTextAtRow.remove(this)}j=i.layoutManager;j.invalidatedRects.add(this,this.layoutManagerInvalidatedRects.bind(this));j.changedTextAtRow.add(this,this.layoutManagerChangedTextAtRow.bind(this))},didFocus:function(){this._setFocus(true,true)},didBlur:function(){this._setFocus(false,true)},_drag:function(){var i=this._dragPoint,j=a.offsetFromRect(this.clippingFrame,i);this.moveCursorTo(this._selectionPositionForPoint({x:i.x-j.x,y:i.y-j.y}),true)},_drawInsertionPoint:function(i,j){if(this._insertionPointVisible){var s=
this.editor.layoutManager.characterRectForPosition(this.editor.buffer._selectedRange.start);i=Math.floor(s.x);var q=s.y,o=Math.ceil(s.width);s=s.height;j.save();var r=this.editor.themeData.editor;if(this._hasFocus){j.strokeStyle=r.cursorColor;j.beginPath();j.moveTo(i+0.5,q);j.lineTo(i+0.5,q+s);j.closePath();j.stroke()}else{j.fillStyle=r.unfocusedCursorBackgroundColor;j.fillRect(i+0.5,q,o-0.5,s);j.strokeStyle=r.unfocusedCursorColor;j.strokeRect(i+0.5,q+0.5,o-1,s-1)}j.restore()}},_drawLines:function(i,
j){var s=this.editor.layoutManager,q=s.textLines,o=s.fontDimension.lineAscent,r=this.editor.themeData.highlighter;j.save();j.font=this.editor.font;var v=s.characterRangeForBoundingRect(i),p=v.start;v=v.end;for(var u=v.row,w=p.row;w<=u;w++){var x=q[w];if(!k.none(x)){var A=x.characters,E=A.length,D=Math.min(v.col,E),G=p.col;if(!(G>=E)){x=x.colors;if(x==null)x=[];for(E=0;E<x.length&&G<x[E].start;)E++;for(var H=E<x.length?x[E].start:G;H<D;){i=x[E];G=i!=null?i.end:D;i=i!=null?i.tag:"plain";i=r.hasOwnProperty(i)?
r[i]:"red";j.fillStyle=i;i=s.characterRectForPosition({row:w,col:H});H=A.substring(H,G);j.fillText(H,i.x,i.y+o);H=G;E++}}}}j.restore()},_drawSelectionHighlight:function(i,j){i=this.editor.themeData.editor;i=this._hasFocus?i.selectedTextBackgroundColor:i.unfocusedCursorBackgroundColor;var s=this.editor.layoutManager;j.save();var q=b.normalizeRange(this.editor.buffer._selectedRange);j.fillStyle=i;s.rectsForRange(q).forEach(function(o){j.fillRect(o.x,o.y,o.width,o.height)});j.restore()},_drawSelection:function(i,
j){this._rangeIsInsertionPoint(this.editor.buffer._selectedRange)?this._drawInsertionPoint(i,j):this._drawSelectionHighlight(i,j)},_getVirtualSelection:function(i){var j=this.editor.buffer._selectedRange,s=this.editor.buffer._selectedRangeEndVirtual;return{start:i&&s?s:j.start,end:s||j.end}},_invalidateSelection:function(){var i=function(q){return{x:q.x-1,y:q.y,width:q.width+2,height:q.height}},j=this.editor.layoutManager,s=b.normalizeRange(this.editor.buffer._selectedRange);if(this._rangeIsInsertionPoint(s)){j=
j.characterRectForPosition(s.start);this.invalidateRect(i(j))}else j.rectsForRange(s).forEach(function(q){this.invalidateRect(i(q))},this)},_isReadOnly:function(){return this.editor.layoutManager.textStorage.readOnly},_keymappingChanged:function(){this._keyBuffer="";this._keyState="start"},_performVerticalKeyboardSelection:function(i){var j=this.editor.buffer._selectedRangeEndVirtual;this.moveCursorTo(b.addPositions(j!==null?j:this.editor.buffer._selectedRange.end,{row:i,col:0}),true,true)},_rangeIsInsertionPoint:function(i){return b.isZeroLength(i)},
_rearmInsertionPointBlinkTimer:function(){this._insertionPointVisible||this.blinkInsertionPoint();this._insertionPointBlinkTimer!==null&&clearInterval(this._insertionPointBlinkTimer);this._insertionPointBlinkTimer=setInterval(this.blinkInsertionPoint.bind(this),750)},_repositionSelection:function(){var i=this.editor.layoutManager.textLines,j=i.length,s=this.editor.buffer._selectedRange,q=Math.min(s.start.row,j-1);j=Math.min(s.end.row,j-1);var o=i[j];this.setSelection({start:{row:q,col:Math.min(s.start.col,
i[q].characters.length)},end:{row:j,col:Math.min(s.end.col,o.characters.length)}})},_scrollPage:function(i){this.editor.scrollBy(0,(this.clippingFrame.height+this.editor.layoutManager.fontDimension.lineAscent)*(i?-1:1))},_scrollWhileDragging:function(){var i=this._dragPoint;i=this.computeWithClippingFrame(i.layerX,i.layerY);k.mixin(this._dragPoint,i);this._drag()},_selectionPositionForPoint:function(i){i=this.editor.layoutManager.characterAtPoint(i);return i.partialFraction<0.5?i:b.addPositions(i,
{row:0,col:1})},_syntaxManagerUpdatedSyntaxForRows:function(i,j){if(i!==j){var s=this.editor.layoutManager;s.updateTextRows(i,j);s.rectsForRange({start:{row:i,col:0},end:{row:j,col:0}}).forEach(this.invalidateRect,this)}},blinkInsertionPoint:function(){this._insertionPointVisible=!this._insertionPointVisible;this._invalidateSelection()},copy:function(){return this.getSelectedCharacters()},cut:function(){var i=this.getSelectedCharacters();i!=""&&this.performBackspaceOrDelete(false);return i},drawRect:function(i,
j){j.fillStyle=this.editor.themeData.editor.backgroundColor;j.fillRect(i.x,i.y,i.width,i.height);this._drawSelection(i,j);this._drawLines(i,j)},focus:function(){this.textInput.focus()},getSelectedCharacters:function(){return this._rangeIsInsertionPoint(this.editor.buffer._selectedRange)?"":this.editor.layoutManager.textStorage.getCharacters(b.normalizeRange(this.editor.buffer._selectedRange))},getSelectedRange:function(i){return i?this.editor.buffer._selectedRange:b.normalizeRange(this.editor.buffer._selectedRange)},
groupChanges:function(i){if(this._isReadOnly())return false;if(this._inChangeGroup){i();return true}this._inChangeGroup=true;this.beganChangeGroup(this,this.editor.buffer._selectedRange);try{i()}catch(j){h.error("Error in groupChanges(): "+j);this._inChangeGroup=false;this.endedChangeGroup(this,this.editor.buffer._selectedRange);return false}finally{this._inChangeGroup=false;this.endedChangeGroup(this,this.editor.buffer._selectedRange);return true}},insertText:function(i){if(this._isReadOnly())return false;
this.groupChanges(function(){var j=b.normalizeRange(this.editor.buffer._selectedRange);this.replaceCharacters(j,i);var s=i.split("\n");this.moveCursorTo(s.length>1?{row:j.start.row+s.length-1,col:s[s.length-1].length}:b.addPositions(j.start,{row:0,col:i.length}))}.bind(this));return true},isDelimiter:function(i){return"\"',;.!~@#$%^&*?[]<>():/\\-+ \t".indexOf(i)!==-1},keyDown:function(i){if(i.charCode===0||i._charCode===0)return f.processKeyEvent(i,this,{isTextView:true});else if(i.keyCode===9)i.preventDefault();
else return false},layoutManagerChangedTextAtRow:function(){this._repositionSelection()},layoutManagerInvalidatedRects:function(i,j){j.forEach(this.invalidateRect,this)},mouseDown:function(i){k.stopEvent(i);this._mouseIsDown=this.hasFocus=true;var j=this.computeWithClippingFrame(i.layerX,i.layerY);k.mixin(j,{layerX:i.layerX,layerY:i.layerY});switch(i.detail){case 1:var s=this._selectionPositionForPoint(j);this.moveCursorTo(s,i.shiftKey);break;case 2:s=this._selectionPositionForPoint(j);var q=this.editor.layoutManager.textStorage.lines[s.row];
if(q.length===0)return true;s.col-=s.col==q.length?1:0;var o=!this.isDelimiter(q[s.col]),r=this,v=function(p,u){for(;p>-1&&p<q.length;p+=u)if(r.isDelimiter(q[p])===o)break;return p+(u==1?0:1)};i=v(s.col,-1);v=v(s.col,1);this.moveCursorTo({row:s.row,col:i});this.moveCursorTo({row:s.row,col:v},true);break;case 3:i=this.editor.layoutManager.textStorage.lines;s=this._selectionPositionForPoint(j);this.setSelection({start:{row:s.row,col:0},end:{row:s.row,col:i[s.row].length}});break}this._dragPoint=j;this._dragTimer=
setInterval(this._scrollWhileDragging.bind(this),100)},mouseMove:function(i){if(this._mouseIsDown){this._dragPoint=this.computeWithClippingFrame(i.layerX,i.layerY);k.mixin(this._dragPoint,{layerX:i.layerX,layerY:i.layerY});this._drag()}},mouseUp:function(){this._mouseIsDown=false;if(this._dragTimer!==null){clearInterval(this._dragTimer);this._dragTimer=null}},moveCursorTo:function(i,j,s){var q=this.editor.layoutManager.textStorage,o=q.clampPosition(i);this.setSelection({start:j?this.editor.buffer._selectedRange.start:
o,end:o});if(s){j=q.lines.length;s=i.row;q=i.col;this.editor.buffer._selectedRangeEndVirtual=s>0&&s<j?i:{row:s<1?0:j-1,col:q}}else this.editor.buffer._selectedRangeEndVirtual=null;this.scrollToPosition(this.editor.buffer._selectedRange.end)},moveDown:function(){var i=this._getVirtualSelection();i=b.normalizeRange(i);i=this._rangeIsInsertionPoint(this.editor.buffer._selectedRange)?i.end:{row:i.end.row,col:i.start.col};i=b.addPositions(i,{row:1,col:0});this.moveCursorTo(i,false,true)},moveLeft:function(){var i=
b.normalizeRange(this.editor.buffer._selectedRange);this._rangeIsInsertionPoint(i)?this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(i.start,-1)):this.moveCursorTo(i.start)},moveRight:function(){var i=b.normalizeRange(this.editor.buffer._selectedRange);this._rangeIsInsertionPoint(i)?this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(i.end,1)):this.moveCursorTo(i.end)},moveUp:function(){var i=b.normalizeRange(this._getVirtualSelection(true));position=b.addPositions({row:i.start.row,
col:this._getVirtualSelection().end.col},{row:-1,col:0});this.moveCursorTo(position,false,true)},parentViewFrameChanged:function(){arguments.callee.base.apply(this,arguments);this._resize()},replaceCharacters:function(i,j){if(this._isReadOnly())return false;this.groupChanges(function(){i=b.normalizeRange(i);this.willReplaceRange(this,i);this.editor.layoutManager.textStorage.replaceCharacters(i,j);this.replacedCharacters(this,i,j)}.bind(this));return true},performBackspaceOrDelete:function(i){if(this._isReadOnly())return false;
var j=this.editor.layoutManager.textStorage,s=j.lines,q="";q=0;var o=l.get("tabstop"),r=this.getSelectedRange();if(b.isZeroLength(r))if(i){i=r.start;q=s[i.row];q=q.substring(0,i.col).match(/\s*$/)[0].length<o||(i.col-o)%o!=0?1:o;r={start:j.displacePosition(i,q*-1),end:r.end}}else{i=r.end;q=s[i.row];q=q.substring(i.col).match(/^\s*/)[0].length<o?1:o;r={start:r.start,end:j.displacePosition(r.end,q)}}this.groupChanges(function(){this.replaceCharacters(r,"");this.moveCursorTo(r.start)}.bind(this));return true},
resetKeyBuffers:function(){this._keyMetaBuffer=this._keyBuffer=""},scrollPageDown:function(){this._scrollPage(false)},scrollPageUp:function(){this._scrollPage(true)},scrollToPosition:function(i){var j=this.editor.layoutManager.characterRectForPosition(i);i=j.x;var s=j.y,q=j.width;j=j.height;var o=this.clippingFrame,r=o.x,v=o.y,p=this.padding,u=o.width-p.right;o=o.height-p.bottom;this.editor.scrollTo({x:i>=r+30&&i+q<r+u?r:i-u/2+q/2,y:s>=v&&s+j<v+o?v:s-o/2+j/2})},selectAll:function(){var i=this.editor.layoutManager.textStorage.lines,
j=i.length-1;this.setSelection({start:{row:0,col:0},end:{row:j,col:i[j].length}})},selectDown:function(){this._performVerticalKeyboardSelection(1)},selectLeft:function(){this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(this.editor.buffer._selectedRange.end,-1),true)},selectRight:function(){this.moveCursorTo(this.editor.layoutManager.textStorage.displacePosition(this.editor.buffer._selectedRange.end,1),true)},selectUp:function(){this._performVerticalKeyboardSelection(-1)},setSelection:function(i,
j){var s=this.editor.layoutManager.textStorage;i=s.clampRange(i);if(!b.equal(i,this.editor.buffer._selectedRange)){this._invalidateSelection();this.editor.buffer._selectedRange=i=s.clampRange(i);this._invalidateSelection();this._hasFocus&&this._rearmInsertionPointBlinkTimer();j&&this.scrollToPosition(i.end);this.selectionChanged(i);n.publish(this.editor,"editorChange","selection",i)}},textInserted:function(i){if(i!=="\n")if(!f.processKeyInput(i,this,{isTextView:true,isCommandKey:false})){this.insertText(i);
this.resetKeyBuffers()}},_setFocus:function(i,j){if(i!=this._hasFocus)if(this._hasFocus=i){this._rearmInsertionPointBlinkTimer();this._invalidateSelection();j||this.textInput.focus()}else{if(this._insertionPointBlinkTimer){clearInterval(this._insertionPointBlinkTimer);this._insertionPointBlinkTimer=null}this._insertionPointVisible=true;this._invalidateSelection();j||this.textInput.blur()}}});Object.defineProperties(m.TextView.prototype,{hasFocus:{get:function(){return this._hasFocus},set:function(i){this._setFocus(i,
false)}}})});
bespin.tiki.module("text_editor:views/textinput",function(t,m){var n=t("bespin:util/util");t("events");var k=t("keyboard:keyutil");m.TextInput=function(e,d){var b=this.domNode=document.createElement("textarea");b.setAttribute("style","position: absolute; z-index: -99999; width: 0px; height: 0px; margin: 0px; border: 0px");e.appendChild(b);this.delegate=d;this._attachEvents()};m.TextInput.prototype={_composing:false,domNode:null,delegate:null,_textFieldChanged:function(){if(!(this._composing||this._ignore)){var e=
this.domNode,d=e.value;if(d!=""){e.value="";this._textInserted(d)}}},_copy:function(){var e=false,d=this.delegate;if(d&&d.copy)e=d.copy();return e},_cut:function(){var e=false,d=this.delegate;if(d&&d.cut)e=d.cut();return e},_textInserted:function(e){var d=this.delegate;d&&d.textInserted&&d.textInserted(e)},_setValueAndSelect:function(e){var d=this.domNode;d.value=e;d.select()},focus:function(){this.domNode.focus()},blur:function(){this.domNode.blur()},_attachEvents:function(){var e=this.domNode,d=
this;e.addEventListener("focus",function(){d.delegate&&d.delegate.didFocus&&d.delegate.didFocus()},false);e.addEventListener("blur",function(){d.delegate&&d.delegate.didBlur&&d.delegate.didBlur()},false);k.addKeyDownListener(e,function(h){return d.delegate&&d.delegate.keyDown?d.delegate.keyDown(h):false});if(n.isWebKit){n.isChrome||e.addEventListener("compositionend",function(h){d._textInserted(h.data)},false);e.addEventListener("textInput",function(h){d._textInserted(h.data)},false);e.addEventListener("paste",
function(h){d._textInserted(h.clipboardData.getData("text/plain"));h.preventDefault()},false)}else{var b=d._textFieldChanged.bind(d);e.addEventListener("keydown",function(){window.setTimeout(b,0)},false);e.addEventListener("keypress",b,false);e.addEventListener("keyup",b,false);e.addEventListener("compositionstart",function(){d._composing=true},false);e.addEventListener("compositionend",function(){d._composing=false;d._textFieldChanged()},false);e.addEventListener("paste",function(){d._setValueAndSelect("");
window.setTimeout(function(){d._textFieldChanged()},0)},false)}var a=function(h){h=h.type.indexOf("copy")!=-1?d._copy():d._cut();d._setValueAndSelect(h)};if(n.isWebKit&&!n.isChrome&&n.isMac){var g=(new Date).getTime(),f=function(h){var l=h.type.indexOf("cut")!=-1;if(!(l&&(new Date).getTime()-g<10)){a(h);if(l)g=(new Date).getTime()}};e.addEventListener("beforecopy",f,false);e.addEventListener("beforecut",f,false)}else{f=false;if(n.isMozilla)f=function(h){a(h);d._ignore=true;window.setTimeout(function(){d._setValueAndSelect("");
d._ignore=false},0)};e.addEventListener("copy",f||a,false);e.addEventListener("cut",f||a,false)}}}});bespin.tiki.module("text_editor:index",function(){});bespin.tiki.register("::less",{name:"less",dependencies:{}});
bespin.tiki.module("less:index",function(t,m){function n(b){if(b instanceof d.Dimension)return parseFloat(b.unit=="%"?b.value/100:b.value);else if(typeof b==="number")return b;else throw{error:"RuntimeError",message:"color functions take numbers as parameters"};}function k(b){return Math.min(1,Math.max(0,b))}if(!Array.isArray)Array.isArray=function(b){return Object.prototype.toString.call(b)==="[object Array]"||b instanceof Array};if(!Array.prototype.forEach)Array.prototype.forEach=function(b,a){for(var g=
this.length>>>0,f=0;f<g;f++)f in this&&b.call(a,this[f],f,this)};if(!Array.prototype.map)Array.prototype.map=function(b,a){for(var g=this.length>>>0,f=new Array(g),h=0;h<g;h++)if(h in this)f[h]=b.call(a,this[h],h,this);return f};if(!Array.prototype.filter)Array.prototype.filter=function(b,a){for(var g=[],f=0;f<this.length;f++)b.call(a,this[f])&&g.push(this[f]);return g};if(!Array.prototype.reduce)Array.prototype.reduce=function(b){var a=this.length>>>0,g=0;if(a===0&&arguments.length===1)throw new TypeError;
if(arguments.length>=2)var f=arguments[1];else{do{if(g in this){f=this[g++];break}if(++g>=a)throw new TypeError;}while(1)}for(;g<a;g++)if(g in this)f=b.call(null,f,this[g],g,this);return f};if(!Array.prototype.indexOf)Array.prototype.indexOf=function(b,a){var g=this.length;a=a||0;if(!g)return-1;if(a>=g)return-1;if(a<0)a+=g;for(;a<g;a++)if(Object.prototype.hasOwnProperty.call(this,a))if(b===this[a])return a;return-1};if(!Object.keys)Object.keys=function(b){var a=[];for(var g in b)Object.prototype.hasOwnProperty.call(b,
g)&&a.push(g);return a};if(!String.prototype.trim)String.prototype.trim=function(){return String(this).replace(/^\s\s*/,"").replace(/\s\s*$/,"")};if(typeof t!=="undefined")var e=m,d={};else e=d={};e.Parser=function(b){function a(p){var u,w,x;if(p instanceof Function)return p.call(q.parsers);else if(typeof p==="string"){u=f.charAt(h)===p?p:null;w=1}else{if(h>=s+j[l].length&&l<j.length-1)s+=j[l++].length;p.lastIndex=x=h-s;if(u=p.exec(j[l])){w=u[0].length;if(p.lastIndex-w!==x)return}}if(u){h+=w;for(w=
s+j[l].length;h<=w;){p=f.charCodeAt(h);if(!(p===32||p===10||p===9))break;h++}return typeof u==="string"?u:u.length===1?u[0]:u}}function g(p){var u;if(typeof p==="string")return f.charAt(h)===p;else{p.lastIndex=h;if((u=p.exec(f))&&p.lastIndex-u[0].length===h)return u}}var f,h,l,i,j,s,q,o=this,r=function(){},v=this.imports={paths:b&&b.paths||[],queue:[],files:{},push:function(p,u){var w=this;this.queue.push(p);e.Parser.importer(p,this.paths,function(x){w.queue.splice(w.queue.indexOf(p),1);w.files[p]=
x;u(x);w.queue.length===0&&r()})}};this.env=b||{};this.optimization="optimization"in this.env?this.env.optimization:1;return q={imports:v,parse:function(p,u){var w,x,A=null;h=l=s=i=0;j=[];f=p.replace(/\r\n/g,"\n");if(o.optimization>0){f=f.replace(/\/\*(?:[^*]|\*+[^\/*])*\*+\//g,function(G){return o.optimization>1?"":G.replace(/\n(\s*\n)+/g,"\n")});j=f.split(/^(?=\n)/mg)}else j=[f];w=new d.Ruleset([],a(this.parsers.primary));w.root=true;w.toCSS=function(G){var H,J;return function(){try{return G.call(this)}catch(K){J=
f.split("\n");H=(f.slice(0,K.index).match(/\n/g)||"").length+1;for(var L=K.index,M=-1;L>=0&&f.charAt(L)!=="\n";L--)M++;throw{name:"NameError",message:K.message,line:H,column:M,extract:[J[H-2],J[H-1],J[H]]};}}}(w.toCSS);if(h<f.length-1){h=i;x=f.split("\n");p=(f.slice(0,h).match(/\n/g)||"").length+1;for(var E=h,D=-1;E>=0&&f.charAt(E)!=="\n";E--)D++;A={name:"ParseError",message:"Syntax Error on line "+p,filename:b.filename,line:p,column:D,extract:[x[p-2],x[p-1],x[p]]}}if(this.imports.queue.length>0)r=
function(){u(A,w)};else u(A,w)},parsers:{primary:function(){for(var p,u=[];p=a(this.mixin.definition)||a(this.rule)||a(this.ruleset)||a(this.mixin.call)||a(this.comment)||a(/[\n\s]+/g)||a(this.directive);)u.push(p);return u},comment:function(){var p;if(f.charAt(h)==="/")return(p=a(/\/\*(?:[^*]|\*+[^\/*])*\*+\/\n?/g))?new d.Comment(p):a(/\/\/.*/g)},entities:{quoted:function(){var p;if(!(f.charAt(h)!=='"'&&f.charAt(h)!=="'"))if(p=a(/"((?:[^"\\\r\n]|\\.)*)"|'((?:[^'\\\r\n]|\\.)*)'/g))return new d.Quoted(p[0],
p[1]||p[2])},keyword:function(){var p;if(p=a(/[A-Za-z-]+/g))return new d.Keyword(p)},call:function(){var p,u;if(p=a(/([a-zA-Z0-9_-]+|%)\(/g)){if(p[1].toLowerCase()==="alpha")return a(this.alpha);u=a(this.entities.arguments);if(a(")"))if(p)return new d.Call(p[1],u)}},arguments:function(){for(var p=[],u;u=a(this.expression);){p.push(u);if(!a(","))break}return p},literal:function(){return a(this.entities.dimension)||a(this.entities.color)||a(this.entities.quoted)},url:function(){var p;if(!(f.charAt(h)!==
"u"||!a(/url\(/g))){p=a(this.entities.quoted)||a(/[-a-zA-Z0-9_%@$\/.&=:;#+?]+/g);if(!a(")"))throw new Error("missing closing ) for url()");return new d.URL(p.value?p:new d.Anonymous(p))}},variable:function(){var p,u=h;if(f.charAt(h)==="@"&&(p=a(/@[a-zA-Z0-9_-]+/g)))return new d.Variable(p,u)},color:function(){var p;if(f.charAt(h)==="#"&&(p=a(/#([a-fA-F0-9]{6}|[a-fA-F0-9]{3})/g)))return new d.Color(p[1])},dimension:function(){var p;p=f.charCodeAt(h);if(!(p>57||p<45||p===47))if(p=a(/(-?[0-9]*\.?[0-9]+)(px|%|em|pc|ex|in|deg|s|ms|pt|cm|mm)?/g))return new d.Dimension(p[1],
p[2])}},variable:function(){var p;if(f.charAt(h)==="@"&&(p=a(/(@[a-zA-Z0-9_-]+)\s*:/g)))return p[1]},shorthand:function(){var p,u;if(g(/[@\w.-]+\/[@\w.-]+/g))if((p=a(this.entity))&&a("/")&&(u=a(this.entity)))return new d.Shorthand(p,u)},mixin:{call:function(){for(var p=[],u,w,x,A=h;u=a(/[#.][a-zA-Z0-9_-]+/g);){p.push(new d.Element(w,u));w=a(">")}a("(")&&(x=a(this.entities.arguments))&&a(")");if(p.length>0&&(a(";")||g("}")))return new d.mixin.Call(p,x,A)},definition:function(){var p,u=[],w,x;if(!(f.charAt(h)!==
"."||g(/[^{]*(;|})/g)))if(p=a(/([#.][a-zA-Z0-9_-]+)\s*\(/g)){for(p=p[1];w=a(/@[\w-]+/g)||a(this.entities.literal)||a(this.entities.keyword);){if(w[0]==="@")if(a(":"))if(x=a(this.expression))u.push({name:w,value:x});else throw new Error("Expected value");else u.push({name:w});else u.push({value:w});if(!a(","))break}if(!a(")"))throw new Error("Expected )");if(w=a(this.block))return new d.mixin.Definition(p,u,w)}}},entity:function(){return a(this.entities.literal)||a(this.entities.variable)||a(this.entities.url)||
a(this.entities.call)||a(this.entities.keyword)},end:function(){return a(";")||g("}")},alpha:function(){var p;if(a(/opacity=/gi))if(p=a(/[0-9]+/g)||a(this.entities.variable)){if(!a(")"))throw new Error("missing closing ) for alpha()");return new d.Alpha(p)}},element:function(){var p;c=a(this.combinator);if(p=a(/[.#:]?[a-zA-Z0-9_-]+/g)||a("*")||a(this.attribute)||a(/\([^)@]+\)/g))return new d.Element(c,p)},combinator:function(){var p;return(p=a(/[+>~]/g)||a("&")||a(/::/g))?new d.Combinator(p):new d.Combinator(f.charAt(h-
1)===" "?" ":null)},selector:function(){for(var p,u=[];p=a(this.element);)u.push(p);if(u.length>0)return new d.Selector(u)},tag:function(){return a(/[a-zA-Z][a-zA-Z-]*[0-9]?/g)||a("*")},attribute:function(){var p="",u,w,x;if(a("[")){if(u=a(/[a-z-]+/g)||a(this.entities.quoted))p=(x=a(/[|~*$^]?=/g))&&(w=a(this.entities.quoted)||a(/[\w-]+/g))?[u,x,w.toCSS?w.toCSS():w].join(""):u;if(a("]"))if(p)return"["+p+"]"}},block:function(){var p;if(a("{")&&(p=a(this.primary))&&a("}"))return p},ruleset:function(){var p=
[],u,w,x=h;if(u=g(/([a-z.#: _-]+)[\s\n]*\{/g)){h+=u[0].length-1;p=[new d.Selector([new d.Element(null,u[1])])]}else{for(;u=a(this.selector);){p.push(u);if(!a(","))break}u&&a(this.comment)}if(p.length>0&&(w=a(this.block)))return new d.Ruleset(p,w);else{i=h;h=x}},rule:function(){var p,u=h;if(name=a(this.property)||a(this.variable)){if(name.charAt(0)!="@"&&(match=g(/([^@+\/*(;{}-]*);/g))){h+=match[0].length-1;p=new d.Anonymous(match[1])}else p=name==="font"?a(this.font):a(this.value);if(a(this.end))return new d.Rule(name,
p,u);else{i=h;h=u}}},"import":function(){var p;if(a(/@import\s+/g)&&(p=a(this.entities.quoted)||a(this.entities.url))&&a(";"))return new d.Import(p,v)},directive:function(){var p,u,w;if(f.charAt(h)==="@")if(u=a(this["import"]))return u;else if(p=a(/@media|@page/g)){w=a(/[^{]+/g).trim();if(u=a(this.block))return new d.Directive(p+" "+w,u)}else if(p=a(/@[-a-z]+/g))if(p==="@font-face"){if(u=a(this.block))return new d.Directive(p,u)}else if((u=a(this.entity))&&a(";"))return new d.Directive(p,u)},font:function(){for(var p=
[],u=[],w;w=a(this.shorthand)||a(this.entity);)u.push(w);p.push(new d.Expression(u));if(a(","))for(;w=a(this.expression);){p.push(w);if(!a(","))break}return new d.Value(p,a(this.important))},value:function(){for(var p,u=[];p=a(this.expression);){u.push(p);if(!a(","))break}p=a(this.important);if(u.length>0)return new d.Value(u,p)},important:function(){return a(/!\s*important/g)},sub:function(){var p;if(a("(")&&(p=a(this.expression))&&a(")"))return p},multiplication:function(){var p,u,w,x;if(p=a(this.operand)){for(;(w=
a(/[\/*]/g))&&(u=a(this.operand));)x=new d.Operation(w,[x||p,u]);return x||p}},addition:function(){var p,u,w,x;if(p=a(this.multiplication)){for(;(w=a(/[-+]\s+/g)||f.charAt(h-1)!=" "&&a(/[-+]/g))&&(u=a(this.multiplication));)x=new d.Operation(w,[x||p,u]);return x||p}},operand:function(){return a(this.sub)||a(this.entities.dimension)||a(this.entities.color)||a(this.entities.variable)},expression:function(){for(var p,u=[];p=a(this.addition)||a(this.entity);)u.push(p);if(u.length>0)return new d.Expression(u)},
property:function(){var p;if(p=a(/(\*?-?[-a-z_0-9]+)\s*:/g))return p[1]}}}};e.Parser.importer=null;d.functions={rgb:function(b,a,g){return this.rgba(b,a,g,1)},rgba:function(b,a,g,f){b=[b,a,g].map(function(h){return n(h)});f=n(f);return new d.Color(b,f)},hsl:function(b,a,g){return this.hsla(b,a,g,1)},hsla:function(b,a,g,f){function h(j){j=j<0?j+1:j>1?j-1:j;return j*6<1?i+(l-i)*j*6:j*2<1?l:j*3<2?i+(l-i)*(2/3-j)*6:i}b=(n(b)%360+360)%360/360;a=n(a);g=n(g);f=n(f);var l=g<=0.5?g*(a+1):g+a-g*a,i=g*2-l;return this.rgba(h(b+
1/3)*255,h(b)*255,h(b-1/3)*255,f)},opacity:function(b,a){n(a);return new d.Color(b.rgb,n(a))},saturate:function(b,a){b=b.toHSL();b.s+=a.value/100;b.s=k(b.s);return this.hsl(b.h,b.s,b.l)},desaturate:function(b,a){b=b.toHSL();b.s-=a.value/100;b.s=k(b.s);return this.hsl(b.h,b.s,b.l)},lighten:function(b,a){b=b.toHSL();b.l*=1+a.value/100;b.l=k(b.l);return this.hsl(b.h,b.s,b.l)},darken:function(b,a){b=b.toHSL();b.l*=1-a.value/100;b.l=k(b.l);return this.hsl(b.h,b.s,b.l)},greyscale:function(b){return this.desaturate(b,
new d.Dimension(100))},e:function(b){return new d.Anonymous(b)},"%":function(b){for(var a=Array.prototype.slice.call(arguments,1),g=b.content,f=0;f<a.length;f++)g=g.replace(/%s/,a[f].content).replace(/%[da]/,a[f].toCSS());g=g.replace(/%%/g,"%");return new d.Quoted('"'+g+'"',g)}};d.Alpha=function(b){this.value=b};d.Alpha.prototype={toCSS:function(){return"alpha(opacity="+this.value.toCSS()+")"},eval:function(){return this}};d.Anonymous=function(b){this.value=b.content||b};d.Anonymous.prototype={toCSS:function(){return this.value},
eval:function(){return this}};d.Call=function(b,a){this.name=b;this.args=a};d.Call.prototype={eval:function(b){var a=this.args.map(function(g){return g.eval(b)});return this.name in d.functions?d.functions[this.name].apply(d.functions,a):new d.Anonymous(this.name+"("+a.map(function(g){return g.toCSS()}).join(", ")+")")},toCSS:function(b){return this.eval(b).toCSS()}};d.Color=function(b,a){if(Array.isArray(b)){this.rgb=b;this.alpha=a}else this.rgb=b.length==6?b.match(/.{2}/g).map(function(g){return parseInt(g,
16)}):b.split("").map(function(g){return parseInt(g+g,16)})};d.Color.prototype={eval:function(){return this},toCSS:function(){return this.alpha&&this.alpha<1?"rgba("+this.rgb.concat(this.alpha).join(", ")+")":"#"+this.rgb.map(function(b){b=Math.round(b);b=(b>255?255:b<0?0:b).toString(16);return b.length===1?"0"+b:b}).join("")},operate:function(b,a){var g=[];a instanceof d.Color||(a=a.toColor());for(var f=0;f<3;f++)g[f]=d.operate(b,this.rgb[f],a.rgb[f]);return new d.Color(g)},toHSL:function(){var b=
this.rgb[0]/255,a=this.rgb[1]/255,g=this.rgb[2]/255,f=Math.max(b,a,g),h=Math.min(b,a,g),l,i=(f+h)/2,j=f-h;if(f===h)l=h=0;else{h=i>0.5?j/(2-f-h):j/(f+h);switch(f){case b:l=(a-g)/j+(a<g?6:0);break;case a:l=(g-b)/j+2;break;case g:l=(b-a)/j+4;break}l/=6}return{h:l*360,s:h,l:i}}};d.Comment=function(b){this.value=b};d.Comment.prototype={toCSS:function(){return this.value}};d.Dimension=function(b,a){this.value=parseFloat(b);this.unit=a||null};d.Dimension.prototype={eval:function(){return this},toColor:function(){return new d.Color([this.value,
this.value,this.value])},toCSS:function(){return this.value+this.unit},operate:function(b,a){return new d.Dimension(d.operate(b,this.value,a.value),this.unit||a.unit)}};d.Directive=function(b,a){this.name=b;if(Array.isArray(a))this.ruleset=new d.Ruleset([],a);else this.value=a};d.Directive.prototype={toCSS:function(b,a){if(this.ruleset){this.ruleset.root=true;return this.name+" {\n  "+this.ruleset.toCSS(b,a).trim().replace(/\n/g,"\n  ")+"\n}\n"}else return this.name+" "+this.value.toCSS()+";\n"},
eval:function(b){b.frames.unshift(this);this.ruleset&&this.ruleset.evalRules(b);b.frames.shift();return this},variable:function(b){return d.Ruleset.prototype.variable.call(this.ruleset,b)},find:function(){return d.Ruleset.prototype.find.apply(this.ruleset,arguments)},rulesets:function(){return d.Ruleset.prototype.rulesets.apply(this.ruleset)}};d.Element=function(b,a){this.combinator=b instanceof d.Combinator?b:new d.Combinator(b);this.value=a.trim()};d.Element.prototype.toCSS=function(){return this.combinator.toCSS()+
this.value};d.Combinator=function(b){this.value=b===" "?" ":b?b.trim():""};d.Combinator.prototype.toCSS=function(){switch(this.value){case "":return"";case " ":return" ";case "&":return"";case ":":return" :";case "::":return"::";case "+":return" + ";case "~":return" ~ ";case ">":return" > "}};d.Expression=function(b){this.value=b};d.Expression.prototype={eval:function(b){return this.value.length>1?new d.Expression(this.value.map(function(a){return a.eval(b)})):this.value[0].eval(b)},toCSS:function(){return this.value.map(function(b){return b.toCSS()}).join(" ")}};
d.Import=function(b,a){var g=this;this._path=b;this.path=b instanceof d.Quoted?/\.(le?|c)ss$/.test(b.content)?b.content:b.content+".less":b.value.content||b.value;(this.css=/css$/.test(this.path))||a.push(this.path,function(f){g.root=f})};d.Import.prototype={toCSS:function(){return this.css?"@import "+this._path.toCSS()+";\n":""},eval:function(){if(this.css)return this;else{for(var b=0;b<this.root.rules.length;b++)this.root.rules[b]instanceof d.Import&&Array.prototype.splice.apply(this.root.rules,
[b,1].concat(this.root.rules[b].eval()));return this.root.rules}}};d.Keyword=function(b){this.value=b};d.Keyword.prototype={eval:function(){return this},toCSS:function(){return this.value}};d.mixin={};d.mixin.Call=function(b,a,g){this.selector=new d.Selector(b);this.arguments=a;this.index=g};d.mixin.Call.prototype={eval:function(b){for(var a,g=[],f=false,h=0;h<b.frames.length;h++)if((a=b.frames[h].find(this.selector)).length>0){for(h=0;h<a.length;h++)if(a[h].match(this.arguments,b))try{Array.prototype.push.apply(g,
a[h].eval(this.arguments,b).rules);f=true}catch(l){throw{message:l.message,index:this.index};}if(f)return g;else throw{message:"No matching definition was found for `"+this.selector.toCSS().trim()+"("+this.arguments.map(function(i){return i.toCSS()}).join(", ")+")`",index:this.index};}throw{message:this.selector.toCSS().trim()+" is undefined",index:this.index};}};d.mixin.Definition=function(b,a,g){this.name=b;this.selectors=[new d.Selector([new d.Element(null,b)])];this.params=a;this.arity=a.length;
this.rules=g;this._lookups={};this.required=a.reduce(function(f,h){return h.name&&!h.value?f+1:f},0)};d.mixin.Definition.prototype={toCSS:function(){return""},variable:function(b){return d.Ruleset.prototype.variable.call(this,b)},find:function(){return d.Ruleset.prototype.find.apply(this,arguments)},rulesets:function(){return d.Ruleset.prototype.rulesets.apply(this)},eval:function(b,a){for(var g=new d.Ruleset(null,[]),f=0,h;f<this.params.length;f++)if(this.params[f].name)if(h=b&&b[f]||this.params[f].value)g.rules.unshift(new d.Rule(this.params[f].name,
h.eval(a)));else throw{message:"wrong number of arguments for "+this.name+" ("+b.length+" for "+this.arity+")"};return(new d.Ruleset(null,this.rules)).evalRules({frames:[this,g].concat(a.frames)})},match:function(b,a){var g=b&&b.length||0;if(g<this.required)return false;for(var f=0;f<Math.min(g,this.arity);f++)if(!this.params[f].name)if(!b[f].wildcard)if(b[f].eval(a).toCSS()!=this.params[f].value.eval(a).toCSS())return false;return true}};d.Operation=function(b,a){this.op=b.trim();this.operands=a};
d.Operation.prototype.eval=function(b){var a=this.operands[0].eval(b);b=this.operands[1].eval(b);var g;if(a instanceof d.Dimension&&b instanceof d.Color)if(this.op==="*"||this.op==="+"){g=b;b=a;a=g}else throw{name:"OperationError",message:"Can't substract or divide a color from a number"};return a.operate(this.op,b)};d.operate=function(b,a,g){switch(b){case "+":return a+g;case "-":return a-g;case "*":return a*g;case "/":return a/g}};d.Quoted=function(b,a){this.value=b;this.content=a};d.Quoted.prototype=
{toCSS:function(){return this.value},eval:function(){return this}};d.Rule=function(b,a,g){this.name=b;this.value=a instanceof d.Value?a:new d.Value([a]);this.index=g;this.variable=b.charAt(0)==="@"?true:false};d.Rule.prototype.toCSS=function(){return this.variable?"":this.name+": "+this.value.toCSS()+";"};d.Rule.prototype.eval=function(b){return new d.Rule(this.name,this.value.eval(b))};d.Value=function(b){this.value=b;this.is="value"};d.Value.prototype={eval:function(b){return this.value.length===
1?this.value[0].eval(b):new d.Value(this.value.map(function(a){return a.eval(b)}))},toCSS:function(){return this.value.map(function(b){return b.toCSS()}).join(", ")}};d.Shorthand=function(b,a){this.a=b;this.b=a};d.Shorthand.prototype={toCSS:function(b){return this.a.toCSS(b)+"/"+this.b.toCSS(b)},eval:function(){return this}};d.Ruleset=function(b,a){this.selectors=b;this.rules=a;this._lookups={}};d.Ruleset.prototype={eval:function(){return this},evalRules:function(b){var a=[];this.rules.forEach(function(g){if(g.evalRules)a.push(g.evalRules(b));
else g instanceof d.mixin.Call?Array.prototype.push.apply(a,g.eval(b)):a.push(g.eval(b))});this.rules=a;return this},match:function(b){return!b||b.length===0},variable:function(b){return this._variables?this._variables[b]:(this._variables=this.rules.reduce(function(a,g){if(g instanceof d.Rule&&g.variable===true)a[g.name]=g;return a},{}))[b]},rulesets:function(){return this._rulesets?this._rulesets:(this._rulesets=this.rules.filter(function(b){if(b instanceof d.Ruleset||b instanceof d.mixin.Definition)return b}))},
find:function(b,a){a=a||this;var g=[],f=b.toCSS();if(f in this._lookups)return this._lookups[f];this.rulesets().forEach(function(h){if(h!==a)for(var l=0;l<h.selectors.length;l++)if(b.match(h.selectors[l])){b.elements.length>1?Array.prototype.push.apply(g,h.find(new d.Selector(b.elements.slice(1)),a)):g.push(h);break}});return this._lookups[f]=g},toCSS:function(b,a){var g=[],f=[],h=[],l=[];if(this.root){b=[];a={frames:[]};for(var i=0;i<this.rules.length;i++)this.rules[i]instanceof d.Import&&Array.prototype.splice.apply(this.rules,
[i,1].concat(this.rules[i].eval(a)))}else if(b.length===0)l=this.selectors.map(function(s){return[s]});else for(i=0;i<this.selectors.length;i++)for(var j=0;j<b.length;j++)l.push(b[j].concat([this.selectors[i]]));a.frames.unshift(this);for(i=0;i<this.rules.length;i++)this.rules[i]instanceof d.mixin.Call&&Array.prototype.splice.apply(this.rules,[i,1].concat(this.rules[i].eval(a)));for(i=0;i<this.rules.length;i++){b=this.rules[i];if(b instanceof d.Directive)h.push(b.eval(a).toCSS(l,a));else if(b.rules)h.push(b.toCSS(l,
a));else if(b instanceof d.Comment)this.root?h.push(b.toCSS()):f.push(b.toCSS());else if(b.toCSS&&!b.variable)f.push(b.eval(a).toCSS());else b.value&&!b.variable&&f.push(b.value.toString())}h=h.join("");if(this.root)g.push(f.join("\n"));else if(f.length>0){l=l.map(function(s){return s.map(function(q){return q.toCSS()}).join("").trim()}).join(l.length>3?",\n":", ");g.push(l," {\n  "+f.join("\n  ")+"\n}\n")}g.push(h);a.frames.shift();return g.join("")}};d.Selector=function(b){this.elements=b;if(this.elements[0].combinator.value===
"")this.elements[0].combinator.value=" "};d.Selector.prototype.match=function(b){return this.elements[0].value===b.elements[0].value?true:false};d.Selector.prototype.toCSS=function(){if(this._css)return this._css;return this._css=this.elements.map(function(b){return typeof b==="string"?" "+b.trim():b.toCSS()}).join("")};d.URL=function(b){this.value=b};d.URL.prototype={toCSS:function(){return"url("+this.value.toCSS()+")"},eval:function(){return this}};d.Variable=function(b,a){this.name=b;this.index=
a};d.Variable.prototype={eval:function(b){var a,g,f=this.name;if(a=d.find(b.frames,function(h){if(g=h.variable(f))return g.value.eval(b)}))return a;else throw{message:"variable "+this.name+" is undefined",index:this.index};}};d.find=function(b,a){for(var g=0,f;g<b.length;g++)if(f=a.call(b,b[g]))return f;return null};(function(){function b(q){for(var o=0;o<j.length;o++)a(j[o],q)}function a(q,o){var r=typeof localStorage!=="undefined"&&localStorage.getItem(q.href),v=r&&JSON.parse(r);f(q.href,function(p,
u){if(v&&(new Date(u)).valueOf()===(new Date(v.timestamp)).valueOf()){g(v.css,q);o(null,q,{local:true})}else(new e.Parser({optimization:3})).parse(p,function(w,x){if(w)return i(w,q.href);try{o(x,q,{local:false,lastModified:u})}catch(A){i(A,q.href)}})},function(p){throw new Error("Couldn't load "+q.href+" ("+p+")");})}function g(q,o,r){var v=document.createElement("style");v.type="text/css";v.media="screen";v.title="less-sheet";if(o){v.title=o.title||o.href.match(/(?:^|\/)([-\w]+)\.[a-z]+$/i)[1];r&&
typeof localStorage!=="undefined"&&localStorage.setItem(o.href,JSON.stringify({timestamp:r,css:q}))}if(v.styleSheet)v.styleSheet.cssText=q;else v.appendChild(document.createTextNode(q));document.getElementsByTagName("head")[0].appendChild(v)}function f(q,o,r){var v=h();if(window.location.protocol==="file:"){v.open("GET",q,false);v.send(null);v.status===0?o(v.responseText):r(v.status)}else{v.open("GET",q,true);v.onreadystatechange=function(){if(v.readyState==4)if(v.status>=200&&v.status<300)o(v.responseText,
v.getResponseHeader("Last-Modified"));else typeof r==="function"&&r(v.status)};v.send(null)}}function h(){if(window.XMLHttpRequest)return new XMLHttpRequest;else try{return new ActiveXObject("MSXML2.XMLHTTP.3.0")}catch(q){l("less: browser doesn't support AJAX.");return null}}function l(q){e.env=="development"&&typeof console!=="undefined"&&console.log(q)}function i(q,o){var r=document.createElement("div"),v;r.id="less-error-message";r.innerHTML="<h3>"+(q.message||"There is an error in your .less file")+
'</h3><p><a href="'+o+'">'+o+"</a> on line "+q.line+", column "+(q.column+1)+":</p>"+'<div>\n<pre class="ctx"><span>[-1]</span>{0}</pre>\n<pre><span>[0]</span>{current}</pre>\n<pre class="ctx"><span>[1]</span>{2}</pre>\n</div>'.replace(/\[(-?\d)\]/g,function(p,u){return q.line+parseInt(u)}).replace(/\{(\d)\}/g,function(p,u){return q.extract[parseInt(u)]}).replace(/\{current\}/,q.extract[1].slice(0,q.column)+'<span class="error">'+q.extract[1].slice(q.column)+"</span>");g("#less-error-message span {margin-right: 15px;}#less-error-message pre {color: #ee4444;padding: 4px 0;margin: 0;}#less-error-message pre.ctx {color: #dd7777;}#less-error-message h3 {padding: 15px 0 5px 0;margin: 0;}#less-error-message a {color: #10a}#less-error-message .error {color: red;font-weight: bold;padding-bottom: 2px;border-bottom: 1px dashed red;}");
r.style.cssText="font-family: Arial, sans-serif;border: 1px solid #e00;background-color: #eee;border-radius: 5px;color: #e00;padding: 15px;margin-bottom: 15px";if(e.env=="development")v=setInterval(function(){if(document.body){document.body.insertBefore(r,document.body.childNodes[0]);clearInterval(v)}},10)}var j=[];e.env="production";var s=setInterval(function(){if(document.body){if(!document.querySelectorAll&&typeof jQuery==="undefined")l("No selector method found");else j=(document.querySelectorAll||
jQuery).call(document,'link[rel="stylesheet/less"]');clearInterval(s);b(function(q,o,r){g(q.toCSS(),o,r.lastModified);r.local?l("less: loading "+o.href+" from local storage."):l("less: parsed "+o.href+" successfully.")})}},10);if(e.env==="development")refreshTimer=setInterval(function(){/!refresh/.test(location.hash)&&b(function(q,o,r){g(q.toCSS(),o,r)})},1E3);e.Parser.importer=function(q,o,r){a({href:q,title:q},function(v){r(v)})}})()});
bespin.tiki.register("::canon",{name:"canon",dependencies:{events:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("canon:environment",function(t,m){var n=t("bespin:util/util"),k=t("bespin:console").console,e=t("bespin:plugins").catalog,d=t("settings").settings;m.Environment=function(){this.commandLine=null;window.addEventListener("resize",this.dimensionsChanged.bind(this),false)};Object.defineProperties(m.Environment.prototype,{settings:{value:{set:function(b,a){if(n.none(b))throw new Error("setSetting(): key must be supplied");if(n.none(a))throw new Error("setSetting(): value must be supplied");
d.set(b,a)},get:function(b){if(n.none(b))throw new Error("getSetting(): key must be supplied");return d.get(b)}}},dimensionsChanged:{value:function(){e.publish(this,"dimensionsChanged")}},session:{get:function(){return e.getObject("session")}},view:{get:function(){if(!this.session)return null;return this.session.currentView}},editor:{get:function(){if(!this.session)return null;return this.session.currentView.editor}},contexts:{get:function(){if(!this.view)return[];var b=this.view.editor.layoutManager.syntaxManager,
a=this.view.getSelectedRange().start;return b.contextsAtPosition(a)}},buffer:{get:function(){if(this.session)return this.view.editor.buffer;else k.error("command attempted to get buffer but there's no session")}},model:{get:function(){if(this.buffer)return this.view.editor.layoutManager.textStorage;else k.error("Session has no current buffer")}},file:{get:function(){if(this.buffer)return this.buffer.file;else k.error("Session has no current buffer")}},files:{get:function(){return e.getObject("files")}}});
m.global=new m.Environment});
bespin.tiki.module("canon:history",function(t,m){var n=t("bespin:util/stacktrace").Trace,k=t("bespin:plugins").catalog;m.requests=[];m.addRequestOutput=function(e){for(m.requests.push(e);m.requests.length>100;)m.requests.shiftObject();k.publish(this,"addedRequestOutput",null,e)};m.execute=function(e,d,b){if(b.command)try{b.command(e,d,b)}catch(a){e=new n(a,true);console.group("Error executing command '"+b.typed+"'");console.log("command=",b.commandExt);console.log("args=",d);console.error(a);e.log(3);
console.groupEnd();b.doneWithError(a)}else b.doneWithError("Command not found.")}});
bespin.tiki.module("canon:request",function(t,m){var n=t("events").Event,k=t("canon:history");m.Request=function(e){e=e||{};this.command=e.command;this.commandExt=e.commandExt;this.args=e.args;this.typed=e.typed;this._begunOutput=false;this.start=new Date;this.end=null;this.error=this.completed=false;this.changed=new n};m.Request.prototype._beginOutput=function(){this._begunOutput=true;this.outputs=[];k.addRequestOutput(this)};m.Request.prototype.doneWithError=function(e){this.error=true;this.done(e)};
m.Request.prototype.async=function(){this._begunOutput||this._beginOutput()};m.Request.prototype.output=function(e){this._begunOutput||this._beginOutput();if(typeof e!=="string"&&!(e instanceof Node))e=e.toString();this.outputs.push(e);this.changed();return this};m.Request.prototype.done=function(e){this.completed=true;this.end=new Date;this.duration=this.end.getTime()-this.start.getTime();e?this.output(e):this.changed()}});bespin.tiki.module("canon:index",function(){});
bespin.tiki.register("::traits",{name:"traits",dependencies:{}});
bespin.tiki.module("traits:index",function(t,m){m.Trait=function(){function n(z){var y=function(){throw new Error("Conflicting property: "+z);};D(y.prototype);return D(y)}function k(){return D({value:undefined,enumerable:false,required:true})}function e(z){z=n(z);return p?D({get:z,set:z,enumerable:false,conflict:true}):D({value:z,enumerable:false,conflict:true})}function d(z,y){return z===y?z!==0||1/z===1/y:z!==z&&y!==y}function b(z,y){return z.conflict&&y.conflict?true:z.get===y.get&&z.set===y.set&&
d(z.value,y.value)&&z.enumerable===y.enumerable&&z.required===y.required&&z.conflict===y.conflict}function a(z,y){return D(w(z,y))}function g(z){var y={};E(z,function(B){y[B]=true});return D(y)}function f(z){var y={};E(G(z),function(B){var C=H(z,B);if(C.value===M)C=k(B);else if(typeof C.value==="function"){C.method=true;"prototype"in C.value&&D(C.value.prototype)}else{C.get&&C.get.prototype&&D(C.get.prototype);C.set&&C.set.prototype&&D(C.set.prototype)}y[B]=C});return y}function h(){var z=A(arguments,
0),y={};E(z,function(B){E(G(B),function(C){var F=B[C];if(x(y,C)&&!y[C].required)F.required||b(y[C],F)||(y[C]=e(C));else y[C]=F})});return D(y)}function l(z,y){var B=g(z),C={};E(G(y),function(F){C[F]=!x(B,F)||y[F].required?y[F]:k(F)});return D(C)}function i(){var z=A(arguments,0),y={};E(z,function(B){E(G(B),function(C){var F=B[C];if(!x(y,C)||y[C].required)y[C]=F})});return D(y)}function j(z,y){var B={};E(G(y),function(C){if(x(z,C)&&!y[C].required){var F=z[C];B[F]=x(B,F)&&!B[F].required?e(F):y[C];x(B,
C)||(B[C]=k(C))}else if(x(B,C))y[C].required||(B[C]=e(C));else B[C]=y[C]});return D(B)}function s(z,y){var B={},C=[];for(var F in z)if(x(z,F))if(z[F])B[F]=z[F];else C.push(F);return j(B,l(C,y))}function q(z,y){var B=L(z),C={};E(G(y),function(F){var I=y[F];if(I.required&&!(F in z))throw new Error("Missing required property: "+F);else if(I.conflict)throw new Error("Remaining conflicting property: "+F);else C[F]="value"in I?I.method?{value:a(I.value,B),enumerable:I.enumerable,configurable:I.configurable,
writable:I.writable}:I:{get:I.get?a(I.get,B):undefined,set:I.set?a(I.set,B):undefined,enumerable:I.enumerable,configurable:I.configurable,writable:I.writable}});K(B,C);return D(B)}function o(z,y){return q(Object.prototype,f(z),y)}function r(z,y){var B=G(z),C=G(y);if(B.length!==C.length)return false;for(var F=0;F<B.length;F++){C=B[F];if(!y[C]||!b(z[C],y[C]))return false}return true}function v(z){return f(z)}var p=!!Object.defineProperty,u=Function.prototype.call,w=Function.prototype.bind?function(z,
y){return Function.prototype.bind.call(z,y)}:function(z,y){function B(){return z.apply(y,arguments)}return B},x=w(u,Object.prototype.hasOwnProperty),A=w(u,Array.prototype.slice),E=Array.prototype.forEach?w(u,Array.prototype.forEach):function(z,y){for(var B=0,C=z.length;B<C;B++)y(z[B])},D=Object.freeze||function(z){return z},G=Object.getOwnPropertyNames||function(z){var y=[];for(var B in z)x(z,B)&&y.push(B);return y},H=Object.getOwnPropertyDescriptor||function(z,y){return{value:z[y],enumerable:true,
writable:true,configurable:true}},J=Object.defineProperty||function(z,y,B){z[y]=B.value},K=Object.defineProperties||function(z,y){for(var B in y)x(y,B)&&J(z,B,y[B])},L=Object.create||function(z,y){function B(){}B.prototype=z||Object.prototype;z=new B;y&&K(z,y);return z};u=Object.getOwnProperties||function(z){var y={};E(G(z),function(B){y[B]=H(z,B)});return y};var M=D({toString:function(){return"<Trait.required>"}});if(!Object.create)Object.create=L;if(!Object.getOwnProperties)Object.getOwnProperties=
u;v.required=D(M);v.compose=D(h);v.resolve=D(s);v.override=D(i);v.create=D(q);v.eqv=D(r);v.object=D(o);return D(v)}()});bespin.tiki.register("::keyboard",{name:"keyboard",dependencies:{canon:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("keyboard:keyboard",function(t,m){var n=t("bespin:plugins").catalog;t("bespin:console");t("bespin:util/stacktrace");var k=t("bespin:util/util"),e=t("settings").settings,d=t("keyboard:keyutil"),b=t("canon:history"),a=t("canon:request").Request,g=t("canon:environment");m.buildFlags=function(f,h){h.context=f.contexts[0];return h};t=function(){};k.mixin(t.prototype,{_customKeymappingCache:{states:{}},processKeyEvent:function(f,h,l){f=d.commandCodes(f,true)[0];if(k.none(f))return false;
m.buildFlags(g.global,l);l.isCommandKey=true;return this._matchCommand(f,h,l)},processKeyInput:function(f,h,l){l.isCommandKey=false;return this._matchCommand(f,h,l)},_matchCommand:function(f,h,l){var i=this._findCommandExtension(f,h,l);if(i&&i.commandExt!=="no command"){l.isTextView&&h.resetKeyBuffers();var j=i.commandExt;j.load(function(s){s=new a({command:s,commandExt:j});b.execute(g.global,i.args,s)});return true}return i&&i.commandExt==="no command"?true:false},_buildBindingsRegex:function(f){f.forEach(function(h){if(k.none(h.key))if(Array.isArray(h.regex)){h.key=
new RegExp("^"+h.regex[1]+"$");h.regex=new RegExp(h.regex.join("")+"$")}else h.regex=new RegExp(h.regex+"$");else h.key=new RegExp("^"+h.key+"$")})},_buildKeymappingRegex:function(f){for(state in f.states)this._buildBindingsRegex(f.states[state]);f._convertedRegExp=true},_findCommandExtension:function(f,h,l){if(l.isTextView){var i=h._keyState;if(!l.isCommandKey||f.indexOf("alt_")===-1){h._keyBuffer+=f.replace(/ctrl_meta|meta/,"ctrl");h._keyMetaBuffer+=f}var j=[this._customKeymappingCache];j=j.concat(n.getExtensions("keymapping"));
for(var s=0;s<j.length;s++)if(!k.none(j[s].states[i])){k.none(j[s]._convertedRegExp)&&this._buildKeymappingRegex(j[s]);var q=this._bindingsMatch(f,l,h,j[s]);if(!k.none(q))return q}}h=n.getExtensions("command");var o=null;i={};f=f.replace(/ctrl_meta|meta/,"ctrl");h.some(function(r){if(this._commandMatches(r,f,l)){o=r;return true}return false}.bind(this));return k.none(o)?null:{commandExt:o,args:i}},_bindingsMatch:function(f,h,l,i){var j,s=null,q={},o;o=k.none(i.hasMetaKey)?l._keyMetaBuffer:l._keyBuffer;
if(f.indexOf("alt_")===0&&h.isCommandKey)o+=f;i.states[l._keyState].some(function(r){if(r.key&&!r.key.test(f))return false;if(r.regex&&!(j=r.regex.exec(o)))return false;if(r.disallowMatches)for(var v=0;v<r.disallowMatches.length;v++)if(j[r.disallowMatches[v]])return true;if(!m.flagsMatch(r.predicates,h))return false;if(r.exec){s=n.getExtensionByKey("command",r.exec);if(k.none(s))throw new Error("Can't find command "+r.exec+" in state="+l._keyState+", symbolicName="+f);if(r.params){var p;r.params.forEach(function(u){p=
!k.none(u.match)&&!k.none(j)?j[u.match]||u.defaultValue:u.defaultValue;if(u.type==="number")p=parseInt(p);q[u.name]=p})}l.resetKeyBuffers()}if(r.then){l._keyState=r.then;l.resetKeyBuffers()}if(k.none(s))s="no command";return true});if(k.none(s))return null;return{commandExt:s,args:q}},_commandMatches:function(f,h,l){var i=f.key;if(!i)return false;if(!m.flagsMatch(f.predicates,l))return false;if(typeof i==="string"){if(i!=h)return false;return true}if(!Array.isArray(i)){i=[i];f.key=i}for(f=0;f<i.length;f++){var j=
i[f];if(typeof j==="string"){if(j==h)return true}else if(j.key==h)return m.flagsMatch(j.predicates,l)}return false},_customKeymappingChanged:function(){var f=this._customKeymappingCache=JSON.parse(e.get("customKeymapping"));f.states=f.states||{};for(state in f.states)this._buildBindingsRegex(f.states[state])}});m.flagsMatch=function(f,h){if(k.none(f))return true;if(!h)return false;for(var l in f)if(h[l]!==f[l])return false;return true};m.keyboardManager=new t});
bespin.tiki.module("keyboard:keyutil",function(t,m){var n=t("bespin:util/util");m.KeyHelper=function(){var e={MODIFIER_KEYS:{16:"shift",17:"ctrl",18:"alt",224:"meta"},FUNCTION_KEYS:{8:"backspace",9:"tab",13:"return",19:"pause",27:"escape",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",44:"printscreen",45:"insert",46:"delete",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock"},PRINTABLE_KEYS:{32:" ",
48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",59:";",61:"=",65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",107:"+",109:"-",110:".",188:",",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:'"'},PRINTABLE_KEYS_CHARCODE:{},KEY:{}};for(var d in e.PRINTABLE_KEYS){var b=e.PRINTABLE_KEYS[d];e.PRINTABLE_KEYS_CHARCODE[b.charCodeAt(0)]=d;if(b.toUpperCase()!=
b)e.PRINTABLE_KEYS_CHARCODE[b.toUpperCase().charCodeAt(0)]=d}for(d in e.FUNCTION_KEYS){b=e.FUNCTION_KEYS[d].toUpperCase();e.KEY[b]=parseInt(d,10)}return e}();var k=function(e){return!!(e.altKey||e.ctrlKey||e.metaKey||e.charCode!==e.which&&m.KeyHelper.FUNCTION_KEYS[e.which])};m.commandCodes=function(e,d){var b=e._keyCode||e.keyCode,a=e._charCode===undefined?e.charCode:e._charCode,g=null,f=null,h="",l=true;if(b===0&&e.which===0)return false;if(a!==0)return false;if(m.KeyHelper.MODIFIER_KEYS[a])return[m.KeyHelper.MODIFIER_KEYS[a],
null];if(b){g=m.KeyHelper.FUNCTION_KEYS[b];if(!g&&(e.altKey||e.ctrlKey||e.metaKey)){g=m.KeyHelper.PRINTABLE_KEYS[b];if(b>47&&b<58)l=e.altKey}if(g){if(e.altKey)h+="alt_";if(e.ctrlKey)h+="ctrl_";if(e.metaKey)h+="meta_"}else if(e.ctrlKey||e.metaKey)return false}if(!g){b=e.which;f=g=String.fromCharCode(b);b=g.toLowerCase();if(e.metaKey){h="meta_";g=b}else g=null}if(e.shiftKey&&g&&l)h+="shift_";if(g)g=h+g;if(!d&&g)g=g.replace(/ctrl_meta|meta/,"ctrl");return[g,f]};m.addKeyDownListener=function(e,d){var b=
function(a){var g=d(a);g&&n.stopEvent(a);return g};e.addEventListener("keydown",function(a){if(n.isMozilla)if(m.KeyHelper.FUNCTION_KEYS[a.keyCode])return true;else if((a.ctrlKey||a.metaKey)&&m.KeyHelper.PRINTABLE_KEYS[a.keyCode])return true;if(k(a))return b(a);return true},false);e.addEventListener("keypress",function(a){if(n.isMozilla)if(m.KeyHelper.FUNCTION_KEYS[a.keyCode])return b(a);else if((a.ctrlKey||a.metaKey)&&m.KeyHelper.PRINTABLE_KEYS_CHARCODE[a.charCode]){a._keyCode=m.KeyHelper.PRINTABLE_KEYS_CHARCODE[a.charCode];
a._charCode=0;return b(a)}if(a.charCode!==undefined&&a.charCode===0)return true;return b(a)},false)}});bespin.tiki.module("keyboard:index",function(){});bespin.tiki.register("::worker_manager",{name:"worker_manager",dependencies:{events:"0.0.0",underscore:"0.0.0"}});
bespin.tiki.module("worker_manager:index",function(t,m){function n(d){var b=/^([^#:]+)(?::([^#:]+))?#([^#:]+)$/.exec(d);if(b==null)throw new Error('WorkerManager: invalid pointer specification: "'+d+'"');d=b[1];var a=b[3];b=d+":"+(b[2]!=null?b[2]:"index");var g=bespin!=null&&bespin.base!=null?bespin.base:"",f=new Worker(g+"BespinEmbedded.js");f.onmessage=this._onMessage.bind(this);f.onerror=this._onError.bind(this);f.postMessage(JSON.stringify({op:"load",base:g,pkg:d,module:b,target:a}));this._worker=
f;this._currentId=0}if(window==null)throw new Error('The "worker_manager" plugin can only be loaded in the browser, not a web worker. Use "worker" instead.');t("bespin:plugins");var k=t("bespin:console").console;t("events");var e=t("bespin:promise").Promise;n.prototype={_onError:function(d){k.error("Web worker failed at file "+d.filename+":"+d.lineno)},_onMessage:function(d){d=JSON.parse(d.data);switch(d.op){case "finish":if(d.id===this._currentId){var b=this._promise;this._promise=null;b.resolve(d.result)}break;
case "log":k[d.method].apply(k,d.args);break}},_promise:null,kill:function(){var d=this._promise;if(d!=null){d.reject("killed");this._promise=null}this._worker.terminate();this._worker=null},send:function(d,b){var a=this._promise;if(a!=null){a.reject("interrupted");this._currentId++}a=this._currentId;var g=new e;this._promise=g;this._worker.postMessage(JSON.stringify({op:"invoke",id:a,method:d,args:b}));return g}};m.WorkerManager=n});bespin.tiki.register("::diff",{name:"diff",dependencies:{}});
bespin.tiki.module("diff:index",function(t,m){function n(){function e(){for(var d=0,b=1,a=2;b!=a;){d++;b=a;a<<=1}return d}this.Diff_Timeout=1;this.Diff_EditCost=4;this.Diff_DualThreshold=32;this.Match_Threshold=0.5;this.Match_Distance=1E3;this.Patch_DeleteThreshold=0.5;this.Patch_Margin=4;this.Match_MaxBits=e()}function k(){this.diffs=[];this.start2=this.start1=null;this.length2=this.length1=0}n.prototype.diff_main=function(e,d,b){if(e==d)return[[0,e]];if(typeof b=="undefined")b=true;var a=b,g=this.diff_commonPrefix(e,
d);b=e.substring(0,g);e=e.substring(g);d=d.substring(g);g=this.diff_commonSuffix(e,d);var f=e.substring(e.length-g);e=e.substring(0,e.length-g);d=d.substring(0,d.length-g);e=this.diff_compute(e,d,a);b&&e.unshift([0,b]);f&&e.push([0,f]);this.diff_cleanupMerge(e);return e};n.prototype.diff_compute=function(e,d,b){var a;if(!e)return[[1,d]];if(!d)return[[-1,e]];a=e.length>d.length?e:d;var g=e.length>d.length?d:e,f=a.indexOf(g);if(f!=-1){a=[[1,a.substring(0,f)],[0,g],[1,a.substring(f+g.length)]];if(e.length>
d.length)a[0][0]=a[2][0]=-1;return a}if(a=this.diff_halfMatch(e,d)){d=a[1];var h=a[3];e=a[4];a=this.diff_main(a[0],a[2],b);b=this.diff_main(d,h,b);return a.concat([[0,e]],b)}if(b&&(e.length<100||d.length<100))b=false;if(b){h=this.diff_linesToChars(e,d);e=h[0];d=h[1];h=h[2]}(a=this.diff_map(e,d))||(a=[[-1,e],[1,d]]);if(b){this.diff_charsToLines(a,h);this.diff_cleanupSemantic(a);a.push([0,""]);d=e=b=0;for(g=h="";b<a.length;){switch(a[b][0]){case 1:d++;g+=a[b][1];break;case -1:e++;h+=a[b][1];break;case 0:if(e>=
1&&d>=1){h=this.diff_main(h,g,false);a.splice(b-e-d,e+d);b=b-e-d;for(e=h.length-1;e>=0;e--)a.splice(b,0,h[e]);b+=h.length}e=d=0;g=h="";break}b++}a.pop()}return a};n.prototype.diff_linesToChars=function(e,d){function b(f){for(var h="",l=0,i=-1,j=a.length;i<f.length-1;){i=f.indexOf("\n",l);if(i==-1)i=f.length-1;var s=f.substring(l,i+1);l=i+1;if(g.hasOwnProperty?g.hasOwnProperty(s):g[s]!==undefined)h+=String.fromCharCode(g[s]);else{h+=String.fromCharCode(j);g[s]=j;a[j++]=s}}return h}var a=[],g={};a[0]=
"";e=b(e);d=b(d);return[e,d,a]};n.prototype.diff_charsToLines=function(e,d){for(var b=0;b<e.length;b++){for(var a=e[b][1],g=[],f=0;f<a.length;f++)g[f]=d[a.charCodeAt(f)];e[b][1]=g.join("")}};n.prototype.diff_map=function(e,d){var b=(new Date).getTime()+this.Diff_Timeout*1E3,a=e.length,g=d.length,f=a+g-1,h=this.Diff_DualThreshold*2<f,l=[],i=[],j={},s={};j[1]=0;s[1]=0;for(var q,o,r,v={},p=false,u=!!v.hasOwnProperty,w=(a+g)%2,x=0;x<f;x++){if(this.Diff_Timeout>0&&(new Date).getTime()>b)return null;l[x]=
{};for(var A=-x;A<=x;A+=2){q=A==-x||A!=x&&j[A-1]<j[A+1]?j[A+1]:j[A-1]+1;o=q-A;if(h){r=q+","+o;if(w&&(u?v.hasOwnProperty(r):v[r]!==undefined))p=true;w||(v[r]=x)}for(;!p&&q<a&&o<g&&e.charAt(q)==d.charAt(o);){q++;o++;if(h){r=q+","+o;if(w&&(u?v.hasOwnProperty(r):v[r]!==undefined))p=true;w||(v[r]=x)}}j[A]=q;l[x][q+","+o]=true;if(q==a&&o==g)return this.diff_path1(l,e,d);else if(p){i=i.slice(0,v[r]+1);b=this.diff_path1(l,e.substring(0,q),d.substring(0,o));return b.concat(this.diff_path2(i,e.substring(q),
d.substring(o)))}}if(h){i[x]={};for(A=-x;A<=x;A+=2){q=A==-x||A!=x&&s[A-1]<s[A+1]?s[A+1]:s[A-1]+1;o=q-A;r=a-q+","+(g-o);if(!w&&(u?v.hasOwnProperty(r):v[r]!==undefined))p=true;if(w)v[r]=x;for(;!p&&q<a&&o<g&&e.charAt(a-q-1)==d.charAt(g-o-1);){q++;o++;r=a-q+","+(g-o);if(!w&&(u?v.hasOwnProperty(r):v[r]!==undefined))p=true;if(w)v[r]=x}s[A]=q;i[x][q+","+o]=true;if(p){l=l.slice(0,v[r]+1);b=this.diff_path1(l,e.substring(0,a-q),d.substring(0,g-o));return b.concat(this.diff_path2(i,e.substring(a-q),d.substring(g-
o)))}}}}return null};n.prototype.diff_path1=function(e,d,b){for(var a=[],g=d.length,f=b.length,h=null,l=e.length-2;l>=0;l--)for(;;)if(e[l].hasOwnProperty?e[l].hasOwnProperty(g-1+","+f):e[l][g-1+","+f]!==undefined){g--;if(h===-1)a[0][1]=d.charAt(g)+a[0][1];else a.unshift([-1,d.charAt(g)]);h=-1;break}else if(e[l].hasOwnProperty?e[l].hasOwnProperty(g+","+(f-1)):e[l][g+","+(f-1)]!==undefined){f--;if(h===1)a[0][1]=b.charAt(f)+a[0][1];else a.unshift([1,b.charAt(f)]);h=1;break}else{g--;f--;if(h===0)a[0][1]=
d.charAt(g)+a[0][1];else a.unshift([0,d.charAt(g)]);h=0}return a};n.prototype.diff_path2=function(e,d,b){for(var a=[],g=0,f=d.length,h=b.length,l=null,i=e.length-2;i>=0;i--)for(;;)if(e[i].hasOwnProperty?e[i].hasOwnProperty(f-1+","+h):e[i][f-1+","+h]!==undefined){f--;if(l===-1)a[g-1][1]+=d.charAt(d.length-f-1);else a[g++]=[-1,d.charAt(d.length-f-1)];l=-1;break}else if(e[i].hasOwnProperty?e[i].hasOwnProperty(f+","+(h-1)):e[i][f+","+(h-1)]!==undefined){h--;if(l===1)a[g-1][1]+=b.charAt(b.length-h-1);
else a[g++]=[1,b.charAt(b.length-h-1)];l=1;break}else{f--;h--;if(l===0)a[g-1][1]+=d.charAt(d.length-f-1);else a[g++]=[0,d.charAt(d.length-f-1)];l=0}return a};n.prototype.diff_commonPrefix=function(e,d){if(!e||!d||e.charCodeAt(0)!==d.charCodeAt(0))return 0;for(var b=0,a=Math.min(e.length,d.length),g=a,f=0;b<g;){if(e.substring(f,g)==d.substring(f,g))f=b=g;else a=g;g=Math.floor((a-b)/2+b)}return g};n.prototype.diff_commonSuffix=function(e,d){if(!e||!d||e.charCodeAt(e.length-1)!==d.charCodeAt(d.length-
1))return 0;for(var b=0,a=Math.min(e.length,d.length),g=a,f=0;b<g;){if(e.substring(e.length-g,e.length-f)==d.substring(d.length-g,d.length-f))f=b=g;else a=g;g=Math.floor((a-b)/2+b)}return g};n.prototype.diff_halfMatch=function(e,d){function b(l,i,j){for(var s=l.substring(j,j+Math.floor(l.length/4)),q=-1,o="",r,v,p,u;(q=i.indexOf(s,q+1))!=-1;){var w=f.diff_commonPrefix(l.substring(j),i.substring(q)),x=f.diff_commonSuffix(l.substring(0,j),i.substring(0,q));if(o.length<x+w){o=i.substring(q-x,q)+i.substring(q,
q+w);r=l.substring(0,j-x);v=l.substring(j+w);p=i.substring(0,q-x);u=i.substring(q+w)}}return o.length>=l.length/2?[r,v,p,u,o]:null}var a=e.length>d.length?e:d,g=e.length>d.length?d:e;if(a.length<10||g.length<1)return null;var f=this,h=b(a,g,Math.ceil(a.length/4));a=b(a,g,Math.ceil(a.length/2));if(!h&&!a)return null;else h=a?h?h[4].length>a[4].length?h:a:a:h;if(e.length>d.length){e=h[0];d=h[1];a=h[2];g=h[3]}else{a=h[0];g=h[1];e=h[2];d=h[3]}return[e,d,a,g,h[4]]};n.prototype.diff_cleanupSemantic=function(e){for(var d=
false,b=[],a=0,g=null,f=0,h=0,l=0;f<e.length;){if(e[f][0]==0){b[a++]=f;h=l;l=0;g=e[f][1]}else{l+=e[f][1].length;if(g!==null&&g.length<=h&&g.length<=l){e.splice(b[a-1],0,[-1,g]);e[b[a-1]+1][0]=1;a--;a--;f=a>0?b[a-1]:-1;l=h=0;g=null;d=true}}f++}d&&this.diff_cleanupMerge(e);this.diff_cleanupSemanticLossless(e)};n.prototype.diff_cleanupSemanticLossless=function(e){function d(u,w){if(!u||!w)return 5;var x=0;if(u.charAt(u.length-1).match(b)||w.charAt(0).match(b)){x++;if(u.charAt(u.length-1).match(a)||w.charAt(0).match(a)){x++;
if(u.charAt(u.length-1).match(g)||w.charAt(0).match(g)){x++;if(u.match(f)||w.match(h))x++}}}return x}for(var b=/[^a-zA-Z0-9]/,a=/\s/,g=/[\r\n]/,f=/\n\r?\n$/,h=/^\r?\n\r?\n/,l=1;l<e.length-1;){if(e[l-1][0]==0&&e[l+1][0]==0){var i=e[l-1][1],j=e[l][1],s=e[l+1][1],q=this.diff_commonSuffix(i,j);if(q){var o=j.substring(j.length-q);i=i.substring(0,i.length-q);j=o+j.substring(0,j.length-q);s=o+s}q=i;o=j;for(var r=s,v=d(i,j)+d(j,s);j.charAt(0)===s.charAt(0);){i+=j.charAt(0);j=j.substring(1)+s.charAt(0);s=
s.substring(1);var p=d(i,j)+d(j,s);if(p>=v){v=p;q=i;o=j;r=s}}if(e[l-1][1]!=q){if(q)e[l-1][1]=q;else{e.splice(l-1,1);l--}e[l][1]=o;if(r)e[l+1][1]=r;else{e.splice(l+1,1);l--}}}l++}};n.prototype.diff_cleanupEfficiency=function(e){for(var d=false,b=[],a=0,g="",f=0,h=false,l=false,i=false,j=false;f<e.length;){if(e[f][0]==0){if(e[f][1].length<this.Diff_EditCost&&(i||j)){b[a++]=f;h=i;l=j;g=e[f][1]}else{a=0;g=""}i=j=false}else{if(e[f][0]==-1)j=true;else i=true;if(g&&(h&&l&&i&&j||g.length<this.Diff_EditCost/
2&&h+l+i+j==3)){e.splice(b[a-1],0,[-1,g]);e[b[a-1]+1][0]=1;a--;g="";if(h&&l){i=j=true;a=0}else{a--;f=a>0?b[a-1]:-1;i=j=false}d=true}}f++}d&&this.diff_cleanupMerge(e)};n.prototype.diff_cleanupMerge=function(e){e.push([0,""]);for(var d=0,b=0,a=0,g="",f="",h;d<e.length;)switch(e[d][0]){case 1:a++;f+=e[d][1];d++;break;case -1:b++;g+=e[d][1];d++;break;case 0:if(b!==0||a!==0){if(b!==0&&a!==0){h=this.diff_commonPrefix(f,g);if(h!==0){if(d-b-a>0&&e[d-b-a-1][0]==0)e[d-b-a-1][1]+=f.substring(0,h);else{e.splice(0,
0,[0,f.substring(0,h)]);d++}f=f.substring(h);g=g.substring(h)}h=this.diff_commonSuffix(f,g);if(h!==0){e[d][1]=f.substring(f.length-h)+e[d][1];f=f.substring(0,f.length-h);g=g.substring(0,g.length-h)}}if(b===0)e.splice(d-b-a,b+a,[1,f]);else a===0?e.splice(d-b-a,b+a,[-1,g]):e.splice(d-b-a,b+a,[-1,g],[1,f]);d=d-b-a+(b?1:0)+(a?1:0)+1}else if(d!==0&&e[d-1][0]==0){e[d-1][1]+=e[d][1];e.splice(d,1)}else d++;b=a=0;f=g="";break}e[e.length-1][1]===""&&e.pop();b=false;for(d=1;d<e.length-1;){if(e[d-1][0]==0&&e[d+
1][0]==0)if(e[d][1].substring(e[d][1].length-e[d-1][1].length)==e[d-1][1]){e[d][1]=e[d-1][1]+e[d][1].substring(0,e[d][1].length-e[d-1][1].length);e[d+1][1]=e[d-1][1]+e[d+1][1];e.splice(d-1,1);b=true}else if(e[d][1].substring(0,e[d+1][1].length)==e[d+1][1]){e[d-1][1]+=e[d+1][1];e[d][1]=e[d][1].substring(e[d+1][1].length)+e[d+1][1];e.splice(d+1,1);b=true}d++}b&&this.diff_cleanupMerge(e)};n.prototype.diff_xIndex=function(e,d){var b=0,a=0,g=0,f=0,h;for(h=0;h<e.length;h++){if(e[h][0]!==1)b+=e[h][1].length;
if(e[h][0]!==-1)a+=e[h][1].length;if(b>d)break;g=b;f=a}if(e.length!=h&&e[h][0]===-1)return f;return f+(d-g)};n.prototype.diff_prettyHtml=function(e){for(var d=[],b=0,a=0;a<e.length;a++){var g=e[a][0],f=e[a][1],h=f.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"&para;<BR>");switch(g){case 1:d[a]='<INS STYLE="background:#E6FFE6;" TITLE="i='+b+'">'+h+"</INS>";break;case -1:d[a]='<DEL STYLE="background:#FFE6E6;" TITLE="i='+b+'">'+h+"</DEL>";break;case 0:d[a]='<SPAN TITLE="i='+
b+'">'+h+"</SPAN>";break}if(g!==-1)b+=f.length}return d.join("")};n.prototype.diff_text1=function(e){for(var d=[],b=0;b<e.length;b++)if(e[b][0]!==1)d[b]=e[b][1];return d.join("")};n.prototype.diff_text2=function(e){for(var d=[],b=0;b<e.length;b++)if(e[b][0]!==-1)d[b]=e[b][1];return d.join("")};n.prototype.diff_levenshtein=function(e){for(var d=0,b=0,a=0,g=0;g<e.length;g++){var f=e[g][1];switch(e[g][0]){case 1:b+=f.length;break;case -1:a+=f.length;break;case 0:d+=Math.max(b,a);a=b=0;break}}d+=Math.max(b,
a);return d};n.prototype.diff_toDelta=function(e){for(var d=[],b=0;b<e.length;b++)switch(e[b][0]){case 1:d[b]="+"+encodeURI(e[b][1]);break;case -1:d[b]="-"+e[b][1].length;break;case 0:d[b]="="+e[b][1].length;break}return d.join("\t").replace(/\x00/g,"%00").replace(/%20/g," ")};n.prototype.diff_fromDelta=function(e,d){var b=[],a=0,g=0;d=d.replace(/%00/g,"\u0000");d=d.split(/\t/g);for(var f=0;f<d.length;f++){var h=d[f].substring(1);switch(d[f].charAt(0)){case "+":try{b[a++]=[1,decodeURI(h)]}catch(l){throw new Error("Illegal escape in diff_fromDelta: "+
h);}break;case "-":case "=":var i=parseInt(h,10);if(isNaN(i)||i<0)throw new Error("Invalid number in diff_fromDelta: "+h);h=e.substring(g,g+=i);if(d[f].charAt(0)=="=")b[a++]=[0,h];else b[a++]=[-1,h];break;default:if(d[f])throw new Error("Invalid diff operation in diff_fromDelta: "+d[f]);}}if(g!=e.length)throw new Error("Delta length ("+g+") does not equal source text length ("+e.length+").");return b};n.prototype.match_main=function(e,d,b){b=Math.max(0,Math.min(b,e.length));return e==d?0:e.length?
e.substring(b,b+d.length)==d?b:this.match_bitap(e,d,b):-1};n.prototype.match_bitap=function(e,d,b){function a(u,w){u=u/d.length;w=Math.abs(b-w);if(!f.Match_Distance)return w?1:u;return u+w/f.Match_Distance}if(d.length>this.Match_MaxBits)throw new Error("Pattern too long for this browser.");var g=this.match_alphabet(d),f=this,h=this.Match_Threshold,l=e.indexOf(d,b);if(l!=-1)h=Math.min(a(0,l),h);l=e.lastIndexOf(d,b+d.length);if(l!=-1)h=Math.min(a(0,l),h);var i=1<<d.length-1;l=-1;for(var j,s,q=d.length+
e.length,o,r=0;r<d.length;r++){j=0;for(s=q;j<s;){if(a(r,b+s)<=h)j=s;else q=s;s=Math.floor((q-j)/2+j)}q=s;j=Math.max(1,b-s+1);var v=Math.min(b+s,e.length)+d.length;s=Array(v+2);s[v+1]=(1<<r)-1;for(v=v;v>=j;v--){var p=g[e.charAt(v-1)];s[v]=r===0?(s[v+1]<<1|1)&p:(s[v+1]<<1|1)&p|(o[v+1]|o[v])<<1|1|o[v+1];if(s[v]&i){p=a(r,v-1);if(p<=h){h=p;l=v-1;if(l>b)j=Math.max(1,2*b-l);else break}}}if(a(r+1,b)>h)break;o=s}return l};n.prototype.match_alphabet=function(e){for(var d={},b=0;b<e.length;b++)d[e.charAt(b)]=
0;for(b=0;b<e.length;b++)d[e.charAt(b)]|=1<<e.length-b-1;return d};n.prototype.patch_addContext=function(e,d){for(var b=d.substring(e.start2,e.start2+e.length1),a=0;d.indexOf(b)!=d.lastIndexOf(b)&&b.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;){a+=this.Patch_Margin;b=d.substring(e.start2-a,e.start2+e.length1+a)}a+=this.Patch_Margin;(b=d.substring(e.start2-a,e.start2))&&e.diffs.unshift([0,b]);(d=d.substring(e.start2+e.length1,e.start2+e.length1+a))&&e.diffs.push([0,d]);e.start1-=
b.length;e.start2-=b.length;e.length1+=b.length+d.length;e.length2+=b.length+d.length};n.prototype.patch_make=function(e,d,b){var a;if(typeof e=="string"&&typeof d=="string"&&typeof b=="undefined"){a=e;d=this.diff_main(a,d,true);if(d.length>2){this.diff_cleanupSemantic(d);this.diff_cleanupEfficiency(d)}}else if(typeof e=="object"&&typeof d=="undefined"&&typeof b=="undefined"){d=e;a=this.diff_text1(d)}else if(typeof e=="string"&&typeof d=="object"&&typeof b=="undefined"){a=e;d=d}else if(typeof e==
"string"&&typeof d=="string"&&typeof b=="object"){a=e;d=b}else throw new Error("Unknown call format to patch_make.");if(d.length===0)return[];b=[];e=new k;var g=0,f=0,h=0,l=a;a=a;for(var i=0;i<d.length;i++){var j=d[i][0],s=d[i][1];if(!g&&j!==0){e.start1=f;e.start2=h}switch(j){case 1:e.diffs[g++]=d[i];e.length2+=s.length;a=a.substring(0,h)+s+a.substring(h);break;case -1:e.length1+=s.length;e.diffs[g++]=d[i];a=a.substring(0,h)+a.substring(h+s.length);break;case 0:if(s.length<=2*this.Patch_Margin&&g&&
d.length!=i+1){e.diffs[g++]=d[i];e.length1+=s.length;e.length2+=s.length}else if(s.length>=2*this.Patch_Margin)if(g){this.patch_addContext(e,l);b.push(e);e=new k;g=0;l=a;f=h}break}if(j!==1)f+=s.length;if(j!==-1)h+=s.length}if(g){this.patch_addContext(e,l);b.push(e)}return b};n.prototype.patch_deepCopy=function(e){for(var d=[],b=0;b<e.length;b++){var a=e[b],g=new k;g.diffs=[];for(var f=0;f<a.diffs.length;f++)g.diffs[f]=a.diffs[f].slice();g.start1=a.start1;g.start2=a.start2;g.length1=a.length1;g.length2=
a.length2;d[b]=g}return d};n.prototype.patch_apply=function(e,d){if(e.length==0)return[d,[]];e=this.patch_deepCopy(e);var b=this.patch_addPadding(e);d=b+d+b;this.patch_splitMax(e);for(var a=0,g=[],f=0;f<e.length;f++){var h=e[f].start2+a,l=this.diff_text1(e[f].diffs),i,j=-1;if(l.length>this.Match_MaxBits){i=this.match_main(d,l.substring(0,this.Match_MaxBits),h);if(i!=-1){j=this.match_main(d,l.substring(l.length-this.Match_MaxBits),h+l.length-this.Match_MaxBits);if(j==-1||i>=j)i=-1}}else i=this.match_main(d,
l,h);if(i==-1)g[f]=false;else{g[f]=true;a=i-h;h=j==-1?d.substring(i,i+l.length):d.substring(i,j+this.Match_MaxBits);if(l==h)d=d.substring(0,i)+this.diff_text2(e[f].diffs)+d.substring(i+l.length);else{h=this.diff_main(l,h,false);if(l.length>this.Match_MaxBits&&this.diff_levenshtein(h)/l.length>this.Patch_DeleteThreshold)g[f]=false;else{this.diff_cleanupSemanticLossless(h);l=0;var s;for(j=0;j<e[f].diffs.length;j++){var q=e[f].diffs[j];if(q[0]!==0)s=this.diff_xIndex(h,l);if(q[0]===1)d=d.substring(0,
i+s)+q[1]+d.substring(i+s);else if(q[0]===-1)d=d.substring(0,i+s)+d.substring(i+this.diff_xIndex(h,l+q[1].length));if(q[0]!==-1)l+=q[1].length}}}}}d=d.substring(b.length,d.length-b.length);return[d,g]};n.prototype.patch_addPadding=function(e){for(var d="",b=1;b<=this.Patch_Margin;b++)d+=String.fromCharCode(b);for(b=0;b<e.length;b++){e[b].start1+=d.length;e[b].start2+=d.length}b=e[0];var a=b.diffs;if(a.length==0||a[0][0]!=0){a.unshift([0,d]);b.start1-=d.length;b.start2-=d.length;b.length1+=d.length;
b.length2+=d.length}else if(d.length>a[0][1].length){var g=d.length-a[0][1].length;a[0][1]=d.substring(a[0][1].length)+a[0][1];b.start1-=g;b.start2-=g;b.length1+=g;b.length2+=g}b=e[e.length-1];a=b.diffs;if(a.length==0||a[a.length-1][0]!=0){a.push([0,d]);b.length1+=d.length;b.length2+=d.length}else if(d.length>a[a.length-1][1].length){g=d.length-a[a.length-1][1].length;a[a.length-1][1]+=d.substring(0,g);b.length1+=g;b.length2+=g}return d};n.prototype.patch_splitMax=function(e){for(var d=0;d<e.length;d++)if(e[d].length1>
this.Match_MaxBits){var b=e[d];e.splice(d--,1);for(var a=this.Match_MaxBits,g=b.start1,f=b.start2,h="";b.diffs.length!==0;){var l=new k,i=true;l.start1=g-h.length;l.start2=f-h.length;if(h!==""){l.length1=l.length2=h.length;l.diffs.push([0,h])}for(;b.diffs.length!==0&&l.length1<a-this.Patch_Margin;){h=b.diffs[0][0];var j=b.diffs[0][1];if(h===1){l.length2+=j.length;f+=j.length;l.diffs.push(b.diffs.shift());i=false}else if(h===-1&&l.diffs.length==1&&l.diffs[0][0]==0&&j.length>2*a){l.length1+=j.length;
g+=j.length;i=false;l.diffs.push([h,j]);b.diffs.shift()}else{j=j.substring(0,a-l.length1-this.Patch_Margin);l.length1+=j.length;g+=j.length;if(h===0){l.length2+=j.length;f+=j.length}else i=false;l.diffs.push([h,j]);if(j==b.diffs[0][1])b.diffs.shift();else b.diffs[0][1]=b.diffs[0][1].substring(j.length)}}h=this.diff_text2(l.diffs);h=h.substring(h.length-this.Patch_Margin);j=this.diff_text1(b.diffs).substring(0,this.Patch_Margin);if(j!==""){l.length1+=j.length;l.length2+=j.length;if(l.diffs.length!==
0&&l.diffs[l.diffs.length-1][0]===0)l.diffs[l.diffs.length-1][1]+=j;else l.diffs.push([0,j])}i||e.splice(++d,0,l)}}};n.prototype.patch_toText=function(e){for(var d=[],b=0;b<e.length;b++)d[b]=e[b];return d.join("")};n.prototype.patch_fromText=function(e){var d=[];if(!e)return d;e=e.replace(/%00/g,"\u0000");e=e.split("\n");for(var b=0;b<e.length;){var a=e[b].match(/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/);if(!a)throw new Error("Invalid patch string: "+e[b]);var g=new k;d.push(g);g.start1=parseInt(a[1],
10);if(a[2]===""){g.start1--;g.length1=1}else if(a[2]=="0")g.length1=0;else{g.start1--;g.length1=parseInt(a[2],10)}g.start2=parseInt(a[3],10);if(a[4]===""){g.start2--;g.length2=1}else if(a[4]=="0")g.length2=0;else{g.start2--;g.length2=parseInt(a[4],10)}for(b++;b<e.length;){a=e[b].charAt(0);try{var f=decodeURI(e[b].substring(1))}catch(h){throw new Error("Illegal escape in patch_fromText: "+f);}if(a=="-")g.diffs.push([-1,f]);else if(a=="+")g.diffs.push([1,f]);else if(a==" ")g.diffs.push([0,f]);else if(a==
"@")break;else if(a!=="")throw new Error('Invalid patch mode "'+a+'" in: '+f);b++}}return d};k.prototype.toString=function(){for(var e=["@@ -"+(this.length1===0?this.start1+",0":this.length1==1?this.start1+1:this.start1+1+","+this.length1)+" +"+(this.length2===0?this.start2+",0":this.length2==1?this.start2+1:this.start2+1+","+this.length2)+" @@\n"],d,b=0;b<this.diffs.length;b++){switch(this.diffs[b][0]){case 1:d="+";break;case -1:d="-";break;case 0:d=" ";break}e[b+1]=d+encodeURI(this.diffs[b][1])+
"\n"}return e.join("").replace(/\x00/g,"%00").replace(/%20/g," ")};m.diff_match_patch=n;m.DIFF_DELETE=-1;m.DIFF_INSERT=1;m.DIFF_EQUAL=0});bespin.tiki.register("::edit_session",{name:"edit_session",dependencies:{events:"0.0.0"}});
bespin.tiki.module("edit_session:index",function(t,m){t("bespin:promise");t("bespin:plugins");t("bespin:util/util");t("events");m.EditSession=function(){};m.EditSession.prototype={_currentView:null,currentUser:null,history:null,getCompletePath:function(n){if(n==null)n="";if(n==null||n.substring(0,1)!="/"){var k;if(this._currentView&&this._currentView.buffer)k=this._currentView.buffer;var e;if(k)e=k.file;n=e?e.parentdir()+n:"/"+n}return n}};Object.defineProperties(m.EditSession.prototype,{currentView:{set:function(n){if(n!==
this._currentView)this._currentView=n},get:function(){return this._currentView}}});m.createSession=function(n,k){var e=new m.EditSession;if(n)e.currentView=n.textView;if(k)e.currentUser=k;return e}});bespin.tiki.register("::syntax_manager",{name:"syntax_manager",dependencies:{worker_manager:"0.0.0",events:"0.0.0",underscore:"0.0.0",syntax_directory:"0.0.0"}});
bespin.tiki.module("syntax_manager:index",function(t,m){function n(f,h,l,i){for(;f.length<h;)f.push(d(i).clone());h=[h,l.length].concat(l);Array.prototype.splice.apply(f,h);return f}function k(f,h){this._syntaxInfo=f;this._syntaxManager=h;this._invalidRow=0;this._states=[];this._active=false}function e(f){this.layoutManager=f;this.syntaxChanged=new b;this._contextRanges=this._invalidRows=this._context=null;this._attrs=[];this._syntax="plain";this._reset()}var d=t("underscore")._,b=t("events").Event,
a=t("worker_manager").WorkerManager;t("bespin:console");t("rangeutils:utils/range");var g=t("syntax_directory").syntaxDirectory;k.prototype={_annotationFinished:function(f,h,l){if(this._active){this._syntaxManager.mergeAttrs(f,l.attrs);n(this._states,f,l.states);if(h>=this._getRowCount()){this._invalidRow=null;this._active=false}else{this._invalidRow=h;this.annotate()}}},_createWorker:function(){var f=this._syntaxInfo;if(f==null)return false;var h=new a("syntax_worker#syntaxWorker");this._worker=
h;h.send("loadSyntax",[f.name]);return true},_getRowCount:function(){return this._syntaxManager.getTextLines().length},annotate:function(){if(this._invalidRow==null)throw new Error("Attempt to annotate without any invalid row");if(this._worker==null)if(!this._createWorker())return;var f=this._syntaxManager.getTextLines(),h=this._invalidRow,l=h===0?this.getName()+":start":this._states[h],i=Math.min(f.length,h+100);f=f.slice(h,i);this._active=true;var j={start:{row:h,col:0},end:{row:i-1,col:d(f).last().length}};
this._worker.send("annotate",[l,f,j]).then(d(this._annotationFinished).bind(this,h,i))},contextsAtPosition:function(){var f=this._syntaxInfo;if(f==null)return["plain"];return[f.name]},cut:function(f){var h=this._getRowCount();if(f<0||f>=h)throw new Error("Attempt to cut the context at an invalid row");if(!(this._invalidRow!=null&&this._invalidRow<f)){this._invalidRow=f;this._active=false}},getName:function(){return this._syntaxInfo.name},kill:function(){var f=this._worker;if(f!=null){f.kill();this._worker=
null}}};e.prototype={_getTextStorage:function(){return this.layoutManager.textStorage},_reset:function(){var f=this._context;if(f!=null){f.kill();this._context=null}f=this._syntax;f=f==="plain"?null:g.get(f);this._context=f=new k(f,this);f.annotate()},syntaxChanged:null,contextsAtPosition:function(f){return this._context.contextsAtPosition(f)},getAttrsForRows:function(f,h){return this._attrs.slice(f,h)},getTextLines:function(){return this._getTextStorage().lines},invalidateRow:function(f){var h=this._context;
h.cut(f);h.annotate()},mergeAttrs:function(f,h){n(this._attrs,f,h,[]);this.syntaxChanged(f,f+h.length)},setSyntax:function(f){this._syntax=g.hasSyntax(f)?f:"plain";this._reset()},getSyntax:function(){return this._syntax},setSyntaxFromFileExt:function(f){return this.setSyntax(g.syntaxForFileExt(f))}};m.SyntaxManager=e});bespin.tiki.register("::undomanager",{name:"undomanager",dependencies:{}});
bespin.tiki.module("undomanager:index",function(t,m){t=t("bespin:util/util");m.UndoManager=function(){};t.mixin(m.UndoManager.prototype,{_redoStack:[],_undoStack:[],_undoOrRedo:function(n,k,e){if(k.length===0)return false;k=k.pop();if(!k.target[n](k.context)){this._redoStack=[];this._undoStack=[];return false}e.push(k);return true},redo:function(){return this._undoOrRedo("redo",this._redoStack,this._undoStack)},registerUndo:function(n,k){this._redoStack=[];this._undoStack.push({target:n,context:k})},
undo:function(){return this._undoOrRedo("undo",this._undoStack,this._redoStack)}});m.global=new m.UndoManager;m.undoManagerCommand=function(n,k,e){m.global[e.commandExt.name]()}});bespin.tiki.register("::command_line",{name:"command_line",dependencies:{templater:"0.0.0",settings:"0.0.0",matcher:"0.0.0",canon:"0.0.0",keyboard:"0.0.0",diff:"0.0.0",types:"0.0.0"}});
bespin.tiki.module("command_line:commands/basic",function(t,m){var n=t("bespin:index"),k=t("bespin:util/util");m.evalCommand=function(d,b,a){var g;d=b.javascript;try{g=eval(d)}catch(f){g="<b>Error: "+f.message+"</b>"}var h=b="",l;if(k.isFunction(g)){b=(g+"").replace(/\n/g,"<br>").replace(/ /g,"&#160");h="function"}else if(k.isObject(g)){h=Array.isArray(g)?"array":"object";var i=[],j;for(l in g)if(g.hasOwnProperty(l)){j=k.isFunction(g[l])?"[function]":k.isObject(g[l])?"[object]":g[l];i.push({name:l,
value:j})}i.sort(function(s,q){return s.name.toLowerCase()<q.name.toLowerCase()?-1:1});for(l=0;l<i.length;l++)b+="<b>"+i[l].name+"</b>: "+i[l].value+"<br>"}else{b=g;h=typeof g}a.done('Result for eval <b>"'+d+'"</b> (type: '+h+"): <br><br>"+b)};m.versionCommand=function(d,b,a){a.done("Bespin "+n.versionNumber+" ("+n.versionCodename+")")};var e=["really wants you to trick it out in some way.","is your Web editor.","would love to be like Emacs on the Web.","is written on the Web platform, so you can tweak it."];
m.bespinCommand=function(d,b,a){d=Math.floor(Math.random()*e.length);a.done("Bespin "+e[d])}});
bespin.tiki.module("command_line:commands/history",function(t,m){t("bespin:plugins");var n=t("canon:history"),k=0;m.historyPreviousCommand=function(e){k>0&&k--;e.commandLine.setInput(n.requests[k].typed)};m.historyNextCommand=function(e){k<n.requests.length&&k++;e.commandLine.setInput(k===n.requests.length?"":n.requests[k].typed)};m.historyCommand=function(e,d,b){var a=[];a.push("<table>");var g=1;n.requests.forEach(function(f){a.push("<tr>");a.push("<th>"+g+"</th>");a.push("<td>"+f.typed+"</td>");
a.push("</tr>");g++});a.push("</table>");b.done(a.join(""))};m.addedRequestOutput=function(){k=n.requests.length}});
bespin.tiki.module("command_line:commands/simple",function(t,m){var n=t("bespin:plugins").catalog,k=t("bespin:console").console;m.completeCommand=function(b){b.commandLine.complete()};var e=function(b,a){var g=[],f=n.getExtensionByKey("command",b);if(f&&f.pointer)g.push(f.description);else{var h=false;!b&&a&&a.prefix&&g.push(a.prefix);if(f){g.push("<h2>Sub-Commands of "+f.name+"</h2>");g.push("<p>"+f.description+"</p>")}else if(b){if(b=="hidden"){b="";h=true}g.push("<h2>Commands starting with '"+
b+"':</h2>")}else g.push("<h2>Available Commands:</h2>");var l=[];n.getExtensions("command").forEach(function(s){l.push(s.name)});var i=l.sort();g.push("<table>");for(var j=0;j<i.length;j++)if(f=n.getExtensionByKey("command",i[j])){if(!(!h&&f.hidden))if(f.description!==undefined)if(!(b&&f.name.indexOf(b)!==0))if(!(!b&&f.name.indexOf(" ")!=-1))if(!(f&&f.name==b)){g.push("<tr>");g.push('<th class="right">'+f.name+"</th>");g.push("<td>"+f.description+"</td>");g.push("</tr>")}}else k.error("Huh? command ",
f.name," cannot be looked up by name");g.push("</table>");!b&&a&&a.suffix&&g.push(a.suffix)}return g.join("")};m.helpCommand=function(b,a,g){b=e(a.search,{prefix:"<h2>Welcome to Bespin - Code in the Cloud</h2><ul><li><a href='http://labs.mozilla.com/projects/bespin' target='_blank'>Home Page</a></li><li><a href='https://wiki.mozilla.org/Labs/Bespin' target='_blank'>Wiki</a></li><li><a href='https://wiki.mozilla.org/Labs/Bespin/UserGuide' target='_blank'>User Guide</a></li><li><a href='https://wiki.mozilla.org/Labs/Bespin/Tips' target='_blank'>Tips and Tricks</a></li><li><a href='https://wiki.mozilla.org/Labs/Bespin/FAQ' target='_blank'>FAQ</a></li><li><a href='https://wiki.mozilla.org/Labs/Bespin/DeveloperGuide' target='_blank'>Developers Guide</a></li></ul>",
suffix:"For more information, see the <a href='https://wiki.mozilla.org/Labs/Bespin'>Bespin Wiki</a>."});g.done(b)};var d={aliases:[],commands:[]};m.aliasCommand=function(b,a,g){b=d.aliases;if(a.alias)if(a.command===undefined)b[a.alias]?g.done(a.alias+" &#x2192; "+b[a.alias]):g.done("No alias set for '"+a.alias+"'");else{var f=a.alias;a=a.command;var h=a.split(" ")[0];if(d.commands[f])g.done("There is already a command with the name: "+f);else if(d.commands[h]){b[f]=a;g.done("Saving alias: "+f+" &#x2192; "+
a)}else if(b[h]){b[f]=a;g.done("Saving alias: "+f+" &#x2192; "+b[a]+" ("+a+" was an alias itself)")}else g.done("No command or alias with that name.")}else{a="<table>";for(f in b)if(b.hasOwnProperty(f))a+='<tr><td style="text-align:right;">'+f+"</td><td>&#x2192;</td><td>"+b[f]+"</td></tr>";a+="</table>";g.done(a)}}});bespin.tiki.module("command_line:hint",function(t,m){m.Level={Error:3,Incomplete:2,Warning:1,Info:0};m.Hint=function(n,k,e){this.level=n;this.element=k;this.completion=e}});
bespin.tiki.module("command_line:input",function(t,m){var n=t("bespin:plugins").catalog,k=t("bespin:console").console,e=t("bespin:promise").Promise,d=t("bespin:promise").group,b=t("bespin:util/stacktrace").Trace,a=t("bespin:util/util"),g=t("types:types"),f=t("canon:environment"),h=t("canon:request").Request,l=t("canon:history"),i=t("keyboard:keyboard"),j=t("command_line:hint").Hint,s=t("command_line:hint").Level,q=t("command_line:typehint");m.Input=function(o,r){if(a.none(o))throw new Error("Input requires something 'typed' to work on");
this.typed=o;this.hints=[];this.argsPromise=new e;r=r||{};r.env=r.env||f.global;this.env=r.env;r.flags=r.flags||i.buildFlags(this.env,{});this.flags=r.flags;this._parts=[];this._assignments=this._commandExt=this._unparsedArgs=undefined;try{this._tokenize()}catch(v){o=new b(v,true);k.group("Error calling command: "+this.typed);k.error(v);o.log(3);k.groupEnd();this.argsPromise.isComplete()||this.argsPromise.reject(v)}};m.Input.prototype={_tokenize:function(){if(!this.typed||this.typed===""){this.hints.push(new j(s.Incomplete));
this.argsPromise.resolve({})}else{for(var o=this.typed.replace(/^\s\s*/,"").split(/\s+/),r;;){r=o.shift();if(a.none(r))break;if(r[0]=='"'||r[0]=="'"){r=[r.substring(1,r.length)];for(var v;;){v=o.shift();if(!v)break;if(v[v.length-1]=='"'||v[v.length-1]=="'"){r.push(v.substring(0,v.length-1));break}else r.push(v)}this._parts.push(r.join(" "))}else this._parts.push(r)}this._split()}},_split:function(){this._unparsedArgs=this._parts.slice();for(var o=this._unparsedArgs.shift(),r;;){r=n.getExtensionByKey("command",
o);if(!r)break;if(!i.flagsMatch(r.predicates,this.flags)){r=null;break}if(r.pointer)break;o+=" "+this._unparsedArgs.shift()}this._commandExt=r;o=null;var v;if(this._commandExt){var p=new e;r.load().then(function(x){if(x)p.resolve(null);else{v="Failed to load command "+r.name+": Pointer "+r.pluginName+":"+r.pointer+" is null.";p.resolve(new j(s.Error,v))}},function(x){v="Failed to load command "+r.name+": Pointer "+r.pluginName+":"+r.pointer+" failed to load."+x;p.resolve(new j(s.Error,v))});this.hints.push(p);
if(this._parts.length===1){var u=this._commandExt;if(this.typed==u.name||!u.params||u.params.length===0)o=m.documentCommand(u,this.typed)}}else{var w=[];n.getExtensions("command").forEach(function(x){i.flagsMatch(x.predicates,this.flags)&&x.description&&w.push(x)}.bind(this));o={param:{type:{name:"selection",data:w},description:"Commands"},value:this.typed}}o&&this.hints.push(q.getHint(this,o));a.none(this._commandExt)?this.argsPromise.resolve({}):this._assign()},_assign:function(){this._assignments=
[];var o=this._commandExt.params,r=this._unparsedArgs,v;if(!o||o.length===0){var p=0;r.forEach(function(A){A.trim()!==""&&p++});if(p!==0){v=this._commandExt.name+" does not take any parameters";this.hints.push(new j(s.Error,v))}this.argsPromise.resolve({})}else{if(o.length==1&&o[0].type=="text")this._assignments[0]={value:r.length===0?null:r.join(" "),param:o[0]};else{var u=0,w=[];o.forEach(function(A){this._assignParam(A,u++,w)}.bind(this));var x=false;r.forEach(function(A){if(w.indexOf(A)==-1){v=
"Parameter '"+A+"' makes no sense.";this.hints.push(new j(s.Error,v));x=true}}.bind(this));if(x){this.argsPromise.resolve({});return}}if(this._parts.length>1){o=this._getAssignmentForLastArg();o.param.type.assignments=this._assignments;o&&this.hints.push(q.getHint(this,o))}this._convertTypes()}},_assignParam:function(o,r,v){for(var p=0;p<this._unparsedArgs.length;p++){var u=this._unparsedArgs[p];if("--"+o.name==u){v.push(u);if(g.equals(o.type,"boolean"))this._assignments[r]={value:true,param:o};else if(p+
1<this._unparsedArgs.length){o="Missing parameter: "+o.name;this.hints.push(new j(s.Incomplete,o))}else v.push(this._unparsedArgs[p+1]);return}}p=null;if(this._unparsedArgs.length>r){p=this._unparsedArgs[r];v.push(this._unparsedArgs[r])}if(p!==undefined)this._assignments[r]={value:p,param:o};else{this._assignments[r]={param:o};if(o.defaultValue===undefined){o="Missing parameter: "+o.name;this.hints.push(new j(s.Incomplete,o))}}},_getAssignmentForLastArg:function(){var o=null;this._assignments.forEach(function(r){if(!o||
!a.none(r.value))o=r});return o},_convertTypes:function(){if(this._commandExt.params){var o={},r=[];this._assignments.forEach(function(v){v.param.type.assignments=this._assignments;var p=this._convertType(v,o);p.then(function(u){v.converted=u;o[v.param.name]=u},function(u){this.hints.push(new j(s.Error,"Can't convert '"+v.value+"' to a "+param.type+": "+u))}.bind(this));r.push(p)}.bind(this));d(r).then(function(){this.argsPromise.resolve(o)}.bind(this))}else this.argsPromise.resolve({})},_convertType:function(o){return o.value!==
null?g.fromString(o.value,o.param.type):(new e).resolve(o.param.defaultValue)},execute:function(){var o=function(r){var v=new b(r,true);k.group("Error executing: "+this.typed);k.error(r);v.log(3);k.groupEnd()}.bind(this);this.argsPromise.then(function(r){this._commandExt.load().then(function(v){v=new h({command:v,commandExt:this._commandExt,typed:this.typed,args:r});l.execute(f.global,r,v)}.bind(this),o)}.bind(this),o)}};m.documentCommand=function(o,r){var v=[];v.push("<h1>"+o.name+"</h1>");v.push("<h2>Summary</h2>");
v.push("<p>"+o.description+"</p>");if(o.manual){v.push("<h2>Description</h2>");v.push("<p>"+o.description+"</p>")}if(o.params&&o.params.length>0){v.push("<h2>Synopsis</h2>");v.push("<pre>");v.push(o.name);var p=0;o.params.forEach(function(u){if(u.defaultValue===undefined){v.push(" <i>");v.push(u.name);v.push("</i>")}else if(u.defaultValue===null){v.push(" <i>[");v.push(u.name);v.push("]</i>")}else p++});if(p>3)v.push(" [options]");else p>0&&o.params.forEach(function(u){if(u.defaultValue){v.push(" [--<i>");
v.push(u.name);g.equals(u.type,"boolean")?v.push("</i>"):v.push("</i> "+g.getSimpleName(u.type));v.push("]")}});v.push("</pre>");v.push("<h2>Parameters</h2>");o.params.forEach(function(u){v.push('<h3 class="cmd_body"><i>'+u.name+"</i></h3>");v.push("<p>"+u.description+"</p>");g.defaultValue&&v.push("<p>Default: "+g.defaultValue+"</p>")})}return{param:{type:"text",description:v.join("")},value:r}}});
bespin.tiki.module("command_line:typehint",function(t,m){function n(i){var j=document.createElement("article");j.innerHTML=i;return new h(l.Info,j)}function k(i,j,s,q,o){var r;try{if(q&&typeof o.getHint==="function")r=o.getHint(j,s,q)}catch(v){a.error("Failed to get hint for ",q," reason: ",v)}r||(r=n(s.param.description));i.resolve(r);return i}function e(i){var j=new g,s=b.getExtensionByKey("typehint",i.name);j.resolve({ext:s,typeSpec:i});return j}function d(i){if(typeof i==="string")return e({name:i});
if(typeof i==="object")if(i.name==="deferred"){var j=new g;f.undeferTypeSpec(i).then(function(s){d(s).then(function(q){j.resolve(q)},function(q){j.reject(q)})});return j}else return e(i);throw new Error("Unknown typeSpec type: "+typeof i);}var b=t("bespin:plugins").catalog,a=t("bespin:console").console,g=t("bespin:promise").Promise,f=t("types:types"),h=t("command_line:hint").Hint,l=t("command_line:hint").Level;m.getHint=function(i,j){var s=new g;d(j.param.type).then(function(q){if(!q.ext)return k(s,
i,j);q.ext.load().then(function(o){typeof o.resolveTypeSpec==="function"?o.resolveTypeSpec(q.ext,q.typeSpec).then(function(){k(s,i,j,q.ext,o)},function(r){s.reject(r)}):k(s,i,j,q.ext,o)},function(){hint=n(j.param.description);s.resolve(hint)})});return s}});
bespin.tiki.module("command_line:views/basic",function(t,m){var n=t("bespin:console").console;t("bespin:promise");var k=t("types:basic"),e=t("matcher:prefix").PrefixMatcher,d=t("command_line:views/menu").Menu,b=t("command_line:views/menu").MatcherMenu;m.selection={getHint:function(a,g,f){if(!f.data){n.error("Missing data for selection type");f.data=[]}var h=new e(g.value||"");f=f.data.map(function(l){if(typeof l==="string")return{name:l};return l});h.addItems(f);return(new b(a,g,h)).hint},resolveTypeSpec:k.selection.resolveTypeSpec};
m.bool={getHint:function(a,g){a=new d(a,g);a.addItems([{name:"true"},{name:"false"}]);return a.hint}}});
bespin.tiki.module("command_line:views/cli",function(t,m){var n=t("diff").diff_match_patch,k=t("bespin:util/util"),e=t("bespin:plugins").catalog;t("bespin:console");var d=t("keyboard:keyutil"),b=t("keyboard:keyboard").keyboardManager;t("canon:history");var a=t("canon:environment").global,g=t("settings").settings,f=t("command_line:hint").Level,h=t("command_line:input").Input,l=t("command_line:templates"),i=t("command_line:views/requestOutput"),j=e.getResourceURL("command_line")+"images",s=new n;m.CliInputView=
function(){this._pinned=this._hasFocus=false;this._completion="";this._input=new h("");this._inputer=this._completer=this._table=this._hints=this._tog=this.element=this._lastOrientation=null;l.cli({cliInputView:this,imagePath:j});d.addKeyDownListener(this._inputer,function(o){a.commandLine=this;var r=b.processKeyEvent(o,this,{isCommandLine:true,isKeyUp:false});if(o.keyCode===d.KeyHelper.KEY.TAB)return true;return r}.bind(this));this._inputer.addEventListener("keyup",function(o){var r=b.processKeyEvent(o,
this,{isCommandLine:true,isKeyUp:true});if(o.keyCode===d.KeyHelper.KEY.RETURN){this._input.execute();this.setInput("")}else{o=this._inputer.value;if(this._input.typed!==o){this._input=new h(o);this.hintUpdated()}}return r}.bind(this),true);e.registerExtension("settingChange",{match:"[min|max]ConsoleHeight",pointer:this.checkSize.bind(this)});var q=i.createHandler(this);e.registerExtension("addedRequestOutput",q)};m.CliInputView.prototype={elementAppended:function(){this.checkSize()},getOrientation:function(){var q=
this.element.className,o=/\bnorth\b/.test(q),r=/\bsouth\b/.test(q),v=/\beast\b/.test(q);q=/\bwest\b/.test(q);if(o&&!r&&!v&&!q)return"north";if(!o&&r&&!v&&!q)return"south";if(!o&&!r&&v&&!q)return"east";if(!o&&!r&&!v&&q)return"west";throw new Error("Ambiguous orientation: north="+o+", south="+r+", east="+v+", west="+q);},checkSize:function(){var q=this.getOrientation();if(q==="north"||q==="south"){q=g.get("minConsoleHeight");if(this._pinned||this._hasFocus)q=g.get("maxConsoleHeight");this._table.style.height=
q+"px";this._tog.style.height=q+"px";this.element.style.height=q+26+"px";e.publish(this,"dimensionsChanged")}},complete:function(){this._inputer.value=this._completion},setInput:function(q){q=q||"";this._inputer.value=q;this._input=new h(q);this.hintUpdated();this.focus()},focus:function(){this._inputer.focus()},execute:function(q){a.commandLine=this;(new h(q)).execute()},prompt:function(q){this._inputer.value=q},hintUpdated:function(){for(var q=this._input.hints;this._hints.firstChild;)this._hints.removeChild(this._hints.firstChild);
var o=f.Info;this.setCompletion("");var r=function(v,p){if(p)if(p.isPromise)p.then(function(x){r(v,x)}.bind(this));else{if(p.element)if(p.element.addEventListener)v.appendChild(p.element);else{var u=document.createElement("article"),w=p.element.toString();u.appendChild(document.createTextNode(w));v.appendChild(u)}this.setCompletion(p.completion);if(p.level>o)o=p.level;k.setClass(this._inputer,"cmd_error",o==f.Error)}}.bind(this);q.forEach(function(v){r(this._hints,v)}.bind(this));k.setClass(this._inputer,
"cmd_error",o==f.Error)},scrollToBottom:function(){this._table.scrollTop=Math.max(this._table.scrollHeight,this._table.clientHeight)-this._table.clientHeight},_focusCheck:function(q){this._hasFocus=q.type=="focus";this._delayedCheckSize()},_delayedCheckSize:function(){if(this._checkSizeTimeout){window.clearTimeout(this._checkSizeTimeout);this._checkSizeTimeout=null}this._checkSizeTimeout=window.setTimeout(function(){this.checkSize()}.bind(this),100)},_togglePin:function(q){if(/\bchecked\b/.test(q.target.className)){k.removeClass(q.target,
"checked");this._pinned=false}else{k.addClass(q.target,"checked");this._pinned=true}this._delayedCheckSize()},setCompletion:function(q){this._completion=q||"";var o=this._inputer.value;if(q)if(q.indexOf(o)===0)o='<span class="cmd_existing">'+o+"</span>"+q.substring(o.length);else{var r=s.diff_commonPrefix(o,q);q=q.substring(r);o='<span class="cmd_existing">'+o+'</span><span class="cmd_extension">'+q+"</span>"}else o="";this._completer.innerHTML=o}}});
bespin.tiki.module("command_line:views/menu",function(t,m){var n=t("command_line:hint").Hint,k=t("command_line:hint").Level,e;m.activateItemAction=function(b,a,g){b=parseInt(g.commandExt.key.replace(/[A-Za-z_]/g,""),10);e&&e._itemActions[b]()};var d=function(b,a){for(var g=0;;){if(b.charAt(g).toLocaleLowerCase()!==a.charAt(g).toLocaleLowerCase())return g;if(g>=b.length||g>=a.length)return g;g++}};m.Menu=function(b,a){if(b!=="subclassPrototype"){this.input=b;this.assignment=a;this._parent=document.createElement("div");
this._parent.setAttribute("class","cmd_menu");this._notFound=document.createElement("div");this._notFound.setAttribute("class","cmd_error");this._notFound.innerHTML="No matches for '"+this.input.typed+"'";this._parent.appendChild(this._notFound);this._list=document.createElement("ul");this._parent.appendChild(this._list);this._items=[];this._commonPrefix=null;this._itemActions=[];this._prefix=this.input.typed.substring(0,this.input.typed.length-(this.assignment.value?this.assignment.value.length:
0));this.hint=new n(k.Incomplete,this._parent);e=this}};m.Menu.prototype.addItems=function(b){var a=1,g;b.forEach(function(f){if(this._items.length<10){var h=document.createElement("li");h.appendChild(document.createTextNode(f.name));if(f.description||f.path){var l=document.createElement("dfn");l.appendChild(document.createTextNode(f.description||f.path));h.appendChild(l)}this._itemActions[a]=function(){this.input.env.commandLine.setInput(this._prefix+this._getFullName(f))}.bind(this);if(a<11){l=
document.createElement("abbr");l.innerHTML="ALT-"+"-1234567890"[a];if(a===1)g=l;h.appendChild(l);a++}this._list.appendChild(h);h.addEventListener("mousedown",function(i){this.input.env.commandLine.setInput(this._prefix+this._getFullName(f));i.preventDefault()}.bind(this),false)}this._items.length===0&&this._parent.removeChild(this._notFound);this._items.push(f)}.bind(this));b=this._getBestCompletion();this.hint.completion=b.completion;if(b.isFirst&&g)g.innerHTML="TAB"};m.Menu.prototype._getBestCompletion=
function(){if(this._items.length===0)return{completion:undefined,isFirst:false};var b=this._items.length===1,a=this._getFullName(this._items[0]);this._items.length>1&&this._items.forEach(function(h){if(a.length>0){h=this._getFullName(h);h=d(a,h);if(h<a.length)a=a.substring(0,h)}}.bind(this));if(!a||a.length===0){a=this._getFullName(this._items[0]);b=true}var g=this.input.typed.substring(0,this.input.typed.length-(this.assignment.value?this.assignment.value.length:0)),f=g+a;if(f.indexOf(this.input.typed)!=
0||f===this.input.typed){f=g+this._getFullName(this._items[0]);b=true}return{completion:f,isFirst:b}};m.Menu.prototype._getFullName=function(b){return(b.path||"")+b.name};m.MatcherMenu=function(b,a,g,f){m.Menu.call(this,b,a);this.matcher=g;this.loaded=f;this.matcher.addListener({itemsAdded:function(h){this.addItems(h)}.bind(this),itemsCleared:function(){this.clearItems()}.bind(this)});if(this.loaded){this.loaded.then(function(){this._isLoaded=true}.bind(this));this._isLoaded=false}else this._isLoaded=
true};m.MatcherMenu.prototype=new m.Menu("subclassPrototype")});
bespin.tiki.module("command_line:views/requestOutput",function(t,m){var n=t("bespin:util/util"),k=t("bespin:plugins").catalog;t("bespin:console");var e=t("canon:environment").global,d=t("command_line:templates"),b=k.getResourceURL("command_line")+"images";m.RequestOutput=function(a,g){this.request=a;this.cliInputView=g;this.throb=this.typed=this.duration=this.show=this.hide=this.output=this.rowout=this.rowin=null;d.requestOutput({actions:this,imagePath:b});this.cliInputView._table.appendChild(this.rowin);
this.cliInputView._table.appendChild(this.rowout);this.request.changed.add(this.onRequestChange.bind(this))};m.RequestOutput.prototype={copyToInput:function(){this.cliInputView.setInput(this.request.typed)},executeRequest:function(){e.commandLine=this.cliInputView;this.cliInputView._input=new Input(this.request.typed);this.cliInputView._input.execute()},hideOutput:function(a){this.output.style.display="none";n.addClass(this.hide,"cmd_hidden");n.removeClass(this.show,"cmd_hidden");a.stopPropagation()},
showOutput:function(a){this.output.style.display="block";n.removeClass(this.hide,"cmd_hidden");n.addClass(this.show,"cmd_hidden");a.stopPropagation()},remove:function(a){this.cliInputView._table.removeChild(this.rowin);this.cliInputView._table.removeChild(this.rowout);a.stopPropagation()},onRequestChange:function(){this.duration.innerHTML=this.request.duration?"completed in "+this.request.duration/1E3+" sec ":"";this.typed.innerHTML=this.request.typed;this.output.innerHTML="";this.request.outputs.forEach(function(a){var g;
if(typeof a=="string"){g=document.createElement("p");g.innerHTML=a}else g=a;this.output.appendChild(g)},this);this.cliInputView.scrollToBottom();n.setClass(this.output,"cmd_error",this.request.error);this.throb.style.display=this.request.completed?"none":"block"}};m.createHandler=function(a){return{pointer:function(g,f,h){new m.RequestOutput(h,a)}}}});bespin.tiki.module("command_line:index",function(){});
bespin.tiki.module("command_line:templates",function(t,m){t("templater").compileAll({"requestOutput.htmlt":'\n<!-- The div for the input (i.e. what was typed) --\>\n<div class="cmd_rowin" save="${actions.rowin}"\n    onclick="${actions.copyToInput}"\n    ondblclick="${actions.executeRequest}">\n\n  <!-- What the user actually typed --\>\n  <div class="cmd_gt">&gt; </div>\n  <div class="cmd_typed" save="${actions.typed}"></div>\n\n  <!-- The extra details that appear on hover --\>\n  <div class="cmd_duration cmd_hover" save="${actions.duration}"></div>\n  <img class="cmd_hover" onclick="${actions.hideOutput}" save="${actions.hide}"\n      alt="Hide command output" src="${imagePath}/minus.png"/>\n  <img class="cmd_hover cmd_hidden" onclick="${actions.showOutput}" save="${actions.show}"\n      alt="Show command output" src="${imagePath}/plus.png"/>\n  <img class="cmd_hover" onclick="${actions.remove}"\n      alt="Remove this command from the history" src="${imagePath}/closer.png"/>\n\n</div>\n\n<!-- The div for the command output --\>\n<div class="cmd_rowout" save="${actions.rowout}">\n  <div class="cmd_output" save="${actions.output}"></div>\n  <img src="${imagePath}/throbber.gif" save="${actions.throb}"/>\n</div>\n',"cli.htmlt":'\n<div class="cmd_line" save="${cliInputView.element}"\n    onfocus="${cliInputView._focusCheck [useCapture:true]}"\n    onblur="${cliInputView._focusCheck [useCapture:true]}"\n    onclick="${cliInputView.focus [useCapture:true]}">\n\n  <!-- The output area that changes height --\>\n  <div class="cmd_tog stack_children" save="${cliInputView._tog}">\n\n    <div class="cmd_top">\n      <!-- Side toolbar --\>\n      <div class="cmd_toolbar">\n        <img src="${imagePath}/dot_clear.gif" class="cmd_pin check"\n            alt="Pin/Unpin the console output"\n            onclick="${cliInputView._togglePin}"/>\n      </div>\n  \n      <!-- CLI output table --\>\n      <div class="cmd_table" save="${cliInputView._table}"></div>\n    </div>\n\n    <!-- A div to hang hints on --\>\n    <div class="cmd_hints" save="${cliInputView._hints}"></div>\n\n  </div>\n\n  <!-- The input area, with fixed height --\>\n  <div class="cmd_cli">\n\n    <!-- The prompt --\>\n    <div class="cmd_prompt cmd_gt">\n      <span class="cmd_brackets">{ }</span> &gt;\n    </div>\n\n    <!-- Where you type commands --\>\n    <div class="cmd_kbd stack_children">\n      <div class="cmd_completion" save="${cliInputView._completer}"></div>\n      <div>\n        <input class="cmd_input" type="text" save="${cliInputView._inputer}"/>\n      </div>\n    </div>\n\n  </div>\n\n</div>\n'},
m)});bespin.tiki.register("::rangeutils",{name:"rangeutils",dependencies:{}});
bespin.tiki.module("rangeutils:utils/range",function(t,m){var n=t("bespin:util/util");m.addPositions=function(k,e){return{row:k.row+e.row,col:k.col+e.col}};m.cloneRange=function(k){var e=k.start;k=k.end;return{start:{row:e.row,col:e.col},end:{row:k.row,col:k.col}}};m.comparePositions=function(k,e){var d=k.row-e.row;return d===0?k.col-e.col:d};m.equal=function(k,e){return m.comparePositions(k.start,e.start)===0&&m.comparePositions(k.end,e.end)===0};m.extendRange=function(k,e){var d=k.end;return{start:k.start,
end:{row:d.row+e.row,col:d.col+e.col}}};m.intersectRangeSets=function(k,e){k=n.clone(k);e=n.clone(e);for(var d=[];k.length>0&&e.length>0;){var b=k.shift(),a=e.shift(),g=m.comparePositions(b.start,a.start),f=m.comparePositions(b.end,a.end);if(m.comparePositions(b.end,a.start)<0){d.push(b);e.unshift(a)}else if(m.comparePositions(a.end,b.start)<0){d.push(a);k.unshift(b)}else if(g<0){d.push({start:b.start,end:a.start});k.unshift({start:a.start,end:b.end});e.unshift(a)}else if(g===0)if(f<0)e.unshift({start:b.end,
end:a.end});else f>0&&k.unshift({start:a.end,end:b.end});else if(g>0){d.push({start:a.start,end:b.start});k.unshift(b);e.unshift({start:b.start,end:a.end})}}return d.concat(k,e)};m.isZeroLength=function(k){return k.start.row===k.end.row&&k.start.col===k.end.col};m.maxPosition=function(k,e){return m.comparePositions(k,e)>0?k:e};m.normalizeRange=function(k){return this.comparePositions(k.start,k.end)<0?k:{start:k.end,end:k.start}};m.rangeSetBoundaries=function(k){return{start:k[0].start,end:k[k.length-
1].end}};m.toString=function(k){var e=k.start;k=k.end;return"[ "+e.row+", "+e.col+" "+k.row+","+ +k.col+" ]"};m.unionRanges=function(k,e){return{start:k.start.row<e.start.row||k.start.row===e.start.row&&k.start.col<e.start.col?k.start:e.start,end:k.end.row>e.end.row||k.end.row===e.end.row&&k.end.col>e.end.col?k.end:e.end}};m.isPosition=function(k){return!n.none(k)&&!n.none(k.row)&&!n.none(k.col)};m.isRange=function(k){return!n.none(k)&&m.isPosition(k.start)&&m.isPosition(k.end)}});
bespin.tiki.module("rangeutils:index",function(){});bespin.tiki.register("::templater",{name:"templater",dependencies:{}});
bespin.tiki.module("templater:index",function(t,m){function n(g,f){g=Array.prototype.slice.call(g.childNodes);for(var h=0;h<g.length;h++)d(g[h],f)}function k(g,f,h){if(typeof g==="string")g=g.split(".");var l=f[g[0]];if(g.length===1){if(h!==undefined)f[g[0]]=h;if(typeof l==="function")return l.bind(f);return l}if(!l){console.error("Can't find path=",g," in data=",f);return null}return k(g.slice(1),l,h)}function e(g,f){with(f)return eval(g)}m.processTemplate=function(g,f){f=f||{};var h=document.createElement("div");
h.innerHTML=g;d(h,f);return h};var d=function(g,f){if(g.attributes&&g.attributes.length)for(var h=Array.prototype.slice.call(g.attributes),l=0;l<h.length;l++){var i=h[l].value,j=h[l].name;if(j==="save"){i=b(i);k(i,f,g);g.removeAttribute(j)}else if(j.substring(0,2)==="on"){i=b(i);var s=false;i=i.replace(/\s*\[useCapture:true\]$/,function(){s=true;return""});var q=k(i,f);typeof q!=="function"&&console.error("Expected "+i+" to resolve to a function, but got ",typeof q);g.removeAttribute(j);g.addEventListener(j.substring(2),
q,s)}else{j=i.replace(/\$\{[^}]*\}/,function(o){return e(o.slice(2,-1),f)});if(i!==j)h[l].value=j}}n(g,f);if(g.nodeType===3){i=g.textContent;j=i.replace(/\$\{[^}]*\}/,function(o){return e(o.slice(2,-1),f)});if(i!==j)g.textContent=j}},b=function(g){if(!g.match(/\$\{.*\}/)){console.error("Expected "+g+" to match ${...}");return g}return g.slice(2,-1)},a=function(g){var f=g.lastIndexOf(".");return g.substring(0,f)};m.compile=function(g){return function(f){return m.processTemplate(g,f)}};m.compileAll=
function(g,f){if("undefined"===typeof f)f={};Object.keys(g).forEach(function(h){f[a(h)]=m.compile(g[h])});return f}});bespin.tiki.register("::matcher",{name:"matcher",dependencies:{}});
bespin.tiki.module("matcher:index",function(t,m){m.Matcher=function(n){if(n!=="subclassPrototype"){this._query=n;this._scoredItems=[];this._listeners=[];this._maxScore=null}};m.Matcher.prototype.addItem=function(n){this.addItems([n])};m.Matcher.prototype.addItems=function(n){var k=[],e=false;n.forEach(function(a){a={score:this.score(this._query,a),item:a};a.score>0&&k.push(a);if(a.score>this._maxScore){this._maxScore=a.score;e=true}this._scoredItems.push(a)},this);var d=false;e&&this._scoredItems.forEach(function(a){if(a.score+
500<this._maxScore)d=true});n=function(a,g){return g.score-a.score};this._scoredItems.sort(n);k.sort(n);if(d){this._callListeners("itemsCleared");n=this._scoredItems}else n=k;var b=[];n.forEach(function(a){a.score+500>this._maxScore&&b.push(a.item)}.bind(this));this._callListeners("itemsAdded",b)};m.Matcher.prototype.addListener=function(n){this._listeners.push(n);var k=[];this._scoredItems.forEach(function(e){e.score>0&&k.push(e.item)},this);typeof n.itemsAdded==="function"&&n.itemsAdded(k)};m.Matcher.prototype.__defineSetter__("query",
function(n){this._query=n;var k=[];this._scoredItems.forEach(function(e){e.score=this.score(this._query,e.item);e.score>0&&k.push(e.item)},this);this._callListeners("itemsCleared");this._callListeners("itemsAdded",k)});m.Matcher.prototype._callListeners=function(){var n=Array.prototype.slice.call(arguments),k=n.shift();this._listeners.forEach(function(e){typeof e[k]==="function"&&e[k].apply(null,n)})}});
bespin.tiki.module("matcher:prefix",function(t,m){var n=t("matcher").Matcher;m.PrefixMatcher=function(k){n.call(this,k)};m.PrefixMatcher.prototype=new n("subclassPrototype");m.PrefixMatcher.prototype.score=function(k,e){var d=k.length;if(d>e.name.length)return 0;if(e.name.substring(0,d).toLowerCase()===k.toLowerCase())return 1E3-e.name.length;return 0}});
bespin.tiki.module("matcher:quick",function(t,m){var n=t("matcher").Matcher;m.QuickMatcher=function(k){n.call(this,k)};m.QuickMatcher.prototype=new n("subclassPrototype");m.QuickMatcher.prototype.score=function(k,e){k=k.toLowerCase();var d=e.name.toLowerCase();e=e.path?e.path.toLowerCase():null;if(d.substring(0,k.length)===k)return 5E3-d.length;if(e&&e.substring(0,k.length)===k)return 4E3-e.length;if(d.substring(d.length-k.length,d.length)===k)return 3E3-d.length;if(e)d=e+d;e=k.substring(0,1);for(var b=
0,a=2E3,g=0;g<d.length;g++)if(d.substring(g,g+1)===e){b++;if(b===k.length)return a;e=k.substring(b,b+1)}else b!==0&&a--;return 0}});bespin.tiki.register("::theme_manager",{name:"theme_manager",dependencies:{jquery:"0.0.0",settings:"0.0.0",events:"0.0.0",less:"0.0.0"}});
bespin.tiki.module("theme_manager:index",function(t,m){t("bespin:promise");var n=t("bespin:plugins").catalog;t("events");var k=t("themestyles"),e=t("settings").settings,d=null,b=null;m.themestyles=k;m.themeSettingChanged=function(a,g,f){var h=n.getExtensionByKey("theme",f);if(f==="standard"||!f||!h){h=null;if(b!==null)h=n.getExtensionByKey("theme",b)}if(h)h.load().then(function(l){d&&k.unregisterThemeStyles(d);k.currentThemeVariables=l();d=h;k.parseGlobalVariables();k.reparse();h.url&&k.registerThemeStyles(h);
n.publish(m,"themeChange")});else if(d){k.unregisterThemeStyles(d);d=null;k.currentThemeVariables=null;k.parseGlobalVariables();k.reparse();n.publish(this,"themeChange")}};n.registerExtension("settingChange",{match:"theme",pointer:m.themeSettingChanged.bind(m)});m.setStandardTheme=function(a){b=a;a!==e.get("theme")&&m.themeSettingChanged(this)};m.setBasePlugin=function(a){k.basePluginName=a};m.startParsing=function(){k.preventParsing=false;return k.reparse()};m.registerTheme=function(a){var g=e.get("theme");
a.name===g&&m.themeSettingChanged(this,"theme",a.name)};m.unregisterTheme=function(a){a.name===e.get("theme")&&m.themeSettingChanged(this)};m.appLaunched=function(){n.publish(m,"themeChange")}});
bespin.tiki.module("theme_manager:themestyles",function(t,m){var n=t("bespin:util/util"),k=t("bespin:plugins").catalog,e=t("bespin:console").console,d=t("bespin:promise").Promise,b=t("bespin:promise").group,a=t("jquery").$,g=new (t("less").Parser)({optimization:3}),f=1;m.currentThemeVariables=null;m.basePluginName=null;m.preventParsing=true;var h="";m.globalThemeVariables={};var l={},i={},j=function(u){var w={},x=[],A=function(E,D){x.push(E);if(typeof D!="object")w[x.join("_")]=D;else for(prop in D)A(prop,
D[prop]);x.pop()};A("global",u);return w},s={},q={font:"arial, lucida, helvetica, sans-serif",font_size:"14px",line_height:"1.8em",color:"#DAD4BA",text_shadow:"1px 1px rgba(0, 0, 0, 0.4)",error_color:"#F99",header_color:"white",link_color:"#ACF",control:{color:"#E1B41F",border:"1px solid rgba(0, 0, 0, 0.2)",border_radius:"0.25em",background:"rgba(0, 0, 0, 0.2)",active:{color:"#FF9600",border:"1px solid #E1B41F",inset_color:"#ff9600",background:"rgba(0, 0, 0, 0.2)"}},pane:{h1:{font:"'MuseoSans', Helvetica",
font_size:"2.8em",color:"white"},color:"#DAD4BA",text_shadow:"1px 1px rgba(0, 0, 0, 0.4)",link_color:"white",background:"#45443C",border_radius:".5em"},form:{color:"white",text_shadow:"1px 1px rgba(0, 0, 0, 0.4)",font:"'Lucida Sans','Lucida Grande',Verdana,Arial,sans-serif",font_size:"@global_font_size",line_height:"@global_line_height"},button:{color:"white",background:"#3E6CB9"},container:{background:"#1E1916",border:"1px solid black"},selectable:{color:"white",border:"0px solid transparent",background:"transparent",
active:{color:"black",border:"0px solid transparent",background:"#FF8E00"},hover:{color:"black",border:"0px solid transparent",background:"#FF8E00"}},hint:{color:"#AAA",active:{color:"black"},hover:{color:"black"}},accelerator:{color:"#996633",active:{color:"black"},hover:{color:"black"}},menu:{border_color:"black",inset_color_right:"#1E1916",inset_color_top_left:"#3E3936",background:"transparent"}};q=j(q);m.getPluginThemeVariables=function(u){var w=k.plugins[u];if(!w)return null;var x={};if(m.currentThemeVariables&&
m.currentThemeVariables[u])x=m.currentThemeVariables[u];w.provides.forEach(function(A){if(A.ep==="themevariable"){var E=A.name;x[E]=x[E]||A.defaultValue}});return x};m.parseGlobalVariables=function(){var u={},w="",x=m.currentThemeVariables;n.mixin(u,q);x&&x.global&&n.mixin(u,j(x.global));m.globalThemeVariables=u;for(prop in u)w+="@"+prop+":"+u[prop]+";";h=w};m.parseGlobalVariables();var o=function(u,w,x){if(l[w])styleElem=document.getElementById("_bespin_theme_style_"+l[w]);else{styleElem=document.createElement("style");
styleElem.setAttribute("id","_bespin_theme_style_"+f);l[w]=f;f++;document.body.appendChild(styleElem)}g.parse(h+x+i[w],function(A,E){if(A){A="Error less parsing "+w+" "+A.message;e.error(A);u.reject(A)}else{try{var D=E.toCSS()}catch(G){A="Error less parsing "+w+" "+G;e.error(A);u.reject(A);return}if(styleElem&&styleElem.firstChild)styleElem.firstChild.textContent=D;else{A=document.createTextNode(D);styleElem.appendChild(A)}u.resolve()}})},r={};m.parsePlugin=function(u){if(m.preventParsing)return(new d).resolve();
var w=k.plugins[u];if(!w)throw"reparsePlugin: plugin "+u+" is not defined!";if(!r[u]){r[u]=new d;setTimeout(function(){var x=m.getPluginThemeVariables(u),A="";for(prop in x)A+="@"+prop+":"+x[prop]+";";x=new d;x.then(function(E){r[this.name].resolve(E);r[this.name]=null}.bind(this),function(){r[this.name].reject(data);r[this.name]=null}.bind(this));o(x,u,A)}.bind(w),0)}return r[u]};var v=function(u,w,x,A){x=x.replace(/url\(['"]*([^'")]*)(['"]*)\)/g,"url("+u+"$1)");i[w]+=x;A&&A.resolve()},p=null;m.registerThemeStyles=
function(u){var w=u.getPluginName(),x=k.getResourceURL(w);if(!(u.url instanceof Array))u.url=[u.url];i[w]="";var A=[],E=m.preventParsing;u.url.forEach(function(D){if(s[w]&&s[w][D])v(x,w,s[w][D]);else{var G=new d;A.push(G);a.ajax({url:x+D+"?"+(new Date).getTime(),success:function(H){v(x,w,H,G)},error:function(){e.error("registerLessFile: Could not load "+x+D);G.resolve()}})}});if(A.length===0)m.parsePlugin(w);else{E||b(A).then(function(){m.parsePlugin(w)});if(p!==null)A=A.concat(p);p=b(A)}};m.reparse=
function(){var u=new d;if(m.preventParsing)return u.resolve();p?p.then(function(){var w=[],x=m.basePluginName;x!==null&&i[x]&&w.push(m.parsePlugin(x));for(var A in i)A!==x&&w.push(m.parsePlugin(A));b(w).then(u.resolve.bind(u),u.reject.bind(u))},function(w){u.reject(w)}):u.resolve();return u};m.unregisterThemeStyles=function(u){u=u.getPluginName();if(l[u]){var w=document.getElementById("_bespin_theme_style_"+l[u]);w.parentNode.removeChild(w);delete l[u];delete i[u]}}});
bespin.tiki.register("::types",{name:"types",dependencies:{}});
bespin.tiki.module("types:basic",function(t,m){var n=t("bespin:plugins").catalog,k=t("bespin:console").console,e=t("bespin:promise").Promise;m.text={isValid:function(d){return typeof d=="string"},toString:function(d){return d},fromString:function(d){return d}};m.number={isValid:function(d){if(isNaN(d))return false;if(d===null)return false;if(d===undefined)return false;if(d===Infinity)return false;return typeof d=="number"},toString:function(d){if(!d)return null;return""+d},fromString:function(d){if(!d)return null;
var b=parseInt(d,10);if(isNaN(b))throw new Error("Can't convert \""+d+'" to a number.');return b}};m.bool={isValid:function(d){return typeof d=="boolean"},toString:function(d){return""+d},fromString:function(d){if(d===null)return null;if(!d.toLowerCase)return!!d;var b=d.toLowerCase();if(b=="true")return true;else if(b=="false")return false;return!!d}};m.object={isValid:function(d){return typeof d=="object"},toString:function(d){return JSON.stringify(d)},fromString:function(d){return JSON.parse(d)}};
m.selection={isValid:function(d,b){if(typeof d!="string")return false;if(!b.data){k.error("Missing data on selection type extension. Skipping");return true}var a=false;b.data.forEach(function(g){if(d==g)a=true});return a},toString:function(d){return d},fromString:function(d){return d},resolveTypeSpec:function(d,b){var a=new e;if(b.data){d.data=b.data;a.resolve()}else if(b.pointer)n.loadObjectForPropertyPath(b.pointer).then(function(g){g=g(b);if(typeof g.then==="function")g.then(function(f){d.data=
f;a.resolve()});else{d.data=g;a.resolve()}},function(g){a.reject(g)});else{k.warn("Missing data/pointer for selection",b);a.resolve()}return a}}});
bespin.tiki.module("types:types",function(t,m){function n(b){var a=new d,g=e.getExtensionByKey("type",b.name);g?a.resolve({ext:g,typeSpec:b}):a.reject(new Error("Unknown type: "+b.name));return a}function k(b){if(typeof b==="string")return n({name:b});if(typeof b==="object")if(b.name==="deferred"){var a=new d;m.undeferTypeSpec(b).then(function(g){k(g).then(function(f){a.resolve(f)},function(f){a.reject(f)})});return a}else return n(b);throw new Error("Unknown typeSpec type: "+typeof b);}var e=t("bespin:plugins").catalog;
t("bespin:console");var d=t("bespin:promise").Promise;m.getSimpleName=function(b){if(!b)throw new Error("null|undefined is not a valid typeSpec");if(typeof b=="string")return b;if(typeof b=="object"){if(!b.name)throw new Error("Missing name member to typeSpec");return b.name}throw new Error("Not a typeSpec: "+b);};m.equals=function(b,a){return m.getSimpleName(b)==m.getSimpleName(a)};m.undeferTypeSpec=function(b){var a=new d;if(!b.pointer){a.reject(new Error("Missing deferred pointer"));return a}e.loadObjectForPropertyPath(b.pointer).then(function(g){g=
g(b);typeof g.then==="function"?g.then(function(f){a.resolve(f)},function(f){a.reject(f)}):a.resolve(g)},function(g){a.reject(g)});return a};m.resolveType=function(b){var a=new d;k(b).then(function(g){g.ext.load(function(f){typeof f.resolveTypeSpec==="function"?f.resolveTypeSpec(g.ext,g.typeSpec).then(function(){a.resolve({type:f,ext:g.ext})},function(h){a.reject(h)}):a.resolve({type:f,ext:g.ext})})},function(g){a.reject(g)});return a};m.fromString=function(b,a){var g=new d;m.resolveType(a).then(function(f){g.resolve(f.type.fromString(b,
f.ext))});return g};m.toString=function(b,a){var g=new d;m.resolveType(a).then(function(f){g.resolve(f.type.toString(b,f.ext))});return g};m.isValid=function(b,a){var g=new d;m.resolveType(a).then(function(f){g.resolve(f.type.isValid(b,f.ext))});return g}});bespin.tiki.module("types:index",function(){});bespin.tiki.register("::embedded",{name:"embedded",dependencies:{theme_manager:"0.0.0",text_editor:"0.0.0",appconfig:"0.0.0",edit_session:"0.0.0",screen_theme:"0.0.0"}});
bespin.tiki.module("embedded:index",function(){});bespin.tiki.register("::settings",{name:"settings",dependencies:{types:"0.0.0"}});
bespin.tiki.module("settings:commands",function(t,m){t("bespin:plugins");var n=t("settings").settings;m.setCommand=function(k,e,d){var b;if(e.setting)if(e.value===undefined)b="<strong>"+e.setting+"</strong> = "+n.get(e.setting);else{b="Setting: <strong>"+e.setting+"</strong> = "+e.value;n.set(e.setting,e.value)}else{k=n._list();b="";k.sort(function(a,g){return a.key<g.key?-1:a.key==g.key?0:1});k.forEach(function(a){b+='<a class="setting" href="https://wiki.mozilla.org/Labs/Bespin/Settings#'+a.key+
'" title="View external documentation on setting: '+a.key+'" target="_blank">'+a.key+"</a> = "+a.value+"<br/>"})}d.done(b)};m.unsetCommand=function(k,e,d){n.resetValue(e.setting);d.done("Reset "+e.setting+" to default: "+n.get(e.setting))}});
bespin.tiki.module("settings:cookie",function(t,m){var n=t("bespin:util/cookie");m.CookiePersister=function(){};m.CookiePersister.prototype={loadInitialValues:function(k){k._loadDefaultValues().then(function(){var e=n.get("settings");k._loadFromObject(JSON.parse(e))}.bind(this))},persistValue:function(k){try{var e={};k._getSettingNames().forEach(function(a){e[a]=k.get(a)});var d=JSON.stringify(e);n.set("settings",d)}catch(b){console.error("Unable to JSONify the settings! "+b)}}}});
bespin.tiki.module("settings:index",function(t,m){var n=t("bespin:plugins").catalog,k=t("bespin:console").console,e=t("bespin:promise").Promise,d=t("bespin:promise").group,b=t("types:types");m.addSetting=function(a){t("settings").settings.addSetting(a)};m.getSettings=function(){return n.getExtensions("setting")};m.getTypeSpecFromAssignment=function(a){var g=a.assignments;a="text";if(g){var f=null;g.forEach(function(h){if(h.param.name==="setting")f=h});if(f)if((g=f.value)&&g!=="")if(g=n.getExtensionByKey("setting",
g))a=g.type}return a};m.MemorySettings=function(){};m.MemorySettings.prototype={_values:{},_deactivated:{},setPersister:function(a){(this._persister=a)&&a.loadInitialValues(this)},get:function(a){return this._values[a]},set:function(a,g){var f=n.getExtensionByKey("setting",a);if(f)if(typeof g=="string"&&f.type=="string")this._values[a]=g;else{var h=false;b.fromString(g,f.type).then(function(l){h=true;this._values[a]=l;n.publish(this,"settingChange",a,l)}.bind(this),function(l){k.error("Error setting",
a,": ",l)});if(!h){k.warn("About to set string version of ",a,"delaying typed set.");this._values[a]=g}}else{k.warn("Setting not defined: ",a,g);this._deactivated[a]=g}this._persistValue(a,g);return this},addSetting:function(a){if(a.name){!a.defaultValue===undefined&&k.error("Setting.defaultValue == undefined",a);b.isValid(a.defaultValue,a.type).then(function(g){g||k.warn("!Setting.isValid(Setting.defaultValue)",a);this.set(a.name,this._deactivated[a.name]||a.defaultValue)}.bind(this),function(g){k.error("Type error ",
g," ignoring setting ",a)})}else k.error("Setting.name == undefined. Ignoring.",a)},resetValue:function(a){var g=n.getExtensionByKey("setting",a);g?this.set(a,g.defaultValue):k.log("ignore resetValue on ",a)},resetAll:function(){this._getSettingNames().forEach(function(a){this.resetValue(a)}.bind(this))},_getSettingNames:function(){var a=[];n.getExtensions("setting").forEach(function(g){a.push(g.name)});return a},_list:function(){var a=[];this._getSettingNames().forEach(function(g){a.push({key:g,
value:this.get(g)})}.bind(this));return a},_persistValue:function(a,g){var f=this._persister;f&&f.persistValue(this,a,g)},_loadInitialValues:function(){var a=this._persister;a?a.loadInitialValues(this):this._loadDefaultValues()},_loadDefaultValues:function(){return this._loadFromObject(this._defaultValues())},_loadFromObject:function(a){var g=[],f=function(s){return function(q){this.set(s,q)}};for(var h in a)if(a.hasOwnProperty(h)){var l=a[h],i=n.getExtensionByKey("setting",h);if(i){l=b.fromString(l,
i.type);i=f(h);l.then(i);g.push(l)}}var j=new e;d(g).then(function(){j.resolve()});return j},_saveToObject:function(){var a=[],g={};this._getSettingNames().forEach(function(h){var l=this.get(h),i=n.getExtensionByKey("setting",h);if(i){l=b.toString(l,i.type);l.then(function(j){g[h]=j});a.push(l)}}.bind(this));var f=new e;d(a).then(function(){f.resolve(g)});return f},_defaultValues:function(){var a={};n.getExtensions("setting").forEach(function(g){a[g.name]=g.defaultValue});return a}};m.settings=new m.MemorySettings});
bespin.tiki.register("::appconfig",{name:"appconfig",dependencies:{jquery:"0.0.0",canon:"0.0.0",settings:"0.0.0"}});
bespin.tiki.module("appconfig:index",function(t,m){var n=t("jquery").$,k=t("settings").settings,e=t("bespin:plugins").catalog,d=t("bespin:promise").group,b=t("bespin:promise").Promise,a=t("bespin:console").console,g=t("bespin:util/stacktrace").Trace,f=t("bespin:util/util");m.launch=function(i){var j=new b;n("#_bespin_loading").remove();i=i||{};m.normalizeConfig(i);var s=i.objects;for(var q in s)e.registerObject(q,s[q]);for(var o in i.settings)k.set(o,i.settings[o]);var r=function(){var p=t("canon:environment").global,
u=p.editor;if(u){i.lineNumber&&u.setLineNumber(i.lineNumber);if(i.stealFocus)u.focus=true;if(i.readOnly)u.readOnly=i.readOnly;if(i.syntax)u.syntax=i.syntax}if(u=e.getObject("commandLine"))p.commandLine=u;e.publish(this,"appLaunched");j.resolve(p)}.bind(this),v=new b;v.then(function(){s.loginController?e.createObject("loginController").then(function(p){p.showLogin().then(function(u){i.objects.session.arguments.push(u);m.launchEditor(i).then(r,j.reject.bind(j))})}):m.launchEditor(i).then(r,j.reject.bind(j))},
function(p){j.reject(p)});e.plugins.theme_manager?bespin.tiki.require.ensurePackage("::theme_manager",function(){var p=t("theme_manager");i.theme.basePlugin&&p.setBasePlugin(i.theme.basePlugin);i.theme.standard&&p.setStandardTheme(i.theme.standard);p.startParsing().then(function(){v.resolve()},function(u){v.reject(u)})}):v.resolve();return j};m.normalizeConfig=function(i){if(i.objects===undefined)i.objects={};if(i.autoload===undefined)i.autoload=[];if(i.theme===undefined)i.theme={};if(!i.theme.basePlugin&&
e.plugins.screen_theme)i.theme.basePlugin="screen_theme";if(!i.initialContent)i.initialContent="";if(!i.settings)i.settings={};if(!i.objects.notifier&&e.plugins.notifier)i.objects.notifier={};if(!i.objects.loginController&&e.plugins.userident)i.objects.loginController={};if(!i.objects.fileHistory&&e.plugins.file_history)i.objects.fileHistory={factory:"file_history",arguments:["session"],objects:{"0":"session"}};if(!i.objects.server&&e.plugins.bespin_server){i.objects.server={factory:"bespin_server"};
i.objects.filesource={factory:"bespin_filesource",arguments:["server"],objects:{"0":"server"}}}if(!i.objects.files&&e.plugins.filesystem&&i.objects.filesource)i.objects.files={arguments:["filesource"],objects:{"0":"filesource"}};if(!i.objects.editor)i.objects.editor={factory:"text_editor",arguments:[i.initialContent]};if(!i.objects.session)i.objects.session={arguments:["editor"],objects:{"0":"editor"}};if(!i.objects.commandLine&&e.plugins.command_line)i.objects.commandLine={};if(i.gui===undefined)i.gui=
{};var j={};for(var s in i.gui){var q=i.gui[s];if(q.component)j[q.component]=true}if(!i.gui.center&&i.objects.editor&&!j.editor)i.gui.center={component:"editor"};if(!i.gui.south&&i.objects.commandLine&&!j.commandLine)i.gui.south={component:"commandLine"}};m.launchEditor=function(i){var j=new b;if(i===null){a.error("Cannot start editor without a configuration!");j.reject("Cannot start editor without a configuration!");return j}h(i).then(function(){l(i,j)},function(s){a.error("Error while creating objects");
(new g(s)).log();j.reject(s)});return j};var h=function(i){var j=[];for(var s in i.objects)j.push(e.createObject(s));return d(j)},l=function(i,j){var s=document.createElement("div");s.setAttribute("class","container");var q=document.createElement("div");q.setAttribute("class","center-container");s.appendChild(q);var o=i.element||document.body;f.addClass(o,"bespin");o.appendChild(s);for(var r in i.gui){var v=i.gui[r],p=e.getObject(v.component);if(!p){i="Cannot find object "+v.component+" to attach to the Bespin UI";
a.error(i);j.reject(i);return}o=p.element;if(!o){i="Component "+v.component+' does not have an "element" attribute to attach to the Bespin UI';a.error(i);j.reject(i);return}n(o).addClass(r);r=="west"||r=="east"||r=="center"?q.appendChild(o):s.appendChild(o);p.elementAppended&&p.elementAppended()}j.resolve()}});bespin.tiki.register("::events",{name:"events",dependencies:{traits:"0.0.0"}});
bespin.tiki.module("events:index",function(t,m){m.Event=function(){var n=[],k=function(){var e=arguments;n.forEach(function(d){d.func.apply(null,e)})};k.add=function(){arguments.length==1?n.push({ref:arguments[0],func:arguments[0]}):n.push({ref:arguments[0],func:arguments[1]})};k.remove=function(e){n=n.filter(function(d){return e!==d.ref})};k.removeAll=function(){n=[]};return k}});bespin.tiki.register("::uicommands",{name:"uicommands",dependencies:{}});
bespin.tiki.module("uicommands:index",function(t,m){t("bespin:plugins");m.jumpCommandLine=function(n){n.commandLine.focus()};m.jumpEditor=function(n){n.view.focus()}});bespin.tiki.register("::screen_theme",{name:"screen_theme",dependencies:{}});bespin.tiki.module("screen_theme:index",function(){});
(function(){var t=bespin.tiki.require("jquery").$;t(document).ready(function(){bespin.tiki.require("bespin:plugins").catalog.loadMetadata({text_editor:{resourceURL:"resources/text_editor/",description:"Canvas-based text editor component and many common editing commands",dependencies:{undomanager:"0.0",settings:"0.0",canon:"0.0",rangeutils:"0.0",traits:"0.0",theme_manager:"0.0.0",keyboard:"0.0",edit_session:"0.0",syntax_manager:"0.0"},testmodules:["tests\\controllers\\testLayoutmanager","tests\\models\\testTextstorage",
"tests\\testScratchcanvas","tests\\utils\\testRect"],provides:[{action:"new",pointer:"views/editor#EditorView",ep:"factory",name:"text_editor"},{pointer:"views/editor#EditorView",ep:"appcomponent",name:"editor_view"},{predicates:{isTextView:true},pointer:"commands/editing#backspace",ep:"command",key:"backspace",name:"backspace"},{predicates:{isTextView:true},pointer:"commands/editing#deleteCommand",ep:"command",key:"delete",name:"delete"},{description:"Delete all lines currently selected",key:"ctrl_d",
predicates:{isTextView:true},pointer:"commands/editing#deleteLines",ep:"command",name:"deletelines"},{description:"Create a new, empty line below the current one",key:"ctrl_return",predicates:{isTextView:true},pointer:"commands/editing#openLine",ep:"command",name:"openline"},{description:"Join the current line with the following",key:"ctrl_shift_j",predicates:{isTextView:true},pointer:"commands/editing#joinLines",ep:"command",name:"openline"},{params:[{defaultValue:"",type:"text",name:"text",description:"The text to insert"}],
pointer:"commands/editing#insertText",ep:"command",name:"insertText"},{predicates:{isTextView:true},pointer:"commands/editing#newline",ep:"command",key:"return",name:"newline"},{predicates:{isTextView:true},pointer:"commands/editing#tab",ep:"command",key:"tab",name:"tab"},{predicates:{isTextView:true},pointer:"commands/editing#untab",ep:"command",key:"shift_tab",name:"untab"},{predicates:{isTextView:true},ep:"command",name:"move"},{description:"Search for text within this buffer",params:[{type:"text",
name:"value",description:"string to search for"}],key:"ctrl_f",pointer:"commands/editor#findCommand",ep:"command",name:"find"},{description:"Repeat the last search (forward)",pointer:"commands/editor#findNextCommand",ep:"command",key:"ctrl_g",name:"findnext"},{description:"Repeat the last search (backward)",pointer:"commands/editor#findPrevCommand",ep:"command",key:"ctrl_shift_g",name:"findprev"},{predicates:{isTextView:true},pointer:"commands/movement#moveDown",ep:"command",key:"down",name:"move down"},
{predicates:{isTextView:true},pointer:"commands/movement#moveLeft",ep:"command",key:"left",name:"move left"},{predicates:{isTextView:true},pointer:"commands/movement#moveRight",ep:"command",key:"right",name:"move right"},{predicates:{isTextView:true},pointer:"commands/movement#moveUp",ep:"command",key:"up",name:"move up"},{predicates:{isTextView:true},ep:"command",name:"select"},{predicates:{isTextView:true},pointer:"commands/movement#selectDown",ep:"command",key:"shift_down",name:"select down"},
{predicates:{isTextView:true},pointer:"commands/movement#selectLeft",ep:"command",key:"shift_left",name:"select left"},{predicates:{isTextView:true},pointer:"commands/movement#selectRight",ep:"command",key:"shift_right",name:"select right"},{predicates:{isTextView:true},pointer:"commands/movement#selectUp",ep:"command",key:"shift_up",name:"select up"},{predicates:{isTextView:true},pointer:"commands/movement#moveLineEnd",ep:"command",key:["end","ctrl_right"],name:"move lineend"},{predicates:{isTextView:true},
pointer:"commands/movement#selectLineEnd",ep:"command",key:["shift_end","ctrl_shift_right"],name:"select lineend"},{predicates:{isTextView:true},pointer:"commands/movement#moveDocEnd",ep:"command",key:"ctrl_down",name:"move docend"},{predicates:{isTextView:true},pointer:"commands/movement#selectDocEnd",ep:"command",key:"ctrl_shift_down",name:"select docend"},{predicates:{isTextView:true},pointer:"commands/movement#moveLineStart",ep:"command",key:["home","ctrl_left"],name:"move linestart"},{predicates:{isTextView:true},
pointer:"commands/movement#selectLineStart",ep:"command",key:["shift_home","ctrl_shift_left"],name:"select linestart"},{predicates:{isTextView:true},pointer:"commands/movement#moveDocStart",ep:"command",key:"ctrl_up",name:"move docstart"},{predicates:{isTextView:true},pointer:"commands/movement#selectDocStart",ep:"command",key:"ctrl_shift_up",name:"select docstart"},{predicates:{isTextView:true},pointer:"commands/movement#moveNextWord",ep:"command",key:["alt_right"],name:"move nextword"},{predicates:{isTextView:true},
pointer:"commands/movement#selectNextWord",ep:"command",key:["alt_shift_right"],name:"select nextword"},{predicates:{isTextView:true},pointer:"commands/movement#movePreviousWord",ep:"command",key:["alt_left"],name:"move prevword"},{predicates:{isTextView:true},pointer:"commands/movement#selectPreviousWord",ep:"command",key:["alt_shift_left"],name:"select prevword"},{predicates:{isTextView:true},pointer:"commands/movement#selectAll",ep:"command",key:["ctrl_a","meta_a"],name:"select all"},{predicates:{isTextView:true},
ep:"command",name:"scroll"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollDocStart",ep:"command",key:"ctrl_home",name:"scroll start"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollDocEnd",ep:"command",key:"ctrl_end",name:"scroll end"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollPageDown",ep:"command",key:"pagedown",name:"scroll down"},{predicates:{isTextView:true},pointer:"commands/scrolling#scrollPageUp",ep:"command",key:"pageup",name:"scroll up"},
{pointer:"commands/editor#lcCommand",description:"Change all selected text to lowercase",withKey:"CMD SHIFT L",ep:"command",name:"lc"},{pointer:"commands/editor#detabCommand",description:"Convert tabs to spaces.",params:[{defaultValue:null,type:"text",name:"tabsize",description:"Optionally, specify a tab size. (Defaults to setting.)"}],ep:"command",name:"detab"},{pointer:"commands/editor#entabCommand",description:"Convert spaces to tabs.",params:[{defaultValue:null,type:"text",name:"tabsize",description:"Optionally, specify a tab size. (Defaults to setting.)"}],
ep:"command",name:"entab"},{description:"move it! make the editor head to a line number.",params:[{type:"text",name:"line",description:"add the line number to move to in the file"}],key:"ctrl_l",pointer:"commands/editor#gotoCommand",ep:"command",name:"goto"},{pointer:"commands/editor#trimCommand",description:"trim trailing or leading whitespace from each line in selection",params:[{defaultValue:"both",type:{data:[{name:"left"},{name:"right"},{name:"both"}],name:"selection"},name:"side",description:"Do we trim from the left, right or both"}],
ep:"command",name:"trim"},{pointer:"commands/editor#ucCommand",description:"Change all selected text to uppercase",withKey:"CMD SHIFT U",ep:"command",name:"uc"},{predicates:{isTextView:true},pointer:"controllers/undo#undoManagerCommand",ep:"command",key:["ctrl_shift_z"],name:"redo"},{predicates:{isTextView:true},pointer:"controllers/undo#undoManagerCommand",ep:"command",key:["ctrl_z"],name:"undo"},{description:"The distance in characters between each tab",defaultValue:8,type:"number",ep:"setting",
name:"tabstop"},{description:"Customize the keymapping",defaultValue:"{}",type:"text",ep:"setting",name:"customKeymapping"},{description:"The keymapping to use",defaultValue:"standard",type:"text",ep:"setting",name:"keymapping"},{description:"The editor font size in pixels",defaultValue:14,type:"number",ep:"setting",name:"fontsize"},{description:"The editor font face",defaultValue:"Monaco, Lucida Console, monospace",type:"text",ep:"setting",name:"fontface"},{defaultValue:{color:"#e5c138",paddingLeft:5,
backgroundColor:"#4c4a41",paddingRight:10},ep:"themevariable",name:"gutter"},{defaultValue:{color:"#e6e6e6",selectedTextBackgroundColor:"#526da5",backgroundColor:"#2a211c",cursorColor:"#879aff",unfocusedCursorBackgroundColor:"#73171e",unfocusedCursorColor:"#ff0033"},ep:"themevariable",name:"editor"},{defaultValue:{comment:"#666666",directive:"#999999",keyword:"#42A8ED",plain:"#e6e6e6",error:"#ff0000",operator:"#88BBFF",identifier:"#D841FF",string:"#039A0A"},ep:"themevariable",name:"highlighter"},
{defaultValue:{nibStrokeStyle:"rgb(150, 150, 150)",fullAlpha:1,barFillStyle:"rgb(0, 0, 0)",particalAlpha:0.3,barFillGradientBottomStop:"rgb(44, 44, 44)",backgroundStyle:"#2A211C",thickness:17,padding:5,trackStrokeStyle:"rgb(150, 150, 150)",nibArrowStyle:"rgb(255, 255, 255)",barFillGradientBottomStart:"rgb(22, 22, 22)",barFillGradientTopStop:"rgb(40, 40, 40)",barFillGradientTopStart:"rgb(90, 90, 90)",nibStyle:"rgb(100, 100, 100)",trackFillStyle:"rgba(50, 50, 50, 0.8)"},ep:"themevariable",name:"scroller"},
{description:"Event: Notify when something within the editor changed.",params:[{required:true,name:"pointer",description:"Function that is called whenever a change happened."}],ep:"extensionpoint",name:"editorChange"}],type:"plugins\\supported",name:"text_editor"},less:{resourceURL:"resources/less/",description:"Leaner CSS",contributors:[],author:"Alexis Sellier <self@cloudhead.net>",url:"http://lesscss.org",version:"1.0.11",dependencies:{},testmodules:[],provides:[],keywords:["css","parser","lesscss",
"browser"],type:"plugins\\thirdparty",name:"less"},canon:{resourceURL:"resources/canon/",name:"canon",environments:{main:true,worker:false},dependencies:{events:"0.0",settings:"0.0"},testmodules:[],provides:[{indexOn:"name",description:"A command is a bit of functionality with optional typed arguments which can do something small like moving the cursor around the screen, or large like cloning a project from VCS.",ep:"extensionpoint",name:"command"},{description:"An extension point to be called whenever a new command begins output.",
ep:"extensionpoint",name:"addedRequestOutput"},{description:"A dimensionsChanged is a way to be notified of changes to the dimension of Bespin",ep:"extensionpoint",name:"dimensionsChanged"},{description:"How many typed commands do we recall for reference?",defaultValue:50,type:"number",ep:"setting",name:"historyLength"},{action:"create",pointer:"history#InMemoryHistory",ep:"factory",name:"history"}],type:"plugins\\supported",description:"Manages commands"},traits:{resourceURL:"resources/traits/",
description:"Traits library, traitsjs.org",dependencies:{},testmodules:[],provides:[],type:"plugins\\thirdparty",name:"traits"},keyboard:{resourceURL:"resources/keyboard/",description:"Keyboard shortcuts",dependencies:{canon:"0.0",settings:"0.0"},testmodules:["tests\\testKeyboard"],provides:[{description:"A keymapping defines how keystrokes are interpreted.",params:[{required:true,name:"states",description:"Holds the states and all the informations about the keymapping. See docs: pluginguide/keymapping"}],
ep:"extensionpoint",name:"keymapping"},{pointer:"keyboard#keyboardManager._customKeymappingChanged",ep:"settingChanged",key:"customKeymapping"}],type:"plugins\\supported",name:"keyboard"},worker_manager:{resourceURL:"resources/worker_manager/",description:"Manages a web worker on the browser side",dependencies:{events:"0.0.0",underscore:"0.0.0"},testmodules:[],type:"plugins\\supported",name:"worker_manager"},diff:{testmodules:[],type:"plugins\\thirdparty",resourceURL:"resources/diff/",description:"Diff/Match/Patch module (support code, no UI)",
name:"diff"},edit_session:{resourceURL:"resources/edit_session/",description:"Ties together the files being edited with the views on screen",dependencies:{events:"0.0.0"},testmodules:["tests\\testSession"],provides:[{action:"call",pointer:"#createSession",ep:"factory",name:"session"}],type:"plugins\\supported",name:"edit_session"},syntax_manager:{resourceURL:"resources/syntax_manager/",name:"syntax_manager",environments:{main:true,worker:false},dependencies:{worker_manager:"0.0.0",events:"0.0.0",
underscore:"0.0.0",syntax_directory:"0.0.0"},testmodules:[],provides:[{indexOn:"name",ep:"extensionpoint",name:"fileextension"}],type:"plugins\\supported",description:"Provides syntax highlighting services for the editor"},undomanager:{resourceURL:"resources/undomanager/",description:"Manages undoable events",testmodules:["tests\\testUndomanager"],provides:[{pointer:"#undoManagerCommand",ep:"command",key:["ctrl_shift_z"],name:"redo"},{pointer:"#undoManagerCommand",ep:"command",key:["ctrl_z"],name:"undo"}],
type:"plugins\\supported",name:"undomanager"},command_line:{resourceURL:"resources/command_line/",description:"Provides the command line user interface",dependencies:{templater:"0.0.0",settings:"0.0.0",matcher:"0.0.0",canon:"0.0.0",keyboard:"0.0.0",diff:"0.0.0",types:"0.0.0"},testmodules:["tests\\testInput"],provides:[{url:["article.less","cli.less","menu.less","requestOutput.less","global.less"],ep:"themestyles"},{defaultValue:"@global_container_background",ep:"themevariable",name:"bg"},{defaultValue:"@global_container_background + #090807",
ep:"themevariable",name:"input_bg_light"},{defaultValue:"@global_container_background - #030303",ep:"themevariable",name:"input_bg"},{defaultValue:"@global_container_background - #050506",ep:"themevariable",name:"input_bg2"},{defaultValue:"@global_menu_inset_color_top_left",ep:"themevariable",name:"border_fg"},{defaultValue:"@global_menu_inset_color_right",ep:"themevariable",name:"border_fg2"},{defaultValue:"@global_menu_background",ep:"themevariable",name:"menu_bg"},{defaultValue:"@global_menu_border_color",
ep:"themevariable",name:"border_bg"},{defaultValue:"@global_color",ep:"themevariable",name:"text"},{defaultValue:"@global_header_color",ep:"themevariable",name:"hi_text"},{defaultValue:"@global_hint_color",ep:"themevariable",name:"lo_text"},{defaultValue:"@global_hint_color",ep:"themevariable",name:"lo_text2"},{defaultValue:"@global_link_color",ep:"themevariable",name:"link_text"},{defaultValue:"@global_error_color",ep:"themevariable",name:"error_text"},{defaultValue:"@global_selectable_hover_background",
ep:"themevariable",name:"theme_text"},{comment:"#FFCE00",defaultValue:"rgb(255,206,0)",ep:"themevariable",name:"theme_text_light"},{defaultValue:"@global_selectable_hover_background - #222000",ep:"themevariable",name:"theme_text_dark"},{defaultValue:"@global_accelerator_color",ep:"themevariable",name:"theme_text_dark2"},{comment:"#0E0906",defaultValue:"rgb(14,9,6)",ep:"themevariable",name:"input_submenu"},{defaultValue:"@global_font",ep:"themevariable",name:"fonts"},{defaultValue:"@global_selectable_hover_color",
ep:"themevariable",name:"li_hover_color"},{defaultValue:"@global_hint_hover_color",ep:"themevariable",name:"li_hint_hover_color"},{defaultValue:"@global_accelerator_hover_color",ep:"themevariable",name:"li_accelerator_hover_color"},{action:"new",pointer:"views/cli#CliInputView",ep:"factory",name:"commandLine"},{pointer:"views/cli#CliInputView",ep:"appcomponent",name:"command_line"},{description:"Display number|date|none next to each historical instruction",defaultValue:"none",type:{data:["number",
"date","none"],name:"selection"},ep:"setting",name:"historyTimeMode"},{description:"The maximum size (in pixels) for the command line output area",defaultValue:0,type:"number",ep:"setting",name:"minConsoleHeight"},{description:"The minimum size (in pixels) for the command line output area",defaultValue:300,type:"number",ep:"setting",name:"maxConsoleHeight"},{predicates:{isKeyUp:false,isCommandLine:true},pointer:"commands/simple#completeCommand",ep:"command",key:"tab",name:"complete"},{predicates:{isKeyUp:true,
isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_1",name:"menu1"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_2",name:"menu2"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_1",name:"menu1"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_3",name:"menu3"},{predicates:{isKeyUp:true,isCommandLine:true},
pointer:"views/menu#activateItemAction",ep:"command",key:"alt_4",name:"menu4"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_5",name:"menu5"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_6",name:"menu6"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_7",name:"menu7"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",
ep:"command",key:"alt_8",name:"menu8"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_9",name:"menu9"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"views/menu#activateItemAction",ep:"command",key:"alt_0",name:"menu0"},{pointer:"commands/simple#helpCommand",description:"Get help on the available commands.",params:[{defaultValue:null,type:"text",name:"search",description:"Search string to narrow the output."}],ep:"command",name:"help"},
{pointer:"commands/simple#aliasCommand",description:"define and show aliases for commands",params:[{defaultValue:null,type:"text",name:"alias",description:"optionally, your alias name"},{defaultValue:null,type:"text",name:"command",description:"optionally, the command name"}],ep:"command",name:"alias"},{description:"evals given js code and show the result",params:[{type:"text",name:"javascript",description:"The JavaScript to evaluate"}],hidden:true,pointer:"commands/basic#evalCommand",ep:"command",
name:"eval"},{description:"show the Bespin version",hidden:true,pointer:"commands/basic#versionCommand",ep:"command",name:"version"},{description:"has",hidden:true,pointer:"commands/basic#bespinCommand",ep:"command",name:"bespin"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"commands/history#historyPreviousCommand",ep:"command",key:"up",name:"historyPrevious"},{predicates:{isKeyUp:true,isCommandLine:true},pointer:"commands/history#historyNextCommand",ep:"command",key:"down",name:"historyNext"},
{params:[],description:"Show history of the commands",pointer:"commands/history#historyCommand",ep:"command",name:"history"},{pointer:"commands/history#addedRequestOutput",ep:"addedRequestOutput"},{indexOn:"name",description:"A function to allow the command line to show a hint to the user on how they should finish what they're typing",ep:"extensionpoint",name:"typehint"},{description:"A UI for string that is constrained to be one of a number of pre-defined values",pointer:"views/basic#selection",
ep:"typehint",name:"selection"},{description:"A UI for a boolean",pointer:"views/basic#bool",ep:"typehint",name:"boolean"}],type:"plugins\\supported",name:"command_line"},rangeutils:{testmodules:["tests\\test"],type:"plugins\\supported",resourceURL:"resources/rangeutils/",description:"Utility functions for dealing with ranges of text",name:"rangeutils"},events:{resourceURL:"resources/events/",description:"Dead simple event implementation",dependencies:{traits:"0.0"},testmodules:["tests\\test"],provides:[],
type:"plugins\\supported",name:"events"},templater:{testmodules:[],resourceURL:"resources/templater/",name:"templater",type:"plugins\\supported"},matcher:{resourceURL:"resources/matcher/",description:"Provides various routines to match items in a list",dependencies:{},testmodules:["tests\\testIndex","tests\\testPrefix","tests\\testQuick"],type:"plugins\\supported",name:"matcher"},javascript:{resourceURL:"resources/javascript/",name:"javascript",environments:{worker:true},dependencies:{standard_syntax:"0.0.0"},
testmodules:[],provides:[{pointer:"#JSSyntax",ep:"syntax",fileexts:["js","json"],name:"js"}],type:"plugins\\supported",description:"JavaScript syntax highlighter"},theme_manager:{resourceURL:"resources/theme_manager/",name:"theme_manager",environments:{main:true,worker:false},dependencies:{jquery:"0.0.0",settings:"0.0.0",events:"0.0.0",less:"0.0.0"},testmodules:[],provides:[{description:"(Less)files holding the CSS style information for the UI.",unregister:"themestyles#unregisterThemeStyles",register:"themestyles#registerThemeStyles",
params:[{required:true,name:"url",description:"Name of the ThemeStylesFile - can also be an array of files."}],ep:"extensionpoint",name:"themestyles"},{description:"Event: Notify when the theme(styles) changed.",params:[{required:true,name:"pointer",description:"Function that is called whenever the theme is changed."}],ep:"extensionpoint",name:"themeChange"},{indexOn:"name",description:"A theme is a way change the look of the application.",unregister:"index#unregisterTheme",register:"index#registerTheme",
params:[{required:false,name:"url",description:"Name of a ThemeStylesFile that holds theme specific CSS rules - can also be an array of files."},{required:true,name:"pointer",description:"Function that returns the ThemeData"}],ep:"extensionpoint",name:"theme"},{defaultValue:"standard",description:"The theme plugin's name to use. If set to 'standard' no theme will be used",type:"text",ep:"setting",name:"theme"},{pointer:"#appLaunched",ep:"appLaunched"}],type:"plugins\\supported",description:"Handles colors in Bespin"},
standard_syntax:{resourceURL:"resources/standard_syntax/",description:"Easy-to-use basis for syntax engines",environments:{worker:true},dependencies:{syntax_worker:"0.0.0",syntax_directory:"0.0.0",underscore:"0.0.0"},testmodules:[],type:"plugins\\supported",name:"standard_syntax"},types:{resourceURL:"resources/types/",description:"Defines parameter types for commands",testmodules:["tests\\testBasic","tests\\testTypes"],provides:[{indexOn:"name",description:"Commands can accept various arguments that the user enters or that are automatically supplied by the environment. Those arguments have types that define how they are supplied or completed. The pointer points to an object with methods convert(str value) and getDefault(). Both functions have `this` set to the command's `takes` parameter. If getDefault is not defined, the default on the command's `takes` is used, if there is one. The object can have a noInput property that is set to true to reflect that this type is provided directly by the system. getDefault must be defined in that case.",
ep:"extensionpoint",name:"type"},{description:"Text that the user needs to enter.",pointer:"basic#text",ep:"type",name:"text"},{description:"A JavaScript number",pointer:"basic#number",ep:"type",name:"number"},{description:"A true/false value",pointer:"basic#bool",ep:"type",name:"boolean"},{description:"An object that converts via JavaScript",pointer:"basic#object",ep:"type",name:"object"},{description:"A string that is constrained to be one of a number of pre-defined values",pointer:"basic#selection",
ep:"type",name:"selection"},{description:"A type which we don't understand from the outset, but which we hope context can help us with",ep:"type",name:"deferred"}],type:"plugins\\supported",name:"types"},embedded:{testmodules:[],dependencies:{theme_manager:"0.0.0",text_editor:"0.0.0",appconfig:"0.0.0",edit_session:"0.0.0",screen_theme:"0.0.0"},resourceURL:"resources/embedded/",name:"embedded",type:"plugins\\supported"},settings:{resourceURL:"resources/settings/",description:"Infrastructure and commands for managing user preferences",
dependencies:{types:"0.0"},testmodules:[],provides:[{description:"Storage for the customizable Bespin settings",pointer:"index#settings",ep:"appcomponent",name:"settings"},{indexOn:"name",description:"A setting is something that the application offers as a way to customize how it works",register:"index#addSetting",ep:"extensionpoint",name:"setting"},{description:"A settingChange is a way to be notified of changes to a setting",ep:"extensionpoint",name:"settingChange"},{pointer:"commands#setCommand",
description:"define and show settings",params:[{defaultValue:null,type:{pointer:"settings:index#getSettings",name:"selection"},name:"setting",description:"The name of the setting to display or alter"},{defaultValue:null,type:{pointer:"settings:index#getTypeSpecFromAssignment",name:"deferred"},name:"value",description:"The new value for the chosen setting"}],ep:"command",name:"set"},{pointer:"commands#unsetCommand",description:"unset a setting entirely",params:[{type:{pointer:"settings:index#getSettings",
name:"selection"},name:"setting",description:"The name of the setting to return to defaults"}],ep:"command",name:"unset"}],type:"plugins\\supported",name:"settings"},uicommands:{resourceURL:"resources/uicommands/",description:"Commands for working with the Bespin user interface beyond the editor",testmodules:[],provides:[{predicates:{isTextView:true},pointer:"#jumpCommandLine",ep:"command",key:"ctrl_j",name:"jump-commandline"},{predicates:{isKeyUp:false,isCommandLine:true},pointer:"#jumpEditor",ep:"command",
key:"ctrl_j",name:"jump-editor"}],type:"plugins\\supported",name:"uicommands"},syntax_worker:{resourceURL:"resources/syntax_worker/",description:"Coordinates multiple syntax engines",environments:{worker:true},dependencies:{syntax_directory:"0.0.0",underscore:"0.0.0"},testmodules:[],type:"plugins\\supported",name:"syntax_worker"},appconfig:{resourceURL:"resources/appconfig/",description:"Instantiates components and displays the GUI based on configuration.",dependencies:{jquery:"0.0.0",canon:"0.0.0",
settings:"0.0.0"},testmodules:[],provides:[{description:"Event: Fired when the app is completely launched.",ep:"extensionpoint",name:"appLaunched"}],type:"plugins\\supported",name:"appconfig"},screen_theme:{resourceURL:"resources/screen_theme/",description:"Bespins standard theme basePlugin",dependencies:{},testmodules:[],provides:[{url:["theme.less"],ep:"themestyles"},{defaultValue:"@global_font",ep:"themevariable",name:"container_font"},{defaultValue:"@global_font_size",ep:"themevariable",name:"container_font_size"},
{defaultValue:"@global_container_background",ep:"themevariable",name:"container_bg"},{defaultValue:"@global_color",ep:"themevariable",name:"container_color"},{defaultValue:"@global_line_height",ep:"themevariable",name:"container_line_height"},{defaultValue:"@global_pane_background",ep:"themevariable",name:"pane_bg"},{defaultValue:"@global_pane_border_radius",ep:"themevariable",name:"pane_border_radius"},{defaultValue:"@global_form_font",ep:"themevariable",name:"form_font"},{defaultValue:"@global_form_font_size",
ep:"themevariable",name:"form_font_size"},{defaultValue:"@global_form_line_height",ep:"themevariable",name:"form_line_height"},{defaultValue:"@global_form_color",ep:"themevariable",name:"form_color"},{defaultValue:"@global_form_text_shadow",ep:"themevariable",name:"form_text_shadow"},{defaultValue:"@global_pane_link_color",ep:"themevariable",name:"pane_a_color"},{defaultValue:"@global_font",ep:"themevariable",name:"pane_font"},{defaultValue:"@global_font_size",ep:"themevariable",name:"pane_font_size"},
{defaultValue:"@global_pane_text_shadow",ep:"themevariable",name:"pane_text_shadow"},{defaultValue:"@global_pane_h1_font",ep:"themevariable",name:"pane_h1_font"},{defaultValue:"@global_pane_h1_font_size",ep:"themevariable",name:"pane_h1_font_size"},{defaultValue:"@global_pane_h1_color",ep:"themevariable",name:"pane_h1_color"},{defaultValue:"@global_font_size * 1.8",ep:"themevariable",name:"pane_line_height"},{defaultValue:"@global_pane_color",ep:"themevariable",name:"pane_color"},{defaultValue:"@global_text_shadow",
ep:"themevariable",name:"pane_text_shadow"},{defaultValue:"@global_font",ep:"themevariable",name:"button_font"},{defaultValue:"@global_font_size",ep:"themevariable",name:"button_font_size"},{defaultValue:"@global_button_color",ep:"themevariable",name:"button_color"},{defaultValue:"@global_button_background",ep:"themevariable",name:"button_bg"},{defaultValue:"@button_bg - #063A27",ep:"themevariable",name:"button_bg2"},{defaultValue:"@button_bg - #194A5E",ep:"themevariable",name:"button_border"},{defaultValue:"@global_control_background",
ep:"themevariable",name:"control_bg"},{defaultValue:"@global_control_color",ep:"themevariable",name:"control_color"},{defaultValue:"@global_control_border",ep:"themevariable",name:"control_border"},{defaultValue:"@global_control_border_radius",ep:"themevariable",name:"control_border_radius"},{defaultValue:"@global_control_active_background",ep:"themevariable",name:"control_active_bg"},{defaultValue:"@global_control_active_border",ep:"themevariable",name:"control_active_border"},{defaultValue:"@global_control_active_color",
ep:"themevariable",name:"control_active_color"},{defaultValue:"@global_control_active_inset_color",ep:"themevariable",name:"control_active_inset_color"}],type:"plugins\\supported",name:"screen_theme"}})})})();
(function(){var t=bespin.tiki.require("jquery").$,m=function(n,k,e){n=n.style[e]||document.defaultView.getComputedStyle(n,"").getPropertyValue(e);if(!n||n=="auto"||n=="intrinsic")n=k.style[e];return n};bespin.useBespin=function(n,k){var e=bespin.tiki.require("bespin:util/util"),d={},b=d.settings;k=k||{};for(var a in k)d[a]=k[a];k=d.settings;if(b!==undefined)for(a in b)if(k[a]===undefined)d.settings[a]=b[a];var g=null,f=new (bespin.tiki.require("bespin:promise").Promise);bespin.tiki.require.ensurePackage("::appconfig",
function(){var h=bespin.tiki.require("appconfig");if(e.isString(n))n=document.getElementById(n);if(e.none(d.initialContent))d.initialContent=n.value||n.innerHTML;n.innerHTML="";if(n.type=="textarea"){var l=n.parentNode,i=document.createElement("div"),j=function(){var q="position:relative;";["margin-top","margin-left","margin-right","margin-bottom"].forEach(function(v){q+=v+":"+m(n,i,v)+";"});var o=m(n,i,"width"),r=m(n,i,"height");q+="height:"+r+";width:"+o+";";q+="display:inline-block;";i.setAttribute("style",
q)};window.addEventListener("resize",j,false);j();for(n.nextSibling?l.insertBefore(i,n.nextSibling):l.appendChild(i);l!==document;){if(l.tagName.toUpperCase()==="FORM"){var s=l.onsubmit;l.onsubmit=function(q){n.value=g.editor.value;n.innerHTML=g.editor.value;s&&s.call(this,q)};break}l=l.parentNode}n.style.display="none";d.element=i;if(!e.none(n.getAttribute("readonly")))d.readOnly=true}else d.element=n;h.launch(d).then(function(q){g=q;f.resolve(q)})});return f};t(document).ready(function(){for(var n=
[],k=document.querySelectorAll(".bespin"),e=0;e<k.length;e++){var d=k[e],b=d.getAttribute("data-bespinoptions")||"{}";b=bespin.useBespin(d,JSON.parse(b));b.then(function(a){d.bespin=a},function(a){throw new Error("Launch failed: "+a);});n.push(b)}if(window.onBespinLoad){k=bespin.tiki.require("bespin:promise").group;k(n).then(function(){window.onBespinLoad()},function(){throw new Error("At least one Bespin failed to launch!");})}})})();
